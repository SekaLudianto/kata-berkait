<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kata Berkait LIVE</title>

    <!-- 1. Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Lucide Icons --><script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Socket.IO Client --><script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    
    <!-- 4. Confetti (untuk saat menang) --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- 5. Google Font (Poppins & Inter) --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Keren (Bangers) -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    
    <!-- 6. Custom Styles --><style>
        body {
            font-family: 'Inter', 'Poppins', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            overscroll-behavior: none;
            /* Tema biru seperti di gambar */
            background: linear-gradient(135deg, #0052D4, #4364F7, #6FB1FC);
        }
        
        /* Animasi "pop" untuk kata baru */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop 0.4s ease-out;
        }

        /* Animasi "shake" untuk input salah */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Custom shadow untuk slot kata */
        .word-slot-shadow {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* Gaya untuk slot aktif (menebak) */
        .slot-active {
            background-color: #FBBF24; /* bg-amber-400 */
            border-color: #F59E0B; /* border-amber-500 */
            color: #78350F; /* text-amber-900 */
        }
        .slot-active-box {
            background-color: #FEF3C7; /* bg-amber-100 */
            border-color: #FCD34D; /* border-amber-300 */
        }
        
        /* Gaya untuk slot terkunci */
        .slot-locked {
            background-color: #6B7280; /* bg-gray-500 */
            color: #D1D5DB; /* text-gray-300 */
            opacity: 0.8;
        }
        .slot-locked-box {
            background-color: #9CA3AF; /* bg-gray-400 */
            border-color: #6B7280; /* border-gray-500 */
        }

        /* == Gaya Toast == */
        @keyframes toast-in {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .toast {
            animation: toast-in 0.5s ease-out forwards;
        }
        
        .toast-out {
            animation: toast-out 0.5s ease-in forwards;
        }

        /* == Sembunyikan Scrollbar == */
        #word-list-container, #leaderboard-container {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE dan Edge */
        }
        #word-list-container::-webkit-scrollbar, #leaderboard-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        /* == Font Keren == */
        .font-bangers {
            font-family: 'Bangers', cursive;
            letter-spacing: 1.5px;
            color: #FFFFFF;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        }

        /* == Animasi Kedip == */
        @keyframes blink {
            50% { opacity: 0; }
        }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
            font-weight: bold;
        }

        /* == Animasi Bonus == */
        @keyframes bonus-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.5); border-color: #FFD700; }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 1), inset 0 0 20px rgba(255, 255, 0, 0.7); border-color: #FFFACD; }
        }
        .bonus-slot {
            animation: bonus-pulse 1.5s infinite ease-in-out;
            border-width: 3px;
        }

        /* == Animasi Top Likers/Gifters == */
        @keyframes slide-in-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in-right {
            animation: slide-in-right 0.5s ease-out forwards;
        }
        @keyframes pulse-heart {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .pulse-heart {
            animation: pulse-heart 0.8s ease-in-out;
        }

        /* Masking untuk Ticker Horizontal */
        .mask-image-linear-gradient-horizontal {
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }

        /* == Animasi Stiker ANJAY GG == */
        @keyframes sticker-pop-elastic {
            0% { transform: scale(0) rotate(-30deg); opacity: 0; }
            60% { transform: scale(1.4) rotate(10deg); opacity: 1; }
            80% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .sticker-animate {
            animation: sticker-pop-elastic 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        .sticker-text-stroke {
            /* Membuat outline tebal pada teks */
            -webkit-text-stroke: 3px black;
            text-shadow: 5px 5px 0px rgba(0,0,0,0.8);
        }
        
        /* Animasi Countdown Overlay */
        @keyframes count-pulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .count-animate {
            animation: count-pulse 1s ease-out infinite;
        }

        /* == Animasi Gift Overlay == */
        @keyframes gift-slide-in {
            from { transform: translateY(-100%) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes gift-slide-out {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-100%) scale(0.8); opacity: 0; }
        }
        .gift-in {
            animation: gift-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .gift-out {
            animation: gift-slide-out 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
        }

    </style>
</head>

<body class="text-slate-900">

    <!-- ============================================= --><!--     LAYAR HOME (KONEKSI)                      --><!-- ============================================= --><div id="home-screen" class="w-full min-h-screen p-6 flex items-center justify-center overflow-y-auto">
        <main class="max-w-md w-full mx-auto space-y-5 bg-white/90 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-xl border border-white/30 my-8">
            <header class="text-center">
                <h1 class="text-4xl font-bold text-blue-800 mb-2 font-bangers tracking-wider">Kata Berkait</h1>
                <p class="text-lg text-slate-700">Lengkapi rantai kata yang hilang!</p>
            </header>

            <!-- Koneksi TikTok --><section>
                <h2 class="text-lg font-semibold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="tiktok" class="w-5 h-5"></i> Hubungkan TikTok LIVE
                </h2>
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <input type="text" id="tiktok-username" placeholder="@username TikTok" class="flex-grow w-full bg-slate-100 text-slate-900 placeholder-slate-400 border-2 border-slate-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                    <button data-action="connect-tiktok" id="connect-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none">
                        Hubungkan
                    </button>
                </div>
                <div id="tiktok-status" class="text-sm text-slate-600 mt-2 h-5">Belum terhubung.</div>
            </section>

            <!-- Pemilih Level & Tombol Mulai --><section class="space-y-3">
                <!-- Dropdown Stage (Baru) -->
                <div>
                    <label for="stage-select" class="block text-sm font-medium text-slate-700 mb-1">Pilih Stage:</label>
                    <select id="stage-select" class="w-full bg-slate-100 border-2 border-slate-300 text-slate-900 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="1">Stage 1 (Level 1-10)</option>
                    </select>
                </div>

                <!-- Dropdown Level -->
                <div>
                    <label for="level-select" class="block text-sm font-medium text-slate-700 mb-1">Pilih Level:</label>
                    <select id="level-select" class="w-full bg-slate-100 border-2 border-slate-300 text-slate-900 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="0">Memuat level...</option>
                    </select>
                </div>

                <button data-action="start-game" id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl text-lg transition-all transform hover:scale-105 active:scale-95 focus:outline-none disabled:bg-slate-400 disabled:cursor-not-allowed disabled:hover:scale-100 shadow-lg shadow-green-600/30">
                    MULAI GAME!
                </button>
                
                <!-- Tombol Ganti Level / Akhiri Sesi -->
                <button data-action="end-session" id="end-session-button" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition-all hidden">
                    Ganti Level / Akhiri Sesi
                </button>
                
                <p id="game-status" class="text-center text-sm text-slate-600 mt-2 h-5"></p>
            </section>

            <!-- Pengaturan GitHub & Soal --><section class="border-t border-slate-300 pt-5">
                <button data-action="toggle-settings" class="flex items-center justify-between w-full text-left text-lg font-semibold text-slate-800 mb-3 focus:outline-none">
                    <span class="flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> Pengaturan Soal</span>
                    <i data-lucide="chevron-down" id="settings-chevron" class="w-5 h-5 transition-transform"></i>
                </button>
                
                <div id="settings-panel" class="hidden space-y-4">
                    <!-- Sembunyikan detail konfigurasi GitHub -->
                    <div class="bg-slate-100 p-4 rounded-lg border border-slate-200 space-y-3 hidden">
                        <h3 class="font-medium text-slate-700 mb-2 text-sm">Sumber GitHub (Opsional)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">Username</label>
                                <input type="text" id="gh-username" placeholder="cth: SekaLudianto" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">Repository</label>
                                <input type="text" id="gh-repo" placeholder="cth: kata-berkait" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">Folder Path (jika ada)</label>
                            <input type="text" id="gh-path" placeholder="kosongkan untuk root" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                        </div>
                        <button data-action="save-gh-config" class="w-full bg-slate-600 hover:bg-slate-700 text-white text-sm font-medium py-1.5 rounded transition-colors">
                            Simpan Konfigurasi
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <button data-action="update-levels" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-transform active:scale-95 shadow-md">
                            <i data-lucide="download-cloud" class="w-4 h-4"></i>
                            <span>Update (GitHub)</span>
                        </button>
                        <button data-action="import-csv" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 px-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-transform active:scale-95 shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                            <span>Import CSV</span>
                        </button>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    </div>
                    
                    <!-- Tombol Reset Leaderboard -->
                    <div class="flex flex-col gap-2">
                        <button data-action="reset-leaderboard" class="w-full bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors border border-red-200">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            <span>Reset Papan Peringkat</span>
                        </button>
                        <div class="flex gap-2">
                            <button data-action="reset-top-likers" class="flex-1 bg-pink-100 hover:bg-pink-200 text-pink-700 font-semibold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-pink-200">
                                <i data-lucide="heart-off" class="w-3 h-3"></i> Reset Likes
                            </button>
                            <button data-action="reset-top-gifters" class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-purple-200">
                                <i data-lucide="gift" class="w-3 h-3"></i> Reset Gifts
                            </button>
                        </div>
                    </div>

                    <div id="level-update-status" class="text-center text-sm text-slate-600 h-auto min-h-[1.25rem] break-words"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- ============================================= --><!--     LAYAR PUZZLE (GAME)                       --><!-- ============================================= --><div id="puzzle-screen" class="flex flex-col h-screen overflow-hidden hidden relative">
        
        <!-- Header --><header class="w-full max-w-2xl mx-auto p-4 flex justify-between items-center text-white relative z-20">
            <!-- Tombol Home Kiri -->
            <div class="flex items-center gap-2">
                <button data-action="go-home" class="p-2 rounded-full hover:bg-white/20 active:bg-white/30 transition-colors" aria-label="Kembali ke Home">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Judul Tengah -->
            <div class="text-center absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full pointer-events-none">
                <h2 class="font-bangers text-3xl tracking-wider drop-shadow-md hidden sm:block">Kata Berkait</h2>
                <h2 class="font-bangers text-2xl tracking-wider drop-shadow-md sm:hidden">KB LIVE</h2>
                <div class="flex items-center justify-center gap-2 flex-wrap">
                    <!-- Info Stage -->
                    <span id="stage-info" class="text-xs sm:text-sm bg-white/20 px-2 py-0.5 rounded-full font-medium backdrop-blur-sm">S1</span>
                    <h1 id="level-title" class="text-sm sm:text-xl font-semibold opacity-90">Lvl 1</h1>
                    <!-- Tombol Reconnect Kecil -->
                    <button id="header-reconnect-btn" data-action="manual-reconnect" class="hidden pointer-events-auto bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 animate-pulse transition-colors" title="Koneksi Terputus! Klik untuk hubungkan ulang.">
                        <i data-lucide="wifi-off" class="w-3 h-3"></i>
                        <span class="hidden sm:inline">Reconnect</span>
                    </button>
                </div>
            </div>

            <!-- Tombol Aksi Kanan -->
            <div class="flex items-center gap-1 sm:gap-2">
                <button data-action="skip-level" class="flex items-center space-x-1 px-2 sm:px-3 py-2 rounded-full bg-amber-500/80 hover:bg-amber-600 text-white backdrop-blur-sm transition-colors" title="Lewati level ini">
                    <i data-lucide="fast-forward" class="w-4 h-4"></i>
                    <span class="font-medium text-sm hidden sm:inline">Skip</span>
                </button>
                <button data-action="reset-game" class="flex items-center space-x-1 px-2 sm:px-3 py-2 rounded-full bg-red-500/80 hover:bg-red-600 text-white backdrop-blur-sm transition-colors" title="Reset progres level ini">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span class="font-medium text-sm hidden sm:inline">Reset</span>
                </button>
            </div>
        </header>

        <!-- Notifikasi Koneksi Terputus --><div id="disconnect-notification" class="w-full max-w-2xl mx-auto px-4 pb-2 hidden z-30 relative">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-3 p-3 bg-red-600 text-white rounded-xl shadow-lg border border-red-400/50 animate-pulse">
                <div class="flex items-center gap-3">
                    <i data-lucide="wifi-off" class="w-6 h-6 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-bold">Koneksi Terputus!</h3>
                        <p id="disconnect-reason" class="text-sm opacity-90">Menunggu koneksi kembali...</p>
                        <!-- PERUBAHAN DI SINI: Menghapus referensi !konek -->
                        <p class="text-sm font-medium text-white/90 mt-1">
                            Silakan klik tombol "Coba Lagi" untuk menyambung ulang.
                        </p>
                    </div>
                </div>
                <button data-action="manual-reconnect" class="w-full sm:w-auto bg-white text-red-600 hover:bg-red-50 font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                    Coba Lagi
                </button>
            </div>
        </div>

        <!-- Mode Simulasi --><div id="simulation-mode-container" class="w-full max-w-2xl mx-auto px-4 pt-0 pb-2 hidden z-20 relative">
            <div class="flex items-center gap-2 p-2 bg-black/30 backdrop-blur-md rounded-xl border border-white/10">
                <input type="text" id="sim-comment" placeholder="Ketik jawaban simulasi..." class="flex-grow bg-transparent text-white placeholder-white/50 text-sm px-3 py-2 outline-none">
                <!-- Tombol Simulasi -->
                <button data-action="sim-like" class="bg-pink-500 hover:bg-pink-600 text-white p-2 rounded-lg transition-colors" title="Simulasi Like">
                    <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                </button>
                <button data-action="sim-gift" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg transition-colors" title="Simulasi Gift">
                    <i data-lucide="gift" class="w-4 h-4 fill-current"></i>
                </button>
                <button data-action="sim-send" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors" title="Kirim Jawaban">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Konten Game --><main class="flex-1 w-full max-w-2xl mx-auto px-4 pb-4 overflow-hidden flex flex-col items-center relative z-0">
            
            <!-- STATISTIK (Top Likers & Gifters Ticker) -->
            <div id="stats-ticker-container" class="w-full max-w-md mb-4 space-y-2 relative z-10">
                <!-- Likers Ticker -->
                <div class="bg-pink-900/30 border border-pink-500/20 p-1.5 rounded-lg flex items-center gap-2 overflow-hidden backdrop-blur-sm shadow-sm">
                    <div class="shrink-0 flex items-center gap-1 bg-pink-500/20 px-2 py-1 rounded-md shadow-sm border border-pink-500/10">
                        <i data-lucide="heart" class="w-3.5 h-3.5 text-pink-400 fill-pink-400"></i>
                        <span class="text-[10px] font-bold text-pink-300 tracking-wide">LIKES</span>
                    </div>
                    <div id="top-likers-viewport" class="flex-grow overflow-hidden relative h-7 mask-image-linear-gradient-horizontal">
                        <div id="top-likers-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-2 will-change-transform">
                            <p class="text-white/50 text-[10px] italic">Belum ada like...</p>
                        </div>
                    </div>
                </div>
                <!-- Gifters Ticker -->
                <div class="bg-indigo-900/30 border border-indigo-500/20 p-1.5 rounded-lg flex items-center gap-2 overflow-hidden backdrop-blur-sm shadow-sm">
                    <div class="shrink-0 flex items-center gap-1 bg-indigo-500/20 px-2 py-1 rounded-md shadow-sm border border-indigo-500/10">
                        <i data-lucide="gift" class="w-3.5 h-3.5 text-indigo-400 fill-indigo-400"></i>
                        <span class="text-[10px] font-bold text-indigo-300 tracking-wide">GIFTS</span>
                    </div>
                    <div id="top-gifters-viewport" class="flex-grow overflow-hidden relative h-7 mask-image-linear-gradient-horizontal">
                         <div id="top-gifters-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-2 will-change-transform">
                             <p class="text-white/50 text-[10px] italic">Belum ada gift...</p>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Daftar Kata -->
            <div id="word-list-container" class="w-full max-w-md space-y-2.5 overflow-y-auto pr-2 py-2 mask-image-linear-gradient flex-1">
                <!-- Slot kata di-generate oleh JS --></div>
        </main>
    </div>
    
    <!-- ============================================= --><!--     MODAL MENANG                              --><!-- ============================================= --><div id="win-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity duration-300">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 md:p-8 text-center transform transition-all scale-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                <i data-lucide="trophy" class="w-10 h-10 text-green-600"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2 font-bangers tracking-wide">LEVEL SELESAI!</h2>
            <p class="text-slate-600 mb-6">Luar biasa! Semua kata terjawab.</p>
            
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 mb-6">
                <h3 class="text-lg font-bold text-slate-700 mb-3 flex items-center justify-center gap-2">
                    <i data-lucide="crown" class="w-5 h-5 text-amber-500"></i> Papan Peringkat
                </h3>
                <div id="leaderboard-container" class="max-h-48 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    <!-- Leaderboard items --></div>
            </div>

            <div id="next-level-prompt">
                <p class="text-slate-700 font-medium animate-pulse">
                    Host, ketik <code class="bg-slate-200 text-blue-600 px-2 py-1 rounded font-bold">!next</code> di chat untuk lanjut!
                </p>
            </div>
            <div id="all-complete-prompt" class="hidden">
                <p class="text-xl text-green-600 font-bold mb-4 flex items-center justify-center gap-2"><i data-lucide="party-popper" class="w-6 h-6"></i> Semua Level Selesai! <i data-lucide="party-popper" class="w-6 h-6"></i></p>
                <button data-action="go-home" class="w-full px-6 py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition-transform active:scale-95">
                    Kembali ke Menu Utama
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================= --><!--     OVERLAY STIKER ANJAY GG                   --><!-- ============================================= --><div id="sticker-overlay" class="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none hidden">
        <div id="sticker-content" class="font-bangers text-8xl sm:text-9xl text-yellow-400 sticker-text-stroke rotate-[-10deg] drop-shadow-2xl">
            ANJAY GG!
        </div>
    </div>
    
    <!-- ============================================= --><!--     OVERLAY COUNTDOWN SIAP-SIAP               --><!-- ============================================= --><div id="ready-overlay" class="fixed inset-0 z-[70] flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="font-bangers text-6xl text-white drop-shadow-lg mb-4 animate-bounce">SIAP-SIAP!</div>
        <div id="countdown-number" class="font-bangers text-8xl text-yellow-400 drop-shadow-2xl count-animate">3</div>
    </div>

    <!-- ============================================= --><!--     OVERLAY GIFT                              --><!-- ============================================= --><div id="gift-overlay" class="fixed top-24 left-1/2 -translate-x-1/2 z-[80] pointer-events-none hidden">
        <div id="gift-card" class="bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-2xl border-2 border-purple-400 flex flex-col items-center text-center min-w-[250px] transform transition-all">
            <div class="relative mb-2">
                <div class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full blur opacity-75 animate-pulse"></div>
                <img id="gift-user-pic" src="" class="relative w-20 h-20 rounded-full border-4 border-white shadow-md object-cover" onerror="this.src='https://placehold.co/80x80/A855F7/FFFFFF?text=G'">
            </div>
            <h3 id="gift-user-name" class="font-bold text-xl text-slate-900 mb-1 font-bangers tracking-wide">NAMA PENGIRIM</h3>
            <p class="text-purple-600 font-semibold mb-3 flex items-center gap-1">
                <span class="text-sm">Mengirim</span> <span id="gift-name" class="font-bold">Hadiah</span>!
            </p>
            <div class="bg-purple-100 text-purple-800 px-4 py-2 rounded-xl font-bold text-lg animate-bounce-slow flex items-center justify-center gap-2">
                MAKASIH KAK! <i data-lucide="smile" class="w-5 h-5"></i>
            </div>
            <p class="text-slate-500 text-sm mt-3 animate-pulse">
                Yuk follow <span id="gift-user-follow" class="font-bold text-purple-600">@username</span>!
            </p>
        </div>
    </div>

    <!-- ============================================= --><!--     TOAST CONTAINER                           --><!-- ============================================= --><div id="toast-container" class="fixed top-20 left-4 w-auto max-w-[90vw] sm:max-w-xs z-50 space-y-2 pointer-events-none"></div>


    <!-- ============================================= -->
    <!--     MODAL KONFIRMASI (PENGGANTI ALERT)        -->
    <!-- ============================================= -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity duration-300">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-center transform pop-in">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
            </div>
            <h2 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2">Anda Yakin?</h2>
            <p id="confirm-message" class="text-slate-600 mb-6">Apakah Anda yakin ingin melakukan aksi ini?</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-no" class="flex-1 px-4 py-3 rounded-xl bg-slate-200 text-slate-700 font-bold hover:bg-slate-300 transition-transform active:scale-95">
                    Batal
                </button>
                <button id="confirm-yes" class="flex-1 px-4 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-transform active:scale-95">
                    Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>


    <!-- ============================================= -->
    <!--     AUDIO PLAYER (BACKGROUND MUSIC)         -->
    <!-- ============================================= -->
    <audio id="bg-music" src="https://raw.githubusercontent.com/SekaLudianto/kata-berkait/main/Title.mp3" loop preload="auto" hidden></audio>


    <!-- ============================================= --><!--     SCRIPT UTAMA                              --><!-- ============================================= --><script>
        const GH_CONFIG_KEY = 'kata-rantai-gh-config-v1';
        const LAST_USERNAME_KEY = 'kata-rantai-last-username-v1'; 
        const LEADERBOARD_KEY = 'kata-rantai-leaderboard-v1'; 
        const TOP_LIKERS_KEY = 'kata-rantai-top-likers-v1'; 
        const TOP_GIFTERS_KEY = 'kata-rantai-top-gifters-v1';

        let githubConfig = { OWNER: 'SekaLudianto', REPO: 'kata-berkait', PATH: 'csv', BRANCH: 'main' };

        class TikTokIOConnection {
            constructor(backendUrl) {
                this.socket = io(backendUrl);
                this.uniqueId = null; this.options = null; this._chatHandler = null; this._disconnectHandler = null; this._streamEndHandler = null; this._tiktokDisconnectedHandler = null; this._likeHandler = null; this._giftHandler = null;
                this.socket.on('connect', () => { console.info("Socket connected!"); if (this.uniqueId) this.setUniqueId(); });
                this._disconnectHandler = () => { console.warn("Socket disconnected!"); this.uniqueId = null; if (this.onDisconnectCallback) this.onDisconnectCallback(); };
                this.socket.on('disconnect', this._disconnectHandler);
                this._streamEndHandler = () => { console.warn("LIVE has ended!"); this.uniqueId = null; if (this.onStreamEndCallback) this.onStreamEndCallback(); };
                this.socket.on('streamEnd', this._streamEndHandler);
                this._tiktokDisconnectedHandler = (errMsg) => { console.warn(errMsg); if (errMsg && errMsg.includes('LIVE has ended')) this.uniqueId = null; if (this.onTikTokDisconnectedCallback) this.onTikTokDisconnectedCallback(errMsg); };
                this.socket.on('tiktokDisconnected', this._tiktokDisconnectedHandler);
            }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId.replace(/^@/, ''); this.options = options || {}; this.setUniqueId();
                return new Promise((resolve, reject) => { this.socket.once('tiktokConnected', resolve); this.socket.once('tiktokDisconnected', reject); setTimeout(() => { reject('Connection Timeout'); }, 15000); });
            }
            setUniqueId() { this.socket.emit('setUniqueId', this.uniqueId, this.options); }
            on(eventName, eventHandler) {
                this.off(eventName);
                if (eventName === 'chat') { this._chatHandler = eventHandler; this.socket.on('chat', this._chatHandler); }
                else if (eventName === 'like') { this._likeHandler = eventHandler; this.socket.on('like', this._likeHandler); } 
                else if (eventName === 'gift') { this._giftHandler = eventHandler; this.socket.on('gift', this._giftHandler); }
                else if (eventName === 'disconnect') this.onDisconnectCallback = eventHandler;
                else if (eventName === 'streamEnd') this.onStreamEndCallback = eventHandler;
                else if (eventName === 'tiktokDisconnected') this.onTikTokDisconnectedCallback = eventHandler;
                else this.socket.on(eventName, eventHandler);
            }
            off(eventName) {
                if (this.socket) {
                    if (eventName === 'chat' && this._chatHandler) { this.socket.off('chat', this._chatHandler); this._chatHandler = null; }
                    if (eventName === 'like' && this._likeHandler) { this.socket.off('like', this._likeHandler); this._likeHandler = null; } 
                    if (eventName === 'gift' && this._giftHandler) { this.socket.off('gift', this._giftHandler); this._giftHandler = null; }
                    if (eventName === 'disconnect') this.onDisconnectCallback = null;
                    if (eventName === 'streamEnd') this.onStreamEndCallback = null;
                    if (eventName === 'tiktokDisconnected') this.onTikTokDisconnectedCallback = null;
                }
            }
            removeAllCustomListeners() { this.off('chat'); this.off('like'); this.off('gift'); this.off('disconnect'); this.off('streamEnd'); this.off('tiktokDisconnected'); }
        }

        let levelData = []; 
        const CUSTOM_LEVEL_DATA_KEY = 'kata-rantai-custom-levels-v1';
        const STORAGE_KEY = 'kata-rantai-save-v1';
        const correctPhrases = ["Wih, Jagoan!", "Jenius!", "Mantap Betul!", "Gokil!", "Anjay GG!", "Luar Biasa!", "Kerja Bagus!", "Hebat!", "Cakep kek pantun!"];
        const incorrectPhrases = ["Typo ya?", "Coba Lagi!", "Betul tapi boong!", "Zonk!", "Waduh!", "Dikit Lagi!", "Hampir...!", "Bukan itu!", "Salah Woy!"];
        let gameState = { currentLevelIndex: 0, isGameActive: false, isLevelComplete: false, isAcceptingGuesses: false, revealedWords: [], nextSlotToGuess: -1, leaderboard: {}, topLikers: {}, topGifters: {}, currentHints: [] }; 
        let isProcessingWin = false;
        let tiktokConnection = null;
        let lastProcessedGiftId = null; // <-- TAMBAHKAN INI
        let lastConnectedUsername = null; 
        let likerScrollInterval = null; 
        let gifterScrollInterval = null;
        let backgroundMusic = null;

        const homeScreen = document.getElementById('home-screen');
        const puzzleScreen = document.getElementById('puzzle-screen');
        const startGameButton = document.getElementById('start-game-button');
        const endSessionButton = document.getElementById('end-session-button'); 
        const gameStatus = document.getElementById('game-status');
        const tiktokUsername = document.getElementById('tiktok-username');
        const connectButton = document.getElementById('connect-button');
        const tiktokStatus = document.getElementById('tiktok-status');
        const simContainer = document.getElementById('simulation-mode-container');
        const simCommentInput = document.getElementById('sim-comment');
        const levelUpdateStatus = document.getElementById('level-update-status');
        const levelTitle = document.getElementById('level-title');
        const stageInfo = document.getElementById('stage-info'); 
        const wordListContainer = document.getElementById('word-list-container');
        const winModal = document.getElementById('win-modal');
        const nextLevelPrompt = document.getElementById('next-level-prompt');
        const allCompletePrompt = document.getElementById('all-complete-prompt');
        const toastContainer = document.getElementById('toast-container');
        const disconnectNotification = document.getElementById('disconnect-notification');
        const disconnectReason = document.getElementById('disconnect-reason');
        const csvFileInput = document.getElementById('csv-file-input');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsChevron = document.getElementById('settings-chevron');
        const ghUsernameInput = document.getElementById('gh-username');
        const ghRepoInput = document.getElementById('gh-repo');
        const ghPathInput = document.getElementById('gh-path');
        const stageSelect = document.getElementById('stage-select'); 
        const levelSelect = document.getElementById('level-select');
        const headerReconnectBtn = document.getElementById('header-reconnect-btn');
        const topLikersList = document.getElementById('top-likers-list'); 
        const topGiftersList = document.getElementById('top-gifters-list');
        const stickerOverlay = document.getElementById('sticker-overlay');
        const stickerContent = document.getElementById('sticker-content');
        const readyOverlay = document.getElementById('ready-overlay');
        const countdownNumberEl = document.getElementById('countdown-number');
        const giftOverlay = document.getElementById('gift-overlay');
        const giftCard = document.getElementById('gift-card');
        const giftUserPic = document.getElementById('gift-user-pic');
        const giftUserName = document.getElementById('gift-user-name');
        const giftNameEl = document.getElementById('gift-name');
        const giftUserFollow = document.getElementById('gift-user-follow');

        // Variabel untuk modal konfirmasi
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        let onConfirmCallback = null; // Untuk menyimpan aksi saat "Ya" diklik

        let giftQueue = [];
        let isGiftOverlayShowing = false;

        function init() {
            setupGlobalListeners();
            backgroundMusic = document.getElementById('bg-music');
            // Atur volume agar tidak terlalu keras
            if (backgroundMusic) {
                backgroundMusic.volume = 0.3; // 30% volume
            }
            loadGitHubConfig();
            loadLastUsername(); 
            const savedCustomData = localStorage.getItem(CUSTOM_LEVEL_DATA_KEY);
            if (savedCustomData) {
                try { levelData = JSON.parse(savedCustomData); console.log("Data level termuat dari LocalStorage."); } 
                catch (e) { console.error("Gagal parse data lokal, mencoba fetch...", e); }
            } else { fetchAndUpdateLevels(); }
            loadState(); 
            updateHomeUI();
            lucide.createIcons();
            likerScrollInterval = startAutoScroll('top-likers-list', likerScrollInterval);
            gifterScrollInterval = startAutoScroll('top-gifters-list', gifterScrollInterval);
        }

        function playBackgroundMusic() {
            if (backgroundMusic && backgroundMusic.paused) {
                console.log("Mencoba memutar backsound...");
                const promise = backgroundMusic.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.warn("Autoplay backsound diblokir oleh browser:", error);
                        // Biarkan, user mungkin perlu klik lagi nanti
                    }).then(() => {
                        if (promise.status !== "fulfilled") {
                             console.log("Backsound diputar.");
                        }
                    });
                }
            }
        }

        function stopBackgroundMusic() {
            if (backgroundMusic && !backgroundMusic.paused) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0; // Reset audio ke awal
                console.log("Backsound dihentikan.");
            }
        }

        function showPage(pageName) {
            homeScreen.classList.toggle('hidden', pageName !== 'home');
            puzzleScreen.classList.toggle('hidden', pageName !== 'game');
        }

        function setupGlobalListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action } = target.dataset;
                switch (action) {
                    case 'start-game': startOrContinueGame(); break;
                    case 'end-session': 
                        // Ganti window.confirm
                        showConfirm('Akhiri sesi saat ini?', () => { 
                            gameState.isGameActive = false; 
                            saveState(); 
                            updateHomeUI(); 
                        });
                        break;
                    case 'go-home': goToHome(); break;
                    case 'reset-game': 
                        // Ganti window.confirm
                        showConfirm('Reset progres level ini?', () => {
                            loadLevel(gameState.currentLevelIndex, true);
                        });
                        break;
                    case 'skip-level': 
                        // Ganti window.confirm
                        showConfirm('Lewati level ini?', () => {
                            loadNextLevel();
                        });
                        break;
                    case 'connect-tiktok': connectToTikTok(); break;
                    case 'manual-reconnect': 
                        const userToConnect = tiktokUsername.value.trim() || lastConnectedUsername;
                        if (userToConnect) { if(disconnectReason) disconnectReason.textContent = `Menghubungkan ulang ke @${userToConnect}...`; connectToTikTok(userToConnect); } else { goToHome(); } 
                        break;
                    case 'sim-send': if (simCommentInput && simCommentInput.value.trim()) { handleComment({ comment: simCommentInput.value.trim(), uniqueId: 'simulator_user_id', nickname: 'Pemain Simulasi', profilePictureUrl: 'https://placehold.co/40x40/0284C7/FFFFFF?text=S' }); simCommentInput.value = ''; } break;
                    case 'sim-like': handleLike({ uniqueId: 'sim_liker_' + Math.floor(Math.random()*5), nickname: 'Liker ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/EC4899/FFFFFF?text=L', likeCount: Math.floor(Math.random() * 20) + 5 }); break;
                    case 'sim-gift': handleGift({ uniqueId: 'sim_gifter_' + Math.floor(Math.random()*5), nickname: 'Sultan ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/A855F7/FFFFFF?text=G', diamondCount: Math.floor(Math.random() * 50) + 1, giftName: 'Mawar' }); break;
                    case 'update-levels': fetchAndUpdateLevels(); break;
                    case 'import-csv': if (csvFileInput) csvFileInput.click(); break;
                    case 'toggle-settings': settingsPanel.classList.toggle('hidden'); settingsChevron.classList.toggle('rotate-180'); break;
                    case 'save-gh-config': 
                        saveGitHubConfig(); 
                        // Ganti alert() dengan toast
                        createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Konfigurasi tersimpan!</p></div>', 'system');
                        break;
                    case 'reset-leaderboard': 
                        // Ganti window.confirm dan alert
                        showConfirm('Reset Papan Peringkat? Semua skor akan hilang.', () => { 
                            resetLeaderboard(); 
                            createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Papan Peringkat Direset!</p></div>', 'system');
                        }, 'Reset Skor?');
                        break;
                    case 'reset-top-likers': 
                        // Ganti window.confirm dan alert
                        showConfirm('Reset Top Likers?', () => { 
                            resetTopLikers(); 
                            createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Top Likers Direset!</p></div>', 'system');
                        });
                        break;
                    case 'reset-top-gifters': 
                        // Ganti window.confirm dan alert
                        showConfirm('Reset Top Gifters?', () => { 
                            resetTopGifters(); 
                            createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Top Gifters Direset!</p></div>', 'system');
                        });
                        break;
                }
            });
            if (simCommentInput) simCommentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.querySelector('[data-action="sim-send"]').click(); } });
            if (csvFileInput) csvFileInput.addEventListener('change', handleCSVUpload);
            
            // PERBAIKAN: Listener stageSelect harus update gameState.currentLevelIndex
            if (stageSelect) stageSelect.addEventListener('change', () => { 
                populateLevelSelect(); 
                // Tambahkan baris ini untuk update index ke level pertama di stage baru
                if (levelSelect.value) {
                    gameState.currentLevelIndex = parseInt(levelSelect.value, 10);
                }
                updateHomeUI(); 
            }); 
            
            if (levelSelect) levelSelect.addEventListener('change', (e) => { 
                gameState.currentLevelIndex = parseInt(e.target.value, 10); 
                updateHomeUI(); 
            });
            
            // Listener untuk tombol modal konfirmasi
            if (confirmYes) {
                confirmYes.addEventListener('click', () => {
                    if (onConfirmCallback) {
                        onConfirmCallback(); // Jalankan aksi yang disimpan
                    }
                    onConfirmCallback = null; // Bersihkan callback
                    confirmModal.classList.add('hidden'); // Tutup modal
                });
            }
            if (confirmNo) {
                confirmNo.addEventListener('click', () => {
                    onConfirmCallback = null; // Bersihkan callback
                    confirmModal.classList.add('hidden'); // Tutup modal
                });
            }
        }

        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem(GH_CONFIG_KEY);
            if (savedConfig) { try { const parsed = JSON.parse(savedConfig); githubConfig = { ...githubConfig, ...parsed }; } catch (e) { console.error("Gagal load GH config", e); } }
            if (ghUsernameInput) ghUsernameInput.value = githubConfig.OWNER; if (ghRepoInput) ghRepoInput.value = githubConfig.REPO; if (ghPathInput) ghPathInput.value = githubConfig.PATH;
        }
        function saveGitHubConfig() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; githubConfig.PATH = ghPathInput.value.trim();
            localStorage.setItem(GH_CONFIG_KEY, JSON.stringify(githubConfig));
        }
        function loadLastUsername() { lastConnectedUsername = localStorage.getItem(LAST_USERNAME_KEY); if (lastConnectedUsername && tiktokUsername) tiktokUsername.value = lastConnectedUsername; }
        function saveLastUsername(username) { lastConnectedUsername = username; localStorage.setItem(LAST_USERNAME_KEY, username); }

        function handleCSVUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            levelUpdateStatus.textContent = "Membaca CSV..."; levelUpdateStatus.className = "text-center text-sm text-slate-600 h-auto min-h-[1.25rem]";
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsedLevels = parseCSV(e.target.result);
                    if (parsedLevels && parsedLevels.length > 0) {
                        levelData = parsedLevels;
                        levelData.forEach((lvl, idx) => { lvl.level = idx + 1; lvl.stage = Math.floor(idx / 10) + 1; });
                        localStorage.setItem(CUSTOM_LEVEL_DATA_KEY, JSON.stringify(levelData)); resetGameProgress(); 
                        levelUpdateStatus.textContent = `Sukses! ${parsedLevels.length} level.`; levelUpdateStatus.className = "text-center text-sm text-green-600 h-auto min-h-[1.25rem]";
                    } else { throw new Error("Data tidak valid."); }
                } catch (error) { levelUpdateStatus.textContent = `Gagal: ${error.message}`; levelUpdateStatus.className = "text-center text-sm text-red-600 h-auto min-h-[1.25rem]"; }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Fungsi baru untuk menampilkan modal konfirmasi
        function showConfirm(message, callback, title = 'Anda Yakin?') {
            if (!confirmModal || !confirmMessage || !confirmTitle) return;
            
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmCallback = callback; // Simpan fungsi callback
            
            confirmModal.classList.remove('hidden'); // Tampilkan modal
            lucide.createIcons(); // Render ikon (alert-triangle)
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== ''); const levels = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(','); if (cols.length < 10) continue; 
                const rawWords = cols.slice(0, 10).map(w => w.trim()).filter(w => w !== ''); if (rawWords.length === 0) continue;
                const words = []; const bonusWords = new Array(rawWords.length).fill(false);
                rawWords.forEach((rawWord, index) => {
                    if (rawWord.toUpperCase() === 'BACA CLUE') return; 
                    if (rawWord.includes('[*]')) { words.push(rawWord.replace(/\[\*\]/g, '').trim()); bonusWords[words.length - 1] = true; } else { words.push(rawWord); }
                });
                if (words.length === 0) continue;
                let clues = new Array(words.length).fill('');
                for (let j = 1; j < words.length; j++) {
                    const clueColIndex = 11 + j; 
                    if (cols[clueColIndex]) { let clue = cols[clueColIndex].trim(); if (clue && !clue.match(/\.(jpg|jpeg|png|gif)$/i)) clues[j] = clue; }
                }
                let difficulty = 'Medium'; for (let k = cols.length - 1; k >= 0; k--) { if (cols[k] && cols[k].trim() !== '') { difficulty = cols[k].trim(); break; } }
                levels.push({ difficulty, words, clues, openSlots: [0, words.length > 1 ? words.length - 1 : 0], bonusWords: bonusWords.slice(0, words.length) });
            }
            return levels;
        }

        function populateStageSelect() {
            if (!stageSelect || !levelData || levelData.length === 0) return;
            const maxStage = levelData[levelData.length - 1].stage || 1;
            stageSelect.innerHTML = '';
            for (let i = 1; i <= maxStage; i++) {
                const option = document.createElement('option'); option.value = i;
                option.textContent = `Stage ${i} (Level ${(i - 1) * 10 + 1}-${Math.min(i * 10, levelData.length)})`;
                stageSelect.appendChild(option);
            }
            stageSelect.value = levelData[gameState.currentLevelIndex]?.stage || 1; stageSelect.disabled = false;
        }

        function populateLevelSelect() {
            if (!levelSelect) return;
            levelSelect.innerHTML = '';
            if (!levelData || levelData.length === 0) { levelSelect.innerHTML = '<option value="0">Kosong</option>'; levelSelect.disabled = true; stageSelect.disabled = true; return; }
            const selectedStage = parseInt(stageSelect.value, 10) || 1;
            const filteredLevels = levelData.map((lvl, idx) => ({...lvl, originalIndex: idx})).filter(lvl => lvl.stage === selectedStage);
            filteredLevels.forEach((level) => {
                const option = document.createElement('option'); option.value = level.originalIndex; 
                option.textContent = `Level ${level.level} (${level.words.length} Kata) - ${level.difficulty || 'Normal'}`;
                levelSelect.appendChild(option);
            });
            levelSelect.disabled = false;
            levelSelect.value = filteredLevels.some(lvl => lvl.originalIndex === gameState.currentLevelIndex) ? gameState.currentLevelIndex : filteredLevels[0]?.originalIndex || 0;
        }

        function updateHomeUI() {
            if (!startGameButton || !gameStatus) return;
            if (!levelData || levelData.length === 0) { startGameButton.textContent = 'Data Soal Kosong'; startGameButton.disabled = true; gameStatus.textContent = 'Update dari GitHub/CSV.'; if(stageSelect) stageSelect.disabled = true; if(levelSelect) levelSelect.disabled = true; return; }
            
            // PERBAIKAN: Cek jika dropdown belum di-populate
            // Kita cek berdasarkan value '0' ("Memuat level...") di levelSelect
            if (levelSelect && levelSelect.options.length > 0 && levelSelect.options[0].value === '0') { 
                populateStageSelect(); 
                populateLevelSelect(); 
                // Setelah populate, pastikan gameState.currentLevelIndex sesuai
                if (levelSelect.value) {
                    gameState.currentLevelIndex = parseInt(levelSelect.value, 10);
                }
            }

            if (gameState.currentLevelIndex >= levelData.length || gameState.currentLevelIndex < 0) gameState.currentLevelIndex = 0;
            let currentLevel = levelData[gameState.currentLevelIndex];
            if (!currentLevel) { gameState.currentLevelIndex = 0; currentLevel = levelData[0]; }

            if (gameState.isGameActive && gameState.revealedWords.some(w => w !== null)) {
                startGameButton.textContent = `LANJUT LEVEL ${currentLevel.level}`; gameStatus.textContent = `Main: S${currentLevel.stage} - L${currentLevel.level}`;
                if(stageSelect) stageSelect.disabled = true; if(levelSelect) levelSelect.disabled = true; if(endSessionButton) endSessionButton.classList.remove('hidden');
            } else {
                if (stageSelect && currentLevel.stage && parseInt(stageSelect.value) !== currentLevel.stage) { stageSelect.value = currentLevel.stage; populateLevelSelect(); }
                if (levelSelect && parseInt(levelSelect.value) !== gameState.currentLevelIndex) levelSelect.value = gameState.currentLevelIndex;
                startGameButton.textContent = 'MULAI GAME!'; gameStatus.textContent = `Mulai: S${currentLevel.stage} - L${currentLevel.level}`;
                if(stageSelect) stageSelect.disabled = false; if(levelSelect) levelSelect.disabled = false; if(endSessionButton) endSessionButton.classList.add('hidden');
            }
            startGameButton.disabled = tiktokStatus.textContent.includes('Menghubungkan');
        }

        function startOrContinueGame() {
            if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); 
            if (tiktokStatus && tiktokStatus.textContent.includes('Harap hubungkan')) { tiktokStatus.textContent = 'Belum terhubung.'; tiktokStatus.classList.remove('text-red-600'); }
            
            // --- PERBAIKAN LOGIKA DIMULAI DI SINI ---

            // Tentukan apakah level ini harus di-reset (forceReset)
            let shouldReset = false;

            // Cek jika dropdown level sedang aktif (artinya kita di menu utama)
            if (levelSelect && !levelSelect.disabled) {
                const selectedLevelIndex = parseInt(levelSelect.value, 10);
                
                // Jika level yang dipilih di dropdown berbeda dengan yang disimpan,
                // ATAU jika game-nya memang tidak aktif (ini adalah klik "MULAI GAME!", bkn "LANJUT")
                // maka kita harus me-reset progres.
                if (selectedLevelIndex !== gameState.currentLevelIndex || !gameState.isGameActive) {
                    gameState.currentLevelIndex = selectedLevelIndex;
                    shouldReset = true; // Tandai untuk reset!
                }
            }
            // Jika dropdown nonaktif, berarti ini adalah klik "LANJUT",
            // jadi shouldReset akan tetap 'false' dan game akan lanjut.

            gameState.isGameActive = true; // Tetapkan game sebagai aktif
            isProcessingWin = false;
            
            // Kirim 'shouldReset' ke parameter 'forceReset' di loadLevel()
            loadLevel(gameState.currentLevelIndex, shouldReset);
            
            // --- PERBAIKAN LOGIKA SELESAI ---

            // Mulai musik saat game dimulai
            playBackgroundMusic(); 
        }

        function loadLevel(levelIndex, forceReset = false) {
            if (levelIndex >= levelData.length) levelIndex = 0;
            gameState.currentLevelIndex = levelIndex; const level = levelData[levelIndex];
            if (forceReset || gameState.revealedWords.length !== level.words.length || !gameState.isGameActive) {
                gameState.isLevelComplete = false; isProcessingWin = false; 
                lastProcessedGiftId = null; 
                gameState.currentHints = []; // <-- TAMBAHKAN INI (Reset petunjuk)
                gameState.isAcceptingGuesses = false; // JANGAN terima tebakan dulu
                gameState.revealedWords = new Array(level.words.length).fill(null);
                (level.openSlots || [0]).forEach(index => { if (index < level.words.length) gameState.revealedWords[index] = { word: level.words[index], solver: { nickname: 'SISTEM', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } }; });
                
                // --- PERBAIKAN BAGIAN 1 ---
                // Tentukan slot tebakan DI SINI, sebelum renderGameUI
                gameState.nextSlotToGuess = gameState.revealedWords.findIndex(word => word === null);
                
                // Tampilkan overlay Siap-siap dengan hitung mundur
                readyOverlay.classList.remove('hidden');
                let count = 3;
                countdownNumberEl.textContent = count;
                
                // Reset animasi agar bisa diputar ulang setiap detik
                countdownNumberEl.classList.remove('count-animate');
                void countdownNumberEl.offsetWidth; // Trigger reflow
                countdownNumberEl.classList.add('count-animate');

                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownNumberEl.textContent = count;
                        // Reset animasi untuk setiap angka baru
                        countdownNumberEl.classList.remove('count-animate');
                        void countdownNumberEl.offsetWidth; // Trigger reflow
                        countdownNumberEl.classList.add('count-animate');
                    } else {
                        clearInterval(countdownInterval);
                        readyOverlay.classList.add('hidden');
                        if (gameState.isGameActive) {
                            gameState.isAcceptingGuesses = true; // BARU terima tebakan
                            // Kita panggil updateNextSlotToGuess di sini untuk memastikan
                            // (misal jika level sudah selesai dari awal, atau untuk render ulang)
                            updateNextSlotToGuess(); 
                        }
                    }
                }, 1000);

            } else if (gameState.nextSlotToGuess === -1 && !gameState.isLevelComplete) { gameState.isLevelComplete = true; showWinModal(); }
            if (simContainer) simContainer.classList.toggle('hidden', tiktokConnection != null && tiktokConnection.uniqueId !== null);
            if (winModal && !gameState.isLevelComplete) winModal.classList.add('hidden');
            showPage('game'); 
            renderGameUI(); // Sekarang renderGameUI() akan punya nextSlotToGuess yang benar
            saveState();

            // Pastikan musik diputar saat level dimuat (jika sudah di-interact)
            playBackgroundMusic();
        }
        
        function updateNextSlotToGuess() {
            if (isProcessingWin || (gameState.isLevelComplete && winModal && !winModal.classList.contains('hidden'))) return;
            const nextIndex = gameState.revealedWords.findIndex(word => word === null); gameState.nextSlotToGuess = nextIndex;
            
            // Jika level selesai (semua kata tertebak)
            if (nextIndex === -1 && gameState.isGameActive && !gameState.isLevelComplete) {
                gameState.isLevelComplete = true; isProcessingWin = true; 
                gameState.isAcceptingGuesses = false; // Stop terima tebakan saat menang
                saveState();

                // SEQUENCE MENANG BARU:
                // 1. Jeda 2 detik agar pemain bisa lihat semua jawaban
                setTimeout(() => {
                    if (!gameState.isGameActive) return; // Cegah jika user keluar saat jeda
                    
                    // 2. Tampilkan Stiker ANJAY GG
                    stickerOverlay.classList.remove('hidden');
                    stickerContent.classList.add('sticker-animate');
                    // Confetti lagi saat stiker muncul biar heboh
                    confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 }, scalar: 1.2 });

                    // 3. Jeda 3 detik lagi untuk durasi stiker, baru tampilkan modal menang
                    setTimeout(() => {
                        stickerOverlay.classList.add('hidden');
                        stickerContent.classList.remove('sticker-animate');
                        showWinModal();
                        isProcessingWin = false; 
                    }, 3000);

                }, 2000);
            }
        }
        function loadNextLevel() { gameState.revealedWords = []; isProcessingWin = false; loadLevel(gameState.currentLevelIndex + 1); }
        function goToHome() { 
            if (disconnectNotification) disconnectNotification.classList.add('hidden'); 
            if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); 
            showPage('home'); 
            updateHomeUI(); 
            
            // Hentikan musik saat kembali ke menu
            stopBackgroundMusic();
        }

        function connectToTikTok(userToConnect = null) {
            const uniqueId = userToConnect || tiktokUsername.value.trim();
            if (!uniqueId) { tiktokStatus.textContent = 'Username kosong!'; tiktokStatus.classList.add('text-red-600'); return; }
            tiktokStatus.textContent = `Menghubungkan ke @${uniqueId}...`; if (disconnectReason) disconnectReason.textContent = tiktokStatus.textContent;
            tiktokStatus.classList.remove('text-red-600', 'text-green-600'); connectButton.disabled = true; startGameButton.disabled = true;
            
            // Pastikan instance lama (jika ada) dibersihkan SEBELUM membuat yang baru
            if (tiktokConnection) { 
                tiktokConnection.removeAllCustomListeners(); 
                tiktokConnection.socket.disconnect(); 
                tiktokConnection = null; 
            }
            
            tiktokConnection = new TikTokIOConnection("https://tiktok-server-production-e573.up.railway.app");
            
            tiktokConnection.connect(uniqueId, {}).then(() => {
                tiktokStatus.textContent = `Terhubung ke @${uniqueId}`; tiktokStatus.classList.add('text-green-600');
                startGameButton.disabled = false; saveLastUsername(uniqueId); 
                if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); if (simContainer) simContainer.classList.add('hidden');
                setupTikTokListeners();
            }).catch(err => { 
                tiktokStatus.textContent = `Gagal: ${err}`; tiktokStatus.classList.add('text-red-600'); 
                connectButton.disabled = false; startGameButton.disabled = false; 
                if(disconnectReason) disconnectReason.textContent = `Gagal: ${err}`; 
                
                // Jika gagal, pastikan koneksi null agar !konek bisa dicoba lagi
                if (tiktokConnection) {
                    tiktokConnection.removeAllCustomListeners();
                    tiktokConnection.socket.disconnect();
                    tiktokConnection = null;
                }
            });
        }

        function handleDisconnect(reason) {
            tiktokStatus.textContent = reason; tiktokStatus.classList.add('text-red-600'); connectButton.disabled = false; startGameButton.disabled = false;
            if (tiktokConnection) { 
                tiktokConnection.removeAllCustomListeners(); 
                // JANGAN disconnect socket.io, agar command !konek host masih bisa diterima
                // tiktokConnection.socket.disconnect(); 
                // tiktokConnection = null; 
                // Cukup set uniqueId ke null untuk menandakan koneksi TikTok-nya putus
                tiktokConnection.uniqueId = null; 
            }
            updateHomeUI();
            if (gameState.isGameActive) { if (disconnectReason) disconnectReason.textContent = reason; disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.remove('hidden'); lucide.createIcons(); simContainer.classList.add('hidden'); }
        }

        function setupTikTokListeners() {
            tiktokConnection.on('chat', handleComment); tiktokConnection.on('like', handleLike); tiktokConnection.on('gift', handleGift);
            tiktokConnection.on('disconnect', () => handleDisconnect('Koneksi terputus.')); tiktokConnection.on('streamEnd', () => handleDisconnect('LIVE berakhir.')); tiktokConnection.on('tiktokDisconnected', (e) => handleDisconnect(`TikTok terputus: ${e}`));
        }

        function handleLike(data) {
            if (!gameState.isGameActive) return;
            const { uniqueId, nickname, profilePictureUrl, likeCount } = data;
            if (!gameState.topLikers[uniqueId]) gameState.topLikers[uniqueId] = { totalLikes: 0, nickname, profilePictureUrl };
            gameState.topLikers[uniqueId].totalLikes += likeCount; gameState.topLikers[uniqueId].nickname = nickname; gameState.topLikers[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopLikers(); renderTopLikers();
        }

        function handleGift(data) {
            if (!gameState.isGameActive) return;
            
            // --- TAMBAHKAN LOGIKA DEBOUNCE ---
            // Cek ID unik dari event gift. 'giftId' atau 'msg_id' adalah properti yg umum.
            const currentGiftId = data.giftId || data.msg_id || data.id;

            // Jika gift ini punya ID dan ID-nya SAMA dengan yang baru saja diproses,
            // abaikan event duplikat ini.
            if (currentGiftId && currentGiftId === lastProcessedGiftId) {
                console.warn(`Mengabaikan event gift duplikat: ${currentGiftId}`);
                return; // Hentikan eksekusi
            }

            // Jika ini gift baru, simpan ID-nya
            if (currentGiftId) {
                lastProcessedGiftId = currentGiftId;
            }
            // --- LOGIKA DEBOUNCE SELESAI ---

            // Proses data gift
            const diamonds = data.diamondCount || (data.extendedGiftInfo ? data.extendedGiftInfo.diamond_count : 0) || 1;
            const giftName = data.giftName || 'Hadiah';
            const { uniqueId, nickname, profilePictureUrl } = data;
            
            // Update Top Gifters
             if (!gameState.topGifters[uniqueId]) gameState.topGifters[uniqueId] = { totalDiamonds: 0, nickname, profilePictureUrl };
            gameState.topGifters[uniqueId].totalDiamonds += diamonds; gameState.topGifters[uniqueId].nickname = nickname; gameState.topGifters[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopGifters(); renderTopGifters();

            // --- LOGIKA KOIN BARU ---
            // Pastikan user ada di leaderboard
            if (!gameState.leaderboard[uniqueId]) {
                gameState.leaderboard[uniqueId] = { score: 0, coins: 0, nickname: nickname, profilePic: profilePictureUrl };
            }
            // Tambahkan koin (1 diamond = 1 koin)
            gameState.leaderboard[uniqueId].coins = (gameState.leaderboard[uniqueId].coins || 0) + diamonds;
            gameState.leaderboard[uniqueId].nickname = nickname; // Update nama
            gameState.leaderboard[uniqueId].profilePic = profilePictureUrl; // Update foto
            saveLeaderboard(); // Simpan data koin

            // Tampilkan notifikasi perolehan koin (selain notifikasi gift)
            setTimeout(() => {
                createToast(
                    `<i data-lucide="coins" class="w-10 h-10 text-yellow-300 flex-shrink-0"></i>
                     <div class="flex-grow overflow-hidden">
                         <p class="font-bold text-white truncate text-shadow-sm">${nickname.replace(/</g,"&lt;")}</p>
                         <p class="text-sm text-yellow-100 font-medium">Mendapat +${diamonds} Koin!</p>
                     </div>`, 
                    'system' // Tipe 'system' (biru) agar beda dari gift
                );
                lucide.createIcons();
            }, 500); // Muncul 0.5 detik setelah notif gift
            // --- LOGIKA KOIN SELESAI ---

            // Tambahkan ke antrian overlay
            giftQueue.push({ nickname, profilePictureUrl, giftName, uniqueId });
            processGiftQueue();
        }

        function processGiftQueue() {
            if (isGiftOverlayShowing || giftQueue.length === 0) return;
            isGiftOverlayShowing = true;
            const giftData = giftQueue.shift();
            
            // Update konten overlay
            giftUserPic.src = giftData.profilePictureUrl;
            giftUserName.textContent = giftData.nickname;
            giftNameEl.textContent = giftData.giftName;
            giftUserFollow.textContent = `@${giftData.uniqueId}`;
            
            // Tampilkan overlay
            giftOverlay.classList.remove('hidden');
            giftCard.classList.remove('gift-out');
            giftCard.classList.add('gift-in');
            
            // Confetti khusus gift
            confetti({ particleCount: 150, spread: 100, origin: { y: 0.3 }, colors: ['#A855F7', '#EC4899', '#FBBF24'] });

            // Sembunyikan setelah beberapa detik
            setTimeout(() => {
                giftCard.classList.remove('gift-in');
                giftCard.classList.add('gift-out');
                setTimeout(() => {
                    giftOverlay.classList.add('hidden');
                    isGiftOverlayShowing = false;
                    processGiftQueue(); // Proses gift berikutnya di antrian
                }, 500); // Waktu tunggu animasi keluar selesai
            }, 4000); // Durasi overlay tampil
        }

        function renderTopLikers() {
            if (!topLikersList) return;
            const sorted = Object.values(gameState.topLikers).sort((a, b) => b.totalLikes - a.totalLikes).slice(0, 10);
            if (sorted.length === 0) { topLikersList.innerHTML = '<p class="text-white/50 text-[10px] italic">Belum ada like...</p>'; return; }
            let html = sorted.map((liker, i) => createRankItemHorizontalHTML(liker, i, 'like')).join('');
            // Duplicate for smoother infinite scroll if needed, but standard scroll is okay for now.
            // html += html; 
            topLikersList.innerHTML = html; lucide.createIcons();
        }

        function renderTopGifters() {
            if (!topGiftersList) return;
            const sorted = Object.values(gameState.topGifters).sort((a, b) => b.totalDiamonds - a.totalDiamonds).slice(0, 10);
            if (sorted.length === 0) { topGiftersList.innerHTML = '<p class="text-white/50 text-[10px] italic">Belum ada gift...</p>'; return; }
            let html = sorted.map((gifter, i) => createRankItemHorizontalHTML(gifter, i, 'gift')).join('');
            topGiftersList.innerHTML = html; lucide.createIcons();
        }

        function createRankItemHorizontalHTML(user, index, type) {
             const isTop = index === 0;
             const value = type === 'like' ? user.totalLikes.toLocaleString() : user.totalDiamonds.toLocaleString();
             const colorClass = type === 'like' ? 'pink' : 'indigo';
             const crownColor = type === 'like' ? 'text-yellow-400' : 'text-indigo-300';
             
             return `<div class="flex items-center gap-1.5 bg-white/10 px-2 py-0.5 rounded-full border border-white/10 shrink-0">
                ${isTop ? `<i data-lucide="crown" class="w-3.5 h-3.5 ${crownColor} fill-current"></i>` : `<span class="text-[10px] font-bold text-${colorClass}-300">#${index+1}</span>`}
                <img src="${user.profilePictureUrl}" class="w-5 h-5 rounded-full border border-white/30" onerror="this.src='https://placehold.co/40x40/FFFFFF/000000?text=?'">
                <span class="text-white text-[11px] font-medium truncate max-w-[80px]">${user.nickname}</span>
                <span class="text-${colorClass}-200 text-[10px] font-bold flex items-center gap-0.5">(${value})</span>
            </div>`;
        }

        function startAutoScroll(elementId, intervalVar) {
            if (intervalVar) clearInterval(intervalVar);
            const el = document.getElementById(elementId);
            if (!el) return null;
            let pos = 0; const speed = 0.5;
            return setInterval(() => {
                if (!el.parentElement) return;
                // Scroll horizontal if content is wider than viewport
                if (el.scrollWidth > el.parentElement.clientWidth) {
                     pos += speed;
                     // Reset loop when scrolled past end. 
                     if (pos >= el.scrollWidth) {
                         pos = -el.parentElement.clientWidth; // Start from right edge for ticker effect
                     }
                     el.style.transform = `translateX(${-pos}px)`;
                } else {
                     pos = 0;
                     el.style.transform = `translateX(0px)`;
                }
            }, 30);
        }
        
        function handleComment(msg) {
            // PERUBAHAN DI SINI
            if (disconnectNotification && !disconnectNotification.classList.contains('hidden')) {
                disconnectNotification.classList.add('hidden'); 
            }
            if (headerReconnectBtn && !headerReconnectBtn.classList.contains('hidden')) {
                headerReconnectBtn.classList.add('hidden');
            }
            
            console.log("Chat:", msg.comment);
            const comment = msg.comment.trim().toUpperCase().replace(/\s+/g, '');
            // Tentukan isHost. Cek juga 'simulator_user_id' untuk testing
            const isHost = (tiktokConnection && msg.uniqueId && tiktokConnection.uniqueId && msg.uniqueId.toLowerCase() === tiktokConnection.uniqueId.toLowerCase()) || 
                         (msg.uniqueId === 'simulator_user_id');
            
            // PERUBAHAN DI SINI: Menghapus logika !konek yang tidak berfungsi
            /* // Perintah !konek dari host untuk memicu koneksi ulang
            if (comment === '!KONEK' && isHost) {
                const userToConnect = tiktokUsername.value.trim() || lastConnectedUsername;
                if (userToConnect) {
                    console.log(`Perintah !konek diterima, mencoba konek ulang ke @${userToConnect}`);
                    createToast(`<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Mencoba konek ulang ke @${userToConnect}...</p></div>`, 'system');
                    connectToTikTok(userToConnect);
                }
                return; // Hentikan proses comment lebih lanjut
            }
            */

            if (!gameState.isGameActive) return;

            // Command host selalu bisa dijalankan
            if (gameState.isLevelComplete && comment === '!NEXT') { loadNextLevel(); return; }
            if (comment === '!RESET' && isHost) { loadLevel(gameState.currentLevelIndex, true); return; }
            
            // Pengecekan status permainan untuk menerima tebakan
            if (!gameState.isAcceptingGuesses || gameState.isLevelComplete || gameState.nextSlotToGuess === -1) {
                // Pengecualian untuk !HINT, biarkan lolos jika game aktif
                if (comment !== '!HINT' || !gameState.isGameActive) {
                    return;
                }
            }

            // --- PERINTAH !HINT BARU ---
            if (comment === '!HINT') {
                const uid = msg.uniqueId;
                const user = gameState.leaderboard[uid];

                // 1. Cek koin
                if (!user || (user.coins || 0) < 1) {
                    // PERBAIKAN DI SINI: ganti 'comment' menjadi 'customError'
                    showIncorrectToast({ ...msg, customError: 'Koin tidak cukup!' });
                    return;
                }

                // 2. Cek apakah ada kata yang sedang ditebak
                if (gameState.nextSlotToGuess === -1 || gameState.isLevelComplete) {
                    // PERBAIKAN DI SINI: ganti 'comment' menjadi 'customError'
                    showIncorrectToast({ ...msg, customError: 'Tidak ada kata untuk diberi petunjuk!' });
                    return;
                }

                const correctWord = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
                const lettersToFind = correctWord.slice(1).split(''); // Semua huruf kecuali yg pertama
                let newHintLetter = null;

                // 3. Cari huruf baru yang belum ada di 'currentHints'
                for (const letter of lettersToFind) {
                    if (!gameState.currentHints.includes(letter)) {
                        newHintLetter = letter;
                        break;
                    }
                }

                // 4. Proses hasilnya
                if (newHintLetter) {
                    // Potong koin
                    user.coins -= 1;
                    gameState.currentHints.push(newHintLetter); // Tambah ke petunjuk
                    saveLeaderboard(); // Simpan koin baru

                    // Beri notifikasi
                    createToast(
                        `<img src="${msg.profilePictureUrl||'https'}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm" onerror="this.src='https://placehold.co/40x40/FBBF24/78350F?text=?'">
                         <div class="flex-grow overflow-hidden">
                             <p class="font-bold text-white truncate">${(msg.nickname||'Anonim').replace(/</g,"&lt;")}</p>
                             <p class="text-sm text-amber-100 font-medium">Memakai 1 Koin! Huruf '${newHintLetter}' terbuka!</p>
                         </div>`, 
                        'correct' // Tipe 'correct' (hijau)
                    );
                    
                    // Render ulang slot aktif untuk menampilkan petunjuk baru
                    renderSingleSlot(gameState.nextSlotToGuess, null);

                } else {
                    // Semua huruf sudah terungkap
                    // PERBAIKAN DI SINI: ganti 'comment' menjadi 'customError'
                    showIncorrectToast({ ...msg, customError: 'Semua petunjuk sudah terbuka!' });
                    // Tidak perlu potong koin jika gagal
                }
                return; // Hentikan proses, ini adalah perintah
            }
            // --- PERINTAH !HINT SELESAI ---


            if (comment === '!SKIP' && isHost) {
                const idx = gameState.nextSlotToGuess; gameState.revealedWords[idx] = { word: levelData[gameState.currentLevelIndex].words[idx], solver: { nickname: 'Host Skip', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } };
                createToast(`<div class="flex-grow"><p class="font-bold text-white">Host</p><p class="text-sm text-blue-100">Skip kata!</p></div>`, 'system');
                updateNextSlotToGuess(); saveState(); renderSingleSlot(idx, gameState.revealedWords[idx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
                return;
            }
            
            const correct = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
            if (comment === correct) {
                const isBonus = levelData[gameState.currentLevelIndex].bonusWords[gameState.nextSlotToGuess];
                const points = isBonus ? 20 : 10; showCorrectToast(msg, points, isBonus);
                if (msg.uniqueId) addScore(msg.uniqueId, msg.nickname || 'Anonim', msg.profilePictureUrl || '', points);
                gameState.revealedWords[gameState.nextSlotToGuess] = { word: correct, solver: { nickname: msg.nickname || msg.uniqueId, profilePic: msg.profilePictureUrl } };
                
                gameState.currentHints = []; // <-- RESET PETUNJUK untuk kata berikutnya

                const solvedIdx = gameState.nextSlotToGuess; updateNextSlotToGuess(); saveState();
                renderSingleSlot(solvedIdx, gameState.revealedWords[solvedIdx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
            } else {
                if (!gameState.revealedWords.filter(d=>d).map(d=>d.word).includes(comment)) showIncorrectToast(msg);
            }
        }

        function showWinModal() { if(winModal) { renderLeaderboard(); winModal.classList.remove('hidden'); nextLevelPrompt.classList.toggle('hidden', gameState.currentLevelIndex >= levelData.length - 1); allCompletePrompt.classList.toggle('hidden', gameState.currentLevelIndex < levelData.length - 1); lucide.createIcons(); } }
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container'); if (!container) return;
            const sorted = Object.values(gameState.leaderboard).sort((a,b)=>b.score-a.score).slice(0,10);
            container.innerHTML = sorted.length===0 ? '<p class="text-center text-slate-500 italic py-4">Belum ada data.</p>' : sorted.map((p,i)=>`
                <div class="flex items-center gap-3 p-2.5 bg-white rounded-lg shadow-sm border border-slate-100 ${i===0?'bg-yellow-50 border-yellow-200':''}">
                    ${i===0?'':`<div class="flex-shrink-0 w-8 text-center font-bold ${i<3?'text-xl':'text-base text-slate-500'}">#${i+1}</div>`}
                    ${i===0?`<div class="relative"><i data-lucide="crown" class="absolute -top-3 -left-2 w-6 h-6 text-yellow-400 fill-yellow-400 z-10 animate-bounce-slow" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));"></i><img src="${p.profilePic}" class="w-10 h-10 rounded-full border-4 border-yellow-400 shadow-md" onerror="this.src='https://placehold.co/40x40/94A3B8/FFFFFF?text=?'"></div>`:`<img src="${p.profilePic}" class="w-9 h-9 rounded-full border-2 border-slate-200 shadow-sm" onerror="this.src='https://placehold.co/40x40/94A3B8/FFFFFF?text=?'">`}
                    <div class="flex-grow overflow-hidden"><p class="font-semibold text-slate-800 truncate ${i===0?'font-bold text-amber-900':''}">${p.nickname.replace(/</g,"&lt;")}</p></div>
                    <div class="flex-shrink-0 text-right bg-blue-50 px-2 py-1 rounded-md"><p class="font-bold text-blue-600">${p.score}<span class="text-xs font-normal text-blue-400 ml-1">pt</span></p></div></div>`).join('');
        }

        function showCorrectToast(msg, pts, bonus) {
            const html = `<img src="${msg.profilePictureUrl||'https://placehold.co/40x40/4ADE80/14532D?text=:)'}" class="w-12 h-12 rounded-full border-2 border-white flex-shrink-0 shadow-sm" onerror="this.src='https://placehold.co/40x40/4ADE80/14532D?text=:)'">
                <div class="flex-grow overflow-hidden pr-2"><p class="font-bold text-white truncate text-shadow-sm text-lg">${(msg.nickname||'Anonim').replace(/</g,"&lt;")}</p><p class="text-sm text-green-100 font-medium">${correctPhrases[Math.floor(Math.random()*correctPhrases.length)]}</p></div>
                <div class="flex-shrink-0 font-bangers px-3 py-1 rounded-full text-xl rotate-6 shadow-md ${bonus?'bg-gradient-to-r from-yellow-300 to-amber-500 text-amber-900 animate-pulse scale-110 border-2 border-white':'bg-yellow-400 text-yellow-900'}">${bonus?'BONUS! ':''}+${pts}</div>`;
            createToast(html, 'correct');
        }
        function showIncorrectToast(msg) {
            if (toastContainer.querySelector('.toast-incorrect')) return;
            if (simCommentInput && (!tiktokConnection || tiktokConnection.uniqueId === null)) { simCommentInput.classList.add('shake'); simCommentInput.addEventListener('animationend', () => simCommentInput.classList.remove('shake'), { once: true }); }
            
            // PERBAIKAN DI SINI: Cek 'customError' BUKAN 'comment'
            const phrase = msg.customError || incorrectPhrases[Math.floor(Math.random()*incorrectPhrases.length)];
            
            createToast(`<img src="${msg.profilePictureUrl||'https://placehold.co/40x40/EF4444/7F1D1D?text=X'}" class="w-10 h-10 rounded-full border-2 border-white flex-shrink-0 shadow-sm" onerror="this.src='https://placehold.co/40x40/EF4444/7F1D1D?text=X'"><div class="flex-grow overflow-hidden"><p class="font-bold text-white truncate text-shadow-sm">${(msg.nickname||'Anonim').replace(/</g,"&lt;")}</p><p class="text-sm text-red-100 font-medium">${phrase}</p></div>`, 'incorrect');
        }
        function createToast(html, type) {
            if (!toastContainer) return;
            const t = document.createElement('div'); t.className = `toast flex items-center gap-3 w-full p-3 rounded-xl shadow-lg backdrop-blur-md border border-white/10 ${type==='incorrect'?'bg-red-500/90 toast-incorrect':type==='system'?'bg-blue-500/90':'bg-green-500/90'}`; t.innerHTML = html; toastContainer.appendChild(t);
            setTimeout(() => { t.classList.add('toast-out'); t.addEventListener('animationend', () => t.remove(), { once: true }); }, 2500);
        }
        function addScore(uid, nick, pic, pts) {
            if (!gameState.leaderboard[uid]) {
                // Inisialisasi user baru dengan score DAN coins
                gameState.leaderboard[uid] = { score: 0, coins: 0, nickname: nick, profilePic: pic };
            }
            gameState.leaderboard[uid].score += pts; 
            gameState.leaderboard[uid].nickname = nick; 
            gameState.leaderboard[uid].profilePic = pic; 
            saveLeaderboard();
        }

        // --- PERBAIKAN FUNGSI DI SINI ---
        async function fetchAndUpdateLevels() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; githubConfig.PATH = ghPathInput.value.trim();
            levelUpdateStatus.textContent = `Menghubungi GitHub...`; levelUpdateStatus.className = "text-center text-sm text-slate-600 h-auto min-h-[1.25rem]";
            try {
                const res = await fetch(`https://api.github.com/repos/${githubConfig.OWNER}/${githubConfig.REPO}/contents/${githubConfig.PATH}`);
                if (!res.ok) throw new Error(`Gagal akses GitHub: ${res.status}`);
                
                // --- BAGIAN YANG HILANG DIMULAI DI SINI ---
                const files = (await res.json()).filter(f => f.name.toLowerCase().endsWith('.csv') && f.type === 'file').sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
                if (files.length === 0) throw new Error("Tidak ada file CSV.");
                levelUpdateStatus.textContent = `Mengunduh ${files.length} CSV...`;
                const data = await Promise.all(files.map(f => fetch(f.download_url).then(r => r.ok ? r.text() : Promise.reject(f.name))));
                let allLevels = []; data.forEach(txt => allLevels = allLevels.concat(parseCSV(txt)));
                if (allLevels.length === 0) throw new Error("Data kosong.");
                allLevels.forEach((l,i) => { l.level = i+1; l.stage = Math.floor(i/10)+1; });
                levelData = allLevels; localStorage.setItem(CUSTOM_LEVEL_DATA_KEY, JSON.stringify(levelData));
                levelUpdateStatus.textContent = `Sukses! ${levelData.length} level.`; levelUpdateStatus.className = "text-center text-sm text-green-600 h-auto min-h-[1.25rem]"; resetGameProgress();
            } catch (e) { console.error(e); levelUpdateStatus.textContent = `Gagal: ${e.message||e}`; levelUpdateStatus.className = "text-center text-sm text-red-600 h-auto min-h-[1.25rem]"; }
            // --- BAGIAN YANG HILANG SELESAI ---
        }

        function resetGameProgress() { localStorage.removeItem(STORAGE_KEY); const lb = gameState.leaderboard||{}, tl = gameState.topLikers||{}, tg = gameState.topGifters||{}; gameState = { currentLevelIndex: 0, isGameActive: false, isLevelComplete: false, revealedWords: [], nextSlotToGuess: -1, leaderboard: lb, topLikers: tl, topGifters: tg, currentHints: [] }; loadLeaderboard(); loadTopLikers(); loadTopGifters(); updateHomeUI(); }
        function loadLeaderboard() { 
            try { 
                gameState.leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {}; 
                // Migrasi data lama: pastikan semua user punya 'coins'
                for (const uid in gameState.leaderboard) {
                    if (gameState.leaderboard[uid].coins === undefined) {
                        gameState.leaderboard[uid].coins = 0;
                    }
                }
            } catch { 
                gameState.leaderboard = {}; 
            } 
        }
        function saveLeaderboard() { localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(gameState.leaderboard)); }
        function resetLeaderboard() { gameState.leaderboard = {}; localStorage.removeItem(LEADERBOARD_KEY); renderLeaderboard(); }
        function loadTopLikers() { try { gameState.topLikers = JSON.parse(localStorage.getItem(TOP_LIKERS_KEY)) || {}; } catch { gameState.topLikers = {}; } }
        function saveTopLikers() { localStorage.setItem(TOP_LIKERS_KEY, JSON.stringify(gameState.topLikers)); }
        function resetTopLikers() { gameState.topLikers = {}; localStorage.removeItem(TOP_LIKERS_KEY); renderTopLikers(); }
        function loadTopGifters() { try { gameState.topGifters = JSON.parse(localStorage.getItem(TOP_GIFTERS_KEY)) || {}; } catch { gameState.topGifters = {}; } }
        function saveTopGifters() { localStorage.setItem(TOP_GIFTERS_KEY, JSON.stringify(gameState.topGifters)); }
        function resetTopGifters() { gameState.topGifters = {}; localStorage.removeItem(TOP_GIFTERS_KEY); renderTopGifters(); }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); }
        function loadState() { try { gameState = JSON.parse(localStorage.getItem(STORAGE_KEY)) || gameState; loadLeaderboard(); loadTopLikers(); loadTopGifters(); } catch { resetGameProgress(); } }

        init();
    </script>
</body>
</html>