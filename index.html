<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Game LIVE - Host Edition</title>

    <!-- 1. Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Lucide Icons --><script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Socket.IO Client --><script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    
    <!-- 4. Google Font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&family=Bangers&display=swap" rel="stylesheet">

    <!-- 5. Custom Styles --><style>
        body {
            font-family: 'Inter', 'Poppins', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            overscroll-behavior: none;
            background: linear-gradient(-45deg, #0052D4, #4364F7, #6FB1FC, #1cb5e0);
            background-size: 400% 400%;
            animation: gradient-bg 15s ease infinite;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        @keyframes gradient-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0; 
            pointer-events: none;
        }
        .circles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15);
            animation: animate-circles 25s linear infinite;
            bottom: -150px;
            border-radius: 20%; 
        }
        .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .circles li:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .circles li:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .circles li:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .circles li:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .circles li:nth-child(10){ left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

        @keyframes animate-circles {
            0%{ transform: translateY(0) rotate(0deg); opacity: 0.8; border-radius: 10%; }
            100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5); }
            50% { transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.7); }
        }

        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop 0.4s ease-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        .word-slot-shadow { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        
        .slot-active { background-color: #FBBF24; border-color: #F59E0B; color: #78350F; }
        .slot-active-box { background-color: #FEF3C7; border-color: #FCD34D; animation: breathe 3s ease-in-out infinite; }
        
        .slot-locked { background-color: #6B7280; color: #D1D5DB; opacity: 0.8; }
        .slot-locked-box { background-color: #9CA3AF; border-color: #6B7280; }

        @keyframes toast-in { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast { animation: toast-in 0.5s ease-out forwards; }
        .toast-out { animation: toast-out 0.5s ease-in forwards; }

        #word-list-container, #leaderboard-container, .custom-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
        #word-list-container::-webkit-scrollbar, #leaderboard-container::-webkit-scrollbar, .custom-scrollbar::-webkit-scrollbar { display: none; }
        #word-list-container { padding-bottom: 50vh; scroll-behavior: smooth; }

        /* Sambung Kata Specific Styles */
        .mode-sambung #word-list-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            align-items: center; /* Menjaga item tetap sejajar secara vertikal */
            gap: 10px;
            padding: 20px 10px;
        }
        .mode-sambung .word-item {
            width: auto !important;
            flex-grow: 0 !important;
            display: flex;
            justify-content: center;
        }

        /* Class baru untuk kotak Sambung Kata yang rapi */
        .sambung-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 65px;
            height: 60px; /* Tinggi tetap agar sejajar */
            padding: 2px 8px; /* Padding disesuaikan agar konten tidak sesak */
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .font-bangers { font-family: 'Bangers', cursive; letter-spacing: 1.5px; color: #FFFFFF; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4); }
        .text-shadow-lg { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); }

        @keyframes blink { 50% { opacity: 0; } }
        .blinking-cursor { animation: blink 1s step-end infinite; font-weight: bold; }

        @keyframes bonus-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.5); border-color: #FFD700; }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 1), inset 0 0 20px rgba(255, 255, 0, 0.7); border-color: #FFFACD; }
        }
        .bonus-slot { animation: bonus-pulse 1.5s infinite ease-in-out; border-width: 3px; }

        .mask-image-linear-gradient-horizontal { mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .mask-image-vertical-fade { mask-image: linear-gradient(to bottom, black 80%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%); }

        @keyframes sticker-pop-elastic {
            0% { transform: scale(0) rotate(-30deg); opacity: 0; }
            60% { transform: scale(1.4) rotate(10deg); opacity: 1; }
            80% { transform: scale(0.9) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .sticker-animate { animation: sticker-pop-elastic 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
        .sticker-text-stroke { -webkit-text-stroke: 3px black; text-shadow: 5px 5px 0px rgba(0,0,0,0.8); }
        
        @keyframes slide-up-fade { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .rules-animate { animation: slide-up-fade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes count-pulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        .count-animate { animation: count-pulse 1s ease-out infinite; }

        @keyframes gift-slide-in { from { transform: translateY(-100%) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes gift-slide-out { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(-100%) scale(0.8); opacity: 0; } }
        .gift-in { animation: gift-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .gift-out { animation: gift-slide-out 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) forwards; }

        @keyframes podium-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .podium-animate { animation: podium-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
    </style>
</head>

<body class="text-slate-900">

    <ul class="circles">
        <li></li><li></li><li></li><li></li><li></li>
        <li></li><li></li><li></li><li></li><li></li>
    </ul>

    <!-- LOGIN -->
    <div id="login-screen" class="w-full min-h-screen p-6 flex items-center justify-center overflow-y-auto absolute inset-0 z-50 bg-gradient-to-br from-blue-600 to-blue-400">
        <main class="max-w-md w-full mx-auto space-y-8 bg-white/90 backdrop-blur-md p-8 sm:p-10 rounded-3xl shadow-2xl border-2 border-white/50 transform transition-all relative z-10">
            <header class="text-center">
                <h1 class="text-5xl font-bold text-blue-800 mb-2 font-bangers tracking-wider text-shadow-lg">HOST ACCESS</h1>
                <p class="text-xl text-slate-700 font-semibold">Game Interactive LIVE</p>
            </header>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4 text-blue-600"></i> Username
                    </label>
                    <input type="text" id="login-username" placeholder="Masukkan username" class="w-full bg-slate-100 text-slate-900 border-2 border-slate-300 rounded-xl px-4 py-3 focus:ring-4 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none text-lg" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                        <i data-lucide="lock" class="w-4 h-4 text-blue-600"></i> Password
                    </label>
                    <input type="password" id="login-password" placeholder="Masukkan password" class="w-full bg-slate-100 text-slate-900 border-2 border-slate-300 rounded-xl px-4 py-3 focus:ring-4 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none text-lg" required>
                </div>
                <p id="login-error" class="text-sm text-red-600 font-medium text-center h-5 transition-opacity"></p>
                <button type="submit" data-action="perform-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-4 px-6 rounded-xl text-xl transition-all transform hover:scale-[1.01] active:scale-95 focus:outline-none shadow-xl shadow-blue-600/30 tracking-wide">
                    MASUK SEBAGAI HOST
                </button>
            </form>
        </main>
    </div>

    <!-- MODE SELECTION (NEW MENU) -->
    <div id="mode-selection-screen" class="w-full min-h-screen p-6 flex items-center justify-center overflow-y-auto hidden absolute inset-0 z-45 bg-gradient-to-br from-indigo-600 to-purple-500">
        <main class="max-w-2xl w-full mx-auto space-y-8 relative z-10">
            <header class="text-center mb-8">
                <h1 class="text-5xl font-bold text-white mb-2 font-bangers tracking-wider text-shadow-lg drop-shadow-xl">PILIH MODE GAME</h1>
                <p class="text-xl text-blue-100 font-semibold">Mau main apa hari ini?</p>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Mode 1: Kata Berkait -->
                <button onclick="selectGameMode('berkait')" class="group relative bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-3xl p-8 border-2 border-white/30 transition-all hover:scale-105 hover:border-white/60 shadow-xl text-left">
                    <div class="absolute -top-6 -right-6 w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <i data-lucide="link" class="w-10 h-10 text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bangers text-yellow-300 mb-2 tracking-wide text-shadow-lg">KATA BERKAIT</h2>
                    <p class="text-blue-50 mb-4 font-medium">Game rantai kata klasik. Tebak kata selanjutnya berdasarkan kata sebelumnya.</p>
                    <div class="flex items-center gap-2 text-sm text-blue-200 font-bold">
                        <span>MAINKAN</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </div>
                </button>

                <!-- Mode 2: Sambung Kata (NEW) -->
                <button onclick="selectGameMode('sambung')" class="group relative bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-3xl p-8 border-2 border-white/30 transition-all hover:scale-105 hover:border-white/60 shadow-xl text-left">
                    <div class="absolute -top-6 -right-6 w-20 h-20 bg-green-500 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <i data-lucide="message-square-plus" class="w-10 h-10 text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bangers text-green-300 mb-2 tracking-wide text-shadow-lg">SAMBUNG KATA</h2>
                    <p class="text-green-50 mb-4 font-medium">Susun kalimat utuh! Tebak kata per kata untuk melengkapi cerita.</p>
                    <div class="flex items-center gap-2 text-sm text-green-200 font-bold">
                        <span>MAINKAN</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </div>
                </button>
            </div>
            
            <div class="text-center mt-8">
                <button data-action="logout" class="text-white/70 hover:text-white font-bold flex items-center gap-2 mx-auto transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout Host
                </button>
            </div>
        </main>
    </div>

    <!-- HOME (CONFIGURATION) -->
    <div id="home-screen" class="w-full min-h-screen p-4 flex items-center justify-center overflow-y-auto hidden absolute inset-0 z-40 bg-gradient-to-br from-blue-600 to-blue-400">
        <main class="max-w-md w-full mx-auto space-y-6 bg-white/95 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-2xl border border-white/30 my-8 relative z-10">
            <header class="text-center relative">
                <!-- Tombol Kembali ke Menu Utama yang lebih jelas -->
                <button onclick="backToModeSelect()" class="absolute left-0 top-1 p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 transition-colors flex items-center gap-1 shadow-sm" title="Kembali ke Pilih Mode">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> <span class="text-xs font-bold hidden sm:inline">Menu Utama</span>
                </button>
                <h1 class="text-4xl font-bold text-blue-800 mb-1 font-bangers tracking-wider text-shadow-lg pt-2" id="home-title">GAME LIVE</h1>
                <p class="text-sm text-slate-600 font-bold uppercase tracking-widest bg-blue-100 inline-block px-3 py-1 rounded-full" id="active-mode-badge">MODE SELECTED</p>
            </header>

            <section class="p-4 bg-blue-50/70 rounded-xl border border-blue-100">
                <h2 class="text-lg font-bold text-blue-700 mb-3 flex items-center gap-2">
                    <i data-lucide="server" class="w-5 h-5"></i> Hubungkan Server
                </h2>
                <div class="mb-3">
                    <label for="connection-type" class="block text-xs font-medium text-slate-700 mb-1">Tipe Koneksi:</label>
                    <select id="connection-type" class="w-full bg-white border-2 border-blue-300 text-slate-900 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                        <option value="tiktok-connector">TikTok Live Connector (Server Jarak Jauh)</option>
                        <option value="indofinity-ws">IndoFinity WebSocket (Manual/Ngrok)</option>
                        <option value="indofinity-socketio">IndoFinity Socket.IO (Manual/Ngrok)</option>
                    </select>
                </div>
                <div id="unique-id-container" class="mb-3">
                     <label for="connection-unique-id" class="block text-xs font-medium text-slate-700 mb-1" id="unique-id-label">
                        Username TikTok (@username):
                    </label>
                    <input type="text" id="connection-unique-id" placeholder="@username TikTok" class="flex-grow w-full bg-white text-slate-900 placeholder-slate-400 border-2 border-blue-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none">
                    <p id="connection-hint" class="text-xs text-slate-500 mt-1 hidden italic">
                        Jika deploy di Vercel, gunakan Ngrok (wss://...) atau IP Public.
                    </p>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <button data-action="connect-server" id="connect-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none shadow-md">
                        Hubungkan
                    </button>
                    <button data-action="disconnect-server" id="disconnect-button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 px-5 rounded-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none shadow-md hidden">
                        Putuskan
                    </button>
                </div>
                <div id="server-status" class="text-sm text-blue-600 mt-2 h-5">Belum terhubung.</div>
            </section>

            <section class="space-y-4">
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label for="stage-select" class="block text-xs font-medium text-slate-700 mb-1">Pilih Stage:</label>
                        <select id="stage-select" class="w-full bg-slate-100 border-2 border-slate-300 text-slate-900 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="1">Stage 1</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="level-select" class="block text-xs font-medium text-slate-700 mb-1">Pilih Level:</label>
                        <select id="level-select" class="w-full bg-slate-100 border-2 border-slate-300 text-slate-900 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="0">Memuat level...</option>
                        </select>
                    </div>
                </div>
                <button data-action="start-game" id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-extrabold py-4 px-6 rounded-xl text-xl transition-all transform hover:scale-[1.01] active:scale-95 focus:outline-none disabled:bg-slate-400 disabled:cursor-not-allowed disabled:hover:scale-100 shadow-xl shadow-green-600/30 tracking-wide">
                    MULAI GAME!
                </button>
                <div class="flex gap-2">
                    <button data-action="logout" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 font-semibold py-2.5 px-4 rounded-lg text-sm transition-all shadow-md flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
                    </button>
                    <button data-action="end-session" id="end-session-button" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition-all hidden shadow-md">
                        Ganti Level / Akhiri Sesi
                    </button>
                </div>
                <p id="game-status" class="text-center text-sm text-slate-600 mt-2 h-5"></p>
            </section>

            <section class="border-t border-slate-300 pt-5 mt-5">
                <button data-action="toggle-settings" class="flex items-center justify-between w-full text-left text-lg font-bold text-slate-800 mb-3 focus:outline-none">
                    <span class="flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-slate-600"></i> Pengaturan Soal</span>
                    <i data-lucide="chevron-down" id="settings-chevron" class="w-5 h-5 transition-transform"></i>
                </button>
                <div id="settings-panel" class="hidden space-y-4">
                    <div class="bg-slate-100 p-4 rounded-lg border border-slate-200 space-y-3 hidden">
                        <h3 class="font-medium text-slate-700 mb-2 text-sm">Sumber GitHub (Opsional)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">Username</label>
                                <input type="text" id="gh-username" placeholder="cth: SekaLudianto" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 block mb-1">Repository</label>
                                <input type="text" id="gh-repo" placeholder="cth: kata-berkait" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">Folder Path (jika ada)</label>
                            <input type="text" id="gh-path" placeholder="kosongkan untuk root" class="w-full text-sm px-3 py-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none">
                        </div>
                        <button data-action="save-gh-config" class="w-full bg-slate-600 hover:bg-slate-700 text-white text-sm font-medium py-1.5 rounded transition-colors">
                            Simpan Konfigurasi
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <button data-action="update-levels" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-transform active:scale-95 shadow-md">
                            <i data-lucide="download-cloud" class="w-4 h-4"></i>
                            <span>Update (GitHub)</span>
                        </button>
                        <button data-action="import-csv" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 px-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-transform active:scale-95 shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                            <span>Import CSV</span>
                        </button>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <button data-action="reset-leaderboard" class="w-full bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors border border-red-200">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            <span>Reset Papan Peringkat</span>
                        </button>
                        <div class="flex gap-2">
                            <button data-action="reset-top-likers" class="flex-1 bg-pink-100 hover:bg-pink-200 text-pink-700 font-semibold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-pink-200">
                                <i data-lucide="heart-off" class="w-3 h-3"></i> Reset Likes
                            </button>
                            <button data-action="reset-top-gifters" class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-purple-200">
                                <i data-lucide="gift" class="w-3 h-3"></i> Reset Gifts
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-2 pt-2 border-t border-slate-200">
                        <button data-action="export-leaderboard" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-teal-500 shadow-sm">
                            <i data-lucide="download" class="w-3 h-3"></i> Export Rank
                        </button>
                        <button data-action="import-leaderboard-trigger" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-2 rounded-lg text-xs flex items-center justify-center gap-1 transition-colors border border-indigo-500 shadow-sm">
                            <i data-lucide="upload" class="w-3 h-3"></i> Import Rank
                        </button>
                        <input type="file" id="import-leaderboard-input" accept=".json" class="hidden">
                    </div>
                    <div id="level-update-status" class="text-center text-sm text-slate-600 h-auto min-h-[1.25rem] break-words"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- GAME PUZZLE -->
    <div id="puzzle-screen" class="flex flex-col h-screen overflow-hidden hidden relative z-30">
        
        <header class="w-full max-w-2xl mx-auto p-4 flex justify-between items-center text-white relative z-20 flex-shrink-0">
            <div class="flex items-center gap-2">
                <button data-action="go-home" class="p-2 rounded-full hover:bg-white/20 active:bg-white/30 transition-colors" aria-label="Kembali ke Home">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="text-center absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full pointer-events-none">
                <h2 class="font-bangers text-3xl tracking-wider drop-shadow-md hidden sm:block" id="game-title-header">Kata Berkait</h2>
                <h2 class="font-bangers text-2xl tracking-wider drop-shadow-md sm:hidden" id="game-title-header-mobile">KB LIVE</h2>
                <div class="flex items-center justify-center gap-2 flex-wrap">
                    <span id="stage-info" class="text-xs sm:text-sm bg-white/20 px-2 py-0.5 rounded-full font-medium backdrop-blur-sm">S1</span>
                    <h1 id="level-title" class="text-sm sm:text-xl font-semibold opacity-90">Lvl 1</h1>
                    <div id="word-timer-container" class="font-bold text-2xl text-white drop-shadow-md" style="display: none;">
                        <i data-lucide="timer" class="w-5 h-5 inline-block -mt-1"></i>
                        <span id="word-timer-display">3:00</span>
                    </div>
                    <div id="connection-health" class="flex items-center gap-1 bg-black/20 backdrop-blur-sm px-2 py-1 rounded-full ml-2" title="Status Koneksi">
                        <div id="ping-dot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                        <span id="queue-count" class="text-[10px] font-mono text-white/80 w-6 text-center">0</span>
                    </div>
                    <button id="header-reconnect-btn" data-action="manual-reconnect" class="hidden pointer-events-auto bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 animate-pulse transition-colors">
                        <i data-lucide="wifi-off" class="w-3 h-3"></i>
                        <span class="hidden sm:inline">Reconnect</span>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-1 sm:gap-2">
                <!-- AUDIO TOGGLES -->
                <button data-action="toggle-bgm" id="btn-bgm-toggle" class="flex items-center justify-center w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm transition-colors shadow-md border border-white/10" title="Mute/Unmute Music">
                    <i data-lucide="music" class="w-4 h-4"></i>
                </button>
                <button data-action="toggle-sfx" id="btn-sfx-toggle" class="flex items-center justify-center w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm transition-colors shadow-md border border-white/10" title="Mute/Unmute SFX">
                    <i data-lucide="volume-2" class="w-4 h-4"></i>
                </button>

                <button data-action="show-rules" class="flex items-center justify-center w-8 h-8 sm:w-auto sm:px-3 sm:py-2 rounded-full bg-blue-500/80 hover:bg-blue-600 text-white backdrop-blur-sm transition-colors shadow-md" title="Tampilkan Aturan Main">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span class="font-medium text-sm hidden sm:inline ml-1">Aturan</span>
                </button>

                <button data-action="skip-level" class="flex items-center space-x-1 px-2 sm:px-3 py-2 rounded-full bg-amber-500/80 hover:bg-amber-600 text-white backdrop-blur-sm transition-colors shadow-md" title="Lewati level ini">
                    <i data-lucide="fast-forward" class="w-4 h-4"></i>
                    <span class="font-medium text-sm hidden sm:inline">Skip</span>
                </button>
                <button data-action="reset-game" class="flex items-center space-x-1 px-2 sm:px-3 py-2 rounded-full bg-red-500/80 hover:bg-red-600 text-white backdrop-blur-sm transition-colors shadow-md" title="Reset progres level ini">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span class="font-medium text-sm hidden sm:inline">Reset</span>
                </button>
            </div>
        </header>

        <div id="disconnect-notification" class="w-full max-w-2xl mx-auto px-4 pb-2 hidden z-30 relative flex-shrink-0">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-3 p-3 bg-red-600 text-white rounded-xl shadow-lg border border-red-400/50 animate-pulse">
                <div class="flex items-center gap-3">
                    <i data-lucide="wifi-off" class="w-6 h-6 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-bold">Koneksi Terputus!</h3>
                        <p id="disconnect-reason" class="text-sm opacity-90">Menunggu koneksi kembali...</p>
                        <p class="text-sm font-medium text-white/90 mt-1">
                            Silakan klik tombol "Coba Lagi" untuk menyambung ulang.
                        </p>
                    </div>
                </div>
                <button data-action="manual-reconnect" class="w-full sm:w-auto bg-white text-red-600 hover:bg-red-50 font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                    Coba Lagi
                </button>
            </div>
        </div>

        <div id="simulation-mode-container" class="w-full max-w-2xl mx-auto px-4 pt-0 pb-2 hidden z-20 relative flex-shrink-0">
            <div class="flex items-center gap-2 p-2 bg-black/30 backdrop-blur-md rounded-xl border border-white/10">
                <input type="text" id="sim-comment" placeholder="Ketik jawaban simulasi..." class="flex-grow bg-transparent text-white placeholder-white/50 text-sm px-3 py-2 outline-none">
                <button data-action="sim-like" class="bg-pink-500 hover:bg-pink-600 text-white p-2 rounded-lg transition-colors" title="Simulasi Like">
                    <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                </button>
                <button data-action="sim-gift" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg transition-colors" title="Simulasi Gift">
                    <i data-lucide="gift" class="w-4 h-4 fill-current"></i>
                </button>
                <button data-action="sim-send" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors" title="Kirim Jawaban">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <main class="flex-1 w-full max-w-2xl mx-auto px-4 pb-4 overflow-hidden flex flex-col items-center relative z-0">
            <div id="stats-ticker-container" class="w-full max-w-md mb-4 space-y-2 relative z-10 flex-shrink-0">
                <div class="bg-pink-900/30 border border-pink-500/20 p-1.5 rounded-xl flex items-center gap-2 overflow-hidden backdrop-blur-sm shadow-md">
                    <div class="shrink-0 flex items-center gap-1 bg-pink-500/20 px-2 py-1 rounded-full shadow-sm border border-pink-500/10">
                        <i data-lucide="heart" class="w-3.5 h-3.5 text-pink-400 fill-pink-400"></i>
                        <span class="text-[10px] font-bold text-pink-300 tracking-wide">LIKES</span>
                    </div>
                    <div id="top-likers-viewport" class="flex-grow overflow-hidden relative h-7 mask-image-linear-gradient-horizontal">
                        <div id="top-likers-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-2 will-change-transform">
                            <p class="text-white/50 text-[10px] italic">Belum ada like...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-indigo-900/30 border border-indigo-500/20 p-1.5 rounded-xl flex items-center gap-2 overflow-hidden backdrop-blur-sm shadow-md">
                    <div class="shrink-0 flex items-center gap-1 bg-indigo-500/20 px-2 py-1 rounded-full shadow-sm border border-indigo-500/10">
                        <i data-lucide="gift" class="w-3.5 h-3.5 text-indigo-400 fill-indigo-400"></i>
                        <span class="text-[10px] font-bold text-indigo-300 tracking-wide">GIFTS</span>
                    </div>
                    <div id="top-gifters-viewport" class="flex-grow overflow-hidden relative h-7 mask-image-linear-gradient-horizontal">
                         <div id="top-gifters-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-2 will-change-transform">
                             <p class="text-white/50 text-[10px] italic">Belum ada gift...</p>
                         </div>
                    </div>
                </div>
            </div>

            <div class="w-full max-w-md mb-2 relative z-10 flex-shrink-0">
                <div id="info-ticker-container" class="bg-gradient-to-r from-purple-600 to-indigo-600 border border-purple-400/50 text-white py-1.5 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-opacity duration-500">
                    <i id="info-ticker-icon" data-lucide="gift" class="w-4 h-4 text-yellow-300 fill-yellow-300"></i>
                    <span id="info-ticker-text" class="text-xs sm:text-sm font-bold uppercase tracking-wider text-shadow-sm flex items-center gap-1">
                        1 <img src="https://p16-webcast.tiktokcdn.com/img/maliva/webcast-va/eba3a9bb85c33e017f3648eaf88d7189~tplv-obj.webp" class="w-4 h-4 inline rounded-sm mx-1"> = Buka 1 Huruf!
                    </span>
                </div>
            </div>

            <div id="word-list-container" class="w-full max-w-md space-y-3.5 overflow-y-auto pr-2 py-2 mask-image-linear-gradient flex-1 relative z-10">
                <!-- Slot kata di-generate oleh JS -->
            </div>
        </main>
    </div>
    
    <!-- MODAL MENANG -->
    <div id="win-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity duration-300">
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl p-5 text-center transform transition-all scale-in max-h-[95vh] flex flex-col">
            <div class="flex-shrink-0">
                <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm">
                    <i data-lucide="trophy" class="w-7 h-7 text-green-600"></i>
                </div>
                <h2 id="win-modal-title" class="text-2xl font-bold text-slate-800 mb-0 font-bangers tracking-wide leading-tight transition-all duration-300">PERINGKAT LEVEL INI</h2>
                <p id="win-modal-subtitle" class="text-slate-500 text-xs mb-3 transition-all duration-300">Skor yang didapat di level ini.</p>
            </div>
            <div id="modal-scroll-area" class="w-full flex-grow overflow-y-auto custom-scrollbar min-h-0 pr-1 relative scroll-smooth">
                <div class="bg-slate-50 rounded-xl p-2 border border-slate-100 transition-opacity duration-500" id="leaderboard-wrapper">
                    <div id="leaderboard-container" class="w-full"></div>
                </div>
            </div>
            <div class="flex-shrink-0 mt-3 pt-2 border-t border-slate-100">
                <div id="next-level-prompt">
                    <div class="flex items-center justify-between text-xs font-bold text-slate-600 mb-1 px-1">
                        <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3 text-blue-500"></i> Auto Next Level</span>
                        <span class="flex items-center gap-1 text-pink-500" id="timer-status-text">
                            <img src="https://p16-webcast.tiktokcdn.com/img/maliva/webcast-va/eba3a9bb85c33e017f3648eaf88d7189~tplv-obj.webp" class="w-3.5 h-3.5 inline"> = Percepat! ðŸš€
                        </span>
                    </div>
                    <div id="next-level-progress-container" class="w-full bg-gray-200 rounded-full h-4 mb-1 overflow-hidden border border-gray-300 relative shadow-inner">
                        <div id="next-level-progress-bar" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-full rounded-full transition-all duration-1000 ease-linear flex items-center justify-center" style="width: 0%">
                        </div>
                        <p id="next-level-text" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-slate-600 z-10 drop-shadow-sm">30 Detik</p>
                    </div>
                    <!-- Tombol Menu Utama di Modal Menang -->
                    <button onclick="backToModeSelect()" class="w-full mt-2 px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-bold hover:bg-slate-300 transition-colors text-xs flex items-center justify-center gap-1">
                        <i data-lucide="arrow-left" class="w-3 h-3"></i> Kembali ke Menu Utama
                    </button>
                </div>
                <div id="all-complete-prompt" class="hidden flex flex-col items-center justify-center py-2 animate-bounce-slow">
                    <h3 class="text-3xl font-bangers text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-600 mb-2 drop-shadow-sm">ðŸŽ‰ GAME TAMAT! ðŸŽ‰</h3>
                    <p class="text-sm text-slate-500 font-medium mb-4">Terima kasih telah bermain sampai akhir!</p>
                    <button data-action="go-home" class="w-full px-4 py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition-transform active:scale-95 text-sm shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="home" class="w-4 h-4"></i> Kembali ke Menu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAYS -->
    <div id="sticker-overlay" class="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none hidden">
        <div id="sticker-content" class="font-bangers text-8xl sm:text-9xl text-yellow-400 sticker-text-stroke rotate-[-10deg] drop-shadow-2xl">
            MANTAPS!
        </div>
    </div>
    
    <div id="rules-overlay" class="fixed inset-0 z-[65] flex items-center justify-center pointer-events-none hidden px-4">
        <div class="bg-slate-900/95 text-white p-6 rounded-3xl shadow-2xl border-2 border-white/20 max-w-sm w-full text-center rules-animate backdrop-blur-xl">
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                <i data-lucide="scale" class="w-8 h-8 text-white"></i>
            </div>
            <h2 class="font-bangers text-3xl mb-4 tracking-wide text-blue-300">ATURAN MAIN</h2>
            <div class="space-y-4 text-sm font-medium">
                <div class="bg-white/10 p-3 rounded-xl border border-white/10">
                    <div class="flex items-center justify-center gap-2 mb-1 text-yellow-300 font-bold">
                        <i data-lucide="star" class="w-4 h-4"></i> SISTEM POIN
                    </div>
                    <p>ðŸ¥‡ Tercepat: <span class="font-bold text-green-400">10 Poin</span></p>
                    <p>ðŸ¥ˆ Susulan: <span class="font-bold text-yellow-400">5 Poin</span></p>
                </div>
                <div class="bg-white/10 p-3 rounded-xl border border-white/10">
                    <div class="flex items-center justify-center gap-2 mb-1 text-blue-300 font-bold">
                        <i data-lucide="server" class="w-4 h-4"></i> WAKTU SERVER
                    </div>
                    <p class="opacity-90 leading-relaxed">
                        Urutan komentar yang menang berdasarkan <span class="text-red-400 font-bold">Waktu Masuk di Server</span>, bukan tampilan di HP masing-masing.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="ready-overlay" class="fixed inset-0 z-[70] flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="font-bangers text-6xl text-white drop-shadow-lg mb-4 animate-bounce">SIAP-SIAP!</div>
        <div id="countdown-number" class="font-bangers text-8xl text-yellow-400 drop-shadow-2xl count-animate">3</div>
    </div>

    <div id="gift-overlay" class="fixed top-24 left-1/2 -translate-x-1/2 z-[80] pointer-events-none hidden">
        <div id="gift-card" class="bg-white p-4 rounded-2xl shadow-2xl border-2 border-purple-400 flex flex-col items-center text-center min-w-[250px] transform transition-all">
            <div class="relative mb-2">
                <div class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full blur opacity-75 animate-pulse"></div>
                <img id="gift-user-pic" src="" class="relative w-20 h-20 rounded-full border-4 border-white shadow-md object-cover" onerror="this.src='https://placehold.co/80x80/A855F7/FFFFFF?text=G'">
            </div>
            <h3 id="gift-user-name" class="font-bold text-xl text-slate-900 mb-1 font-bangers tracking-wide">NAMA PENGIRIM</h3>
            <p class="text-purple-600 font-semibold mb-3 flex items-center gap-1">
                <span class="text-sm">Mengirim</span> <span id="gift-name" class="font-bold">Hadiah</span>!
            </p>
            <div class="bg-purple-100 text-purple-800 px-4 py-2 rounded-xl font-bold text-lg animate-bounce-slow">
                THANK YOU KAK! âœ¨
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-28 left-2 w-auto max-w-[220px] z-50 space-y-1.5 pointer-events-none"></div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity duration-300">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-center transform pop-in">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
            </div>
            <h2 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2">Anda Yakin?</h2>
            <p id="confirm-message" class="text-slate-600 mb-6">Apakah Anda yakin ingin melakukan aksi ini?</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-no" class="flex-1 px-4 py-3 rounded-xl bg-slate-200 text-slate-700 font-bold hover:bg-slate-300 transition-transform active:scale-95">
                    Batal
                </button>
                <button id="confirm-yes" class="flex-1 px-4 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-transform active:scale-95">
                    Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // --- AUDIO CONTROLLER ---
        class AudioController {
            constructor() {
                this.bgmMuted = false;
                this.sfxMuted = false;
                this.sounds = {};
                this.sources = {
                    correct: 'https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3',
                    win: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3',
                    mantap: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                    gift: 'https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3',
                    wrong: 'https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3',
                    pop: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
                    tick: 'https://assets.mixkit.co/active_storage/sfx/2566/2566-preview.mp3',
                    bgm: './bgm.mp3' 
                };
                this.bgmAudio = null;
            }
            preload() {
                for (const [key, src] of Object.entries(this.sources)) {
                    this.sounds[key] = new Audio(src);
                    if (key === 'bgm') {
                        this.sounds[key].loop = true;
                        this.sounds[key].volume = 0.3;
                        this.bgmAudio = this.sounds[key];
                    }
                }
            }
            play(key) {
                if (key === 'bgm') {
                    if (this.bgmMuted || !this.bgmAudio) return;
                    this.bgmAudio.play().catch(e => console.warn("BGM blocked:", e));
                    return;
                }
                if (this.sfxMuted || !this.sounds[key]) return;
                const sound = this.sounds[key].cloneNode();
                sound.volume = 0.8;
                sound.play().catch(e => console.warn("SFX blocked:", e));
            }
            toggleBGM() {
                this.bgmMuted = !this.bgmMuted;
                if (this.bgmAudio) {
                    if (this.bgmMuted) this.bgmAudio.pause();
                    else this.bgmAudio.play().catch(e => console.warn("BGM blocked:", e));
                }
                return this.bgmMuted;
            }
            toggleSFX() {
                this.sfxMuted = !this.sfxMuted;
                return this.sfxMuted;
            }
            startBGM() {
                if (!this.bgmMuted && this.bgmAudio) {
                    this.bgmAudio.play().catch(e => console.warn("BGM autoplay blocked:", e));
                }
            }
        }
        
        const audioManager = new AudioController();

        const HOST_USERNAME = "Syazani";
        const HOST_PASSWORD = "Dirman26";
        const AUTH_KEY = 'kata-rantai-host-auth-v1';
        const HOST_USERNAME_KEY = 'kata-rantai-host-user-v1';
        
        const ROSE_URL = "https://p16-webcast.tiktokcdn.com/img/maliva/webcast-va/eba3a9bb85c33e017f3648eaf88d7189~tplv-obj.webp";

        const GH_CONFIG_KEY = 'kata-rantai-gh-config-v1';
        const LAST_USERNAME_KEY = 'kata-rantai-last-username-v1'; 
        
        // MODIFIED: Keys now depend on game mode function
        const LEADERBOARD_KEY_BASE = 'kata-rantai-leaderboard-v1'; 
        const TOP_LIKERS_KEY_BASE = 'kata-rantai-top-likers-v1'; 
        const TOP_GIFTERS_KEY_BASE = 'kata-rantai-top-gifters-v1';
        
        const CUSTOM_LEVEL_DATA_KEY = 'kata-rantai-custom-levels-v1';
        const STORAGE_KEY = 'kata-rantai-save-v1';

        const TIKTOK_SERVERS = ["https://9df1bbf0413b.ngrok-free.app"];
        const INDOFINITY_WS_PORT = 62024;
        const INDOFINITY_SOCKETIO_PORT = 62025;

        // MODE CONFIG
        const GAME_MODES = {
            'berkait': { 
                title: 'Kata Berkait', 
                mobileTitle: 'KB LIVE', 
                folder: 'csv', 
                bgGradient: 'from-blue-600 to-blue-400',
                parser: parseNormalCSV
            },
            'sambung': { 
                title: 'Sambung Kata', 
                mobileTitle: 'SK LIVE', 
                folder: 'csv_sambung', 
                bgGradient: 'from-green-600 to-emerald-500',
                parser: parseSambungCSV
            }
        };

        let currentMode = 'berkait'; 
        let currentServerIndex = 0;
        let githubConfig = { OWNER: 'SekaLudianto', REPO: 'kata-berkait', PATH: 'csv', BRANCH: 'main' };

        function getDynamicIP(port) {
            let host = 'localhost';
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                host = window.location.hostname;
            }
            return host;
        }

        class ConnectionHandler {
            constructor() { this.eventListeners = {}; this.uniqueId = null; this.options = null; }
            on(eventName, eventHandler) { this.eventListeners[eventName] = eventHandler; }
            emit(eventName, data) { if (this.eventListeners[eventName]) this.eventListeners[eventName](data); }
            removeAllCustomListeners() { this.eventListeners = {}; }
        }

        class IndoFinityWSConnection extends ConnectionHandler {
            constructor(host) {
                super();
                this.ws = null;
                this.serverUrl = (host.startsWith('ws://') || host.startsWith('wss://')) ? host : `ws://${host}:${INDOFINITY_WS_PORT}`;
            }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId; 
                return new Promise((resolve, reject) => {
                    this.ws = new WebSocket(this.serverUrl);
                    this.ws.onopen = () => { console.info('Terhubung ke IndoFinity WebSocket'); resolve(); };
                    this.ws.onmessage = (message) => { try { this.handleIndoFinityMessage(JSON.parse(message.data)); } catch (error) {} };
                    this.ws.onclose = () => { this.emit('disconnect'); };
                    this.ws.onerror = (err) => { reject('WebSocket Error'); };
                    setTimeout(() => { reject('Connection Timeout'); }, 5000); 
                });
            }
            handleIndoFinityMessage(dataPackage) {
                const event = dataPackage.event; const eventData = dataPackage.data; if (!event || !eventData) return;
                switch (event) {
                    case 'chat': this.emit('chat', { comment: eventData.comment || '', uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname || 'Pengguna IndoFinity', profilePictureUrl: eventData.profilePictureUrl, msgId: eventData.msgId || eventData.id || Date.now().toString() }); break;
                    case 'like': this.emit('like', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname, profilePictureUrl: eventData.profilePictureUrl, likeCount: eventData.count || 1, msgId: eventData.msgId || eventData.id }); break;
                    case 'gift': this.emit('gift', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname, profilePictureUrl: eventData.profilePictureUrl, diamondCount: eventData.diamondCount || 0, giftName: eventData.giftName, repeatCount: eventData.repeatCount || 1, giftId: eventData.giftId || eventData.id, msgId: eventData.msgId || eventData.id }); break;
                }
            }
            disconnect() { if (this.ws) this.ws.close(); }
        }

        class IndoFinityIOConnection extends ConnectionHandler {
            constructor(host) {
                super();
                this.socket = null;
                this.serverUrl = (host.startsWith('http://') || host.startsWith('https://')) ? host : `http://${host}:${INDOFINITY_SOCKETIO_PORT}`;
            }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId; 
                return new Promise((resolve, reject) => {
                    this.socket = io(this.serverUrl, { transports: ['websocket', 'polling'], reconnection: true });
                    this.socket.on('connect', () => { resolve(); });
                    this.socket.on('message', (dataPackage) => { try { this.handleIndoFinityMessage(dataPackage); } catch (error) {} });
                    this.socket.on('disconnect', () => { this.emit('disconnect'); });
                    this.socket.on('connect_error', (err) => { reject(`Socket.IO Error: ${err.message}`); });
                    setTimeout(() => { reject('Connection Timeout'); }, 5000);
                });
            }
            handleIndoFinityMessage(dataPackage) {
                const event = dataPackage.event; const eventData = dataPackage.data; if (!event || !eventData) return;
                switch (event) {
                    case 'chat': this.emit('chat', { comment: eventData.comment || '', uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname, profilePictureUrl: eventData.profilePictureUrl, msgId: eventData.msgId || eventData.id || Date.now().toString() }); break;
                    case 'like': this.emit('like', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname, profilePictureUrl: eventData.profilePictureUrl, likeCount: eventData.count || 1, msgId: eventData.msgId || eventData.id }); break;
                    case 'gift': this.emit('gift', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname, profilePictureUrl: eventData.profilePictureUrl, diamondCount: eventData.diamondCount || 0, giftName: eventData.giftName, repeatCount: eventData.repeatCount || 1, giftId: eventData.giftId || eventData.id, msgId: eventData.msgId || eventData.id }); break;
                }
            }
            disconnect() { if (this.socket) this.socket.disconnect(); }
        }

        class TikTokIOConnection extends ConnectionHandler {
            constructor(backendUrl) {
                super();
                this.socket = io(backendUrl, { reconnection: false, timeout: 5000, transports: ['websocket', 'polling'] });
                this.socket.on('connect', () => { if (this.uniqueId) this.setUniqueId(); });
                this.socket.on('disconnect', () => { this.uniqueId = null; this.emit('disconnect'); });
                this.socket.on('streamEnd', () => { this.uniqueId = null; this.emit('streamEnd'); });
                this.socket.on('tiktokDisconnected', (errMsg) => { if (errMsg && errMsg.includes('LIVE has ended')) this.uniqueId = null; this.emit('tiktokDisconnected', errMsg); });
            }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId.replace(/^@/, ''); this.options = options || {}; 
                this.removeAllCustomListeners(); 
                this.setUniqueId();
                return new Promise((resolve, reject) => { 
                    this.socket.once('tiktokConnected', resolve); 
                    this.socket.once('tiktokDisconnected', (errMsg) => reject(`TikTok Error: ${errMsg}`)); 
                    this.socket.on('connect_error', (err) => { reject(`Socket Network Error: ${err.message}`); });
                    setTimeout(() => { reject('Connection Timeout (15s)'); }, 15000); 
                });
            }
            setUniqueId() { this.socket.emit('setUniqueId', this.uniqueId, this.options); }
            on(eventName, eventHandler) {
                super.on(eventName, eventHandler);
                if (['chat','like','gift'].includes(eventName)) this.socket.on(eventName, eventHandler);
            }
            removeAllCustomListeners() {
                super.removeAllCustomListeners();
                this.socket.off('chat'); this.socket.off('like'); this.socket.off('gift');
            }
            disconnect() { if (this.socket) { this.socket.disconnect(); } }
        }

        let levelData = []; 
        const correctPhrases = ["Wih, Jagoan!", "Jenius!", "Mantap Betul!", "Gokil!", "Anjay GG!", "Luar Biasa!", "Kerja Bagus!", "Hebat!", "Cakep kek pantun!"];
        const incorrectPhrases = ["Typo ya?", "Coba Lagi!", "Betul tapi boong!", "Zonk!", "Waduh!", "Dikit Lagi!", "Hampir...!", "Bukan itu!", "Salah Woy!"];
        
        const WORD_TIMER_DURATION = 180;
        const NEXT_LEVEL_DELAY_SECONDS = 30;
        let nextLevelCountdownInterval = null;
        const WIN_WINDOW_DURATION = 3000; 
        const LEVEL_LB_DURATION = 7000;

        let gameState = { 
            currentLevelIndex: 0, 
            isGameActive: false, 
            isLevelComplete: false, 
            isAcceptingGuesses: false, 
            revealedWords: [], 
            nextSlotToGuess: -1, 
            leaderboard: {}, 
            levelScores: {}, 
            topLikers: {}, 
            topGifters: {}, 
            currentHints: [], 
            wordTimerInterval: null, 
            wordTimerRemaining: WORD_TIMER_DURATION,
            nextLevelTimerRemaining: 30,
            isRoundClosing: false, 
            roundWinners: []       
        }; 
        let isProcessingWin = false;
        let isReconnecting = false; 
        let currentConnection = null; 
        let lastConnectedUsername = null; 
        let likerScrollInterval = null; 
        let gifterScrollInterval = null;
        let leaderboardScrollInterval = null; 
        let isAuthenticated = localStorage.getItem(AUTH_KEY) === 'true'; 
        let currentConnectionType = 'tiktok-connector'; 

        // DOM ELEMENTS
        const connectionTypeSelect = document.getElementById('connection-type');
        const connectionUniqueId = document.getElementById('connection-unique-id');
        const uniqueIdContainer = document.getElementById('unique-id-container');
        const uniqueIdLabel = document.getElementById('unique-id-label');
        const connectionHint = document.getElementById('connection-hint'); 
        const serverStatus = document.getElementById('server-status');
        const disconnectButton = document.getElementById('disconnect-button');
        const loginScreen = document.getElementById('login-screen');
        const modeSelectionScreen = document.getElementById('mode-selection-screen'); // NEW
        const loginForm = document.getElementById('login-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const homeScreen = document.getElementById('home-screen');
        const puzzleScreen = document.getElementById('puzzle-screen');
        const startGameButton = document.getElementById('start-game-button');
        const endSessionButton = document.getElementById('end-session-button'); 
        const gameStatus = document.getElementById('game-status');
        const connectButton = document.getElementById('connect-button');
        const simContainer = document.getElementById('simulation-mode-container');
        const simCommentInput = document.getElementById('sim-comment');
        const levelUpdateStatus = document.getElementById('level-update-status');
        const levelTitle = document.getElementById('level-title');
        const stageInfo = document.getElementById('stage-info'); 
        const wordListContainer = document.getElementById('word-list-container');
        const winModal = document.getElementById('win-modal');
        const nextLevelPrompt = document.getElementById('next-level-prompt');
        const allCompletePrompt = document.getElementById('all-complete-prompt');
        const toastContainer = document.getElementById('toast-container');
        const disconnectNotification = document.getElementById('disconnect-notification');
        const disconnectReason = document.getElementById('disconnect-reason');
        const csvFileInput = document.getElementById('csv-file-input');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsChevron = document.getElementById('settings-chevron');
        const ghUsernameInput = document.getElementById('gh-username');
        const ghRepoInput = document.getElementById('gh-repo');
        const ghPathInput = document.getElementById('gh-path');
        const stageSelect = document.getElementById('stage-select'); 
        const levelSelect = document.getElementById('level-select');
        const headerReconnectBtn = document.getElementById('header-reconnect-btn');
        const topLikersList = document.getElementById('top-likers-list'); 
        const topGiftersList = document.getElementById('top-gifters-list');
        const stickerOverlay = document.getElementById('sticker-overlay');
        const stickerContent = document.getElementById('sticker-content');
        const readyOverlay = document.getElementById('ready-overlay');
        const countdownNumberEl = document.getElementById('countdown-number');
        const giftOverlay = document.getElementById('gift-overlay');
        const giftCard = document.getElementById('gift-card');
        const giftUserPic = document.getElementById('gift-user-pic');
        const giftUserName = document.getElementById('gift-user-name');
        const giftNameEl = document.getElementById('gift-name');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        const homeTitle = document.getElementById('home-title');
        const activeModeBadge = document.getElementById('active-mode-badge');
        
        let onConfirmCallback = null; 
        let giftQueue = [];
        let isGiftOverlayShowing = false;
        let autoScrollIntervalId = null;
        let chatQueue = [];
        const CHAT_PROCESS_RATE = 50; 
        const PROCESS_INTERVAL = 33;  
        const MAX_QUEUE_SIZE = 500;   
        const processedPacketIds = new Set();
        const streakTracker = new Map();
        const giftTimeTracker = new Map();

        // Helper function for dynamic keys
        function getLeaderboardKey() { return `${LEADERBOARD_KEY_BASE}-${currentMode}`; }
        function getTopLikersKey() { return `${TOP_LIKERS_KEY_BASE}-${currentMode}`; }
        function getTopGiftersKey() { return `${TOP_GIFTERS_KEY_BASE}-${currentMode}`; }
        
        function init() {
            setupGlobalListeners();
            loadGitHubConfig();
            loadLastUsername(); 
            audioManager.preload(); 
            
            const savedHostUsername = localStorage.getItem(HOST_USERNAME_KEY);
            if (isAuthenticated && loginUsernameInput && savedHostUsername) {
                loginUsernameInput.value = savedHostUsername;
            }
            
            // Note: Data loading moved to selectGameMode because path depends on mode
            
            loadState(); 
            
            if (isAuthenticated) {
                showPage('mode-selection'); // Show mode selection first
                setupConnectionUI(currentConnectionType); 
            } else {
                showPage('login');
                if (loginUsernameInput && !savedHostUsername) {
                    setTimeout(() => loginUsernameInput.focus(), 100);
                }
            }

            lucide.createIcons();
            likerScrollInterval = startAutoScroll('top-likers-list', likerScrollInterval);
            gifterScrollInterval = startAutoScroll('top-gifters-list', gifterScrollInterval);
            
            startInfoTicker();
            setInterval(processChatQueue, PROCESS_INTERVAL);
            setInterval(updateConnectionHealthUI, 1000);
            
            setInterval(() => {
                if(processedPacketIds.size > 2000) { const it = processedPacketIds.values(); for(let i=0; i<1000; i++) processedPacketIds.delete(it.next().value); }
                if(streakTracker.size > 2000) { const it = streakTracker.keys(); for(let i=0; i<500; i++) streakTracker.delete(it.next().value); const itt = giftTimeTracker.keys(); for(let i=0; i<500; i++) giftTimeTracker.delete(itt.next().value); }
            }, 60000);
        }

        function showPage(pageName) {
            loginScreen.classList.toggle('hidden', pageName !== 'login');
            modeSelectionScreen.classList.toggle('hidden', pageName !== 'mode-selection');
            homeScreen.classList.toggle('hidden', pageName !== 'home');
            puzzleScreen.classList.toggle('hidden', pageName !== 'game');
            lucide.createIcons(); 
        }

        function selectGameMode(mode) {
            currentMode = mode;
            const config = GAME_MODES[mode];
            
            // Update UI based on mode
            homeTitle.textContent = config.title;
            activeModeBadge.textContent = config.title.toUpperCase();
            document.getElementById('game-title-header').textContent = config.title;
            document.getElementById('game-title-header-mobile').textContent = config.mobileTitle;
            
            // Apply specific styles if needed
            document.body.className = `text-slate-900 mode-${mode}`;

            // Set github path
            githubConfig.PATH = config.folder;
            saveGitHubConfig(); // persist path

            // Reset current stats display for the new mode
            gameState.leaderboard = {};
            gameState.topLikers = {};
            gameState.topGifters = {};
            
            // Reload data specific to this mode
            loadLeaderboard();
            loadTopLikers();
            loadTopGifters();
            renderTopLikers();
            renderTopGifters();

            // Load data for this mode
            fetchAndUpdateLevels().then(() => {
                 showPage('home');
                 updateHomeUI();
            });
        }

        function backToModeSelect() {
            showConfirm('Kembali ke pemilihan mode? Sesi game ini akan berakhir.', () => {
                stopWordTimer();
                gameState.isGameActive = false;
                if(winModal) winModal.classList.add('hidden');
                showPage('mode-selection');
            }, 'Ganti Mode?');
        }

        function handleLogin(e) {
            e.preventDefault(); 
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value;
            if (username.toUpperCase() === HOST_USERNAME.toUpperCase() && password === HOST_PASSWORD) {
                isAuthenticated = true;
                localStorage.setItem(AUTH_KEY, 'true');
                localStorage.setItem(HOST_USERNAME_KEY, username); 
                loginError.textContent = '';
                showPage('mode-selection'); // Go to mode select
                audioManager.play('pop'); 
                createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-green-100">Login Berhasil! Selamat datang, Host.</p></div>', 'correct');
            } else {
                audioManager.play('wrong'); 
                loginError.textContent = 'Username atau Password salah.';
                loginUsernameInput.classList.add('shake');
                loginPasswordInput.classList.add('shake');
                setTimeout(()=>loginUsernameInput.classList.remove('shake'), 500);
                setTimeout(()=>loginPasswordInput.classList.remove('shake'), 500);
            }
        }
        
        function handleLogout() {
             showConfirm('Anda yakin ingin keluar?', () => {
                isAuthenticated = false;
                localStorage.removeItem(AUTH_KEY);
                currentConnection = null; 
                showPage('login');
            }, 'Keluar?');
        }

        // ... (Connection logic remains same) ...

        function setupConnectionUI(type) {
            currentConnectionType = type;
            const isTikTok = type === 'tiktok-connector';
            const isIndoFinity = type.startsWith('indofinity');
            
            uniqueIdContainer.classList.remove('hidden');
            connectionHint.classList.add('hidden'); 

            if (isTikTok) {
                uniqueIdLabel.textContent = 'Username TikTok (@username):';
                connectionUniqueId.placeholder = '@username TikTok';
                connectionUniqueId.value = lastConnectedUsername || '';
            } else if (isIndoFinity) {
                const host = getDynamicIP();
                uniqueIdLabel.textContent = 'Alamat Host/IP/URL (Manual/Ngrok):';
                connectionUniqueId.placeholder = `cth: 192.168.1.5 atau wss://...`;
                connectionUniqueId.value = host; 
                connectionHint.classList.remove('hidden');
            }
        }

        function setupGlobalListeners() {
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (connectionTypeSelect) connectionTypeSelect.addEventListener('change', (e) => {
                setupConnectionUI(e.target.value);
                serverStatus.textContent = 'Belum terhubung.';
                serverStatus.classList.remove('text-red-600', 'text-green-600');
                disconnectButton.classList.add('hidden');
                connectButton.classList.remove('hidden');
                if (currentConnection) { currentConnection.disconnect(); currentConnection = null; }
            });

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const { action } = target.dataset;
                
                if (action !== 'toggle-bgm' && action !== 'toggle-sfx') audioManager.play('pop'); 

                switch (action) {
                    case 'logout': handleLogout(); break; 
                    case 'connect-server': connectToServer(); break; 
                    case 'disconnect-server': 
                        if (currentConnection) {
                            currentConnection.disconnect();
                            currentConnection = null;
                            serverStatus.textContent = 'Koneksi diputus.';
                            serverStatus.classList.add('text-red-600');
                            disconnectButton.classList.add('hidden');
                            connectButton.classList.remove('hidden');
                            simContainer.classList.remove('hidden'); 
                        }
                        break;
                    case 'start-game': 
                        audioManager.startBGM();
                        startOrContinueGame(); 
                        break;
                    case 'end-session': 
                        showConfirm('Akhiri sesi saat ini?', () => { gameState.isGameActive = false; saveState(); updateHomeUI(); });
                        break;
                    case 'go-home': goToHome(); break;
                    case 'reset-game': showConfirm('Reset progres level ini?', () => { loadLevel(gameState.currentLevelIndex, true); }); break;
                    case 'skip-level': showConfirm('Lewati level ini?', () => { loadNextLevel(); }); break;
                    case 'manual-reconnect': 
                        if (currentConnection) { currentConnection.disconnect(); currentConnection = null; }
                        connectToServer(true);
                        break;
                    case 'show-rules':
                        if (rulesOverlay) {
                            rulesOverlay.classList.remove('hidden');
                            setTimeout(() => rulesOverlay.classList.add('hidden'), 6000);
                        }
                        break;
                    case 'toggle-bgm': 
                        const isBgmMuted = audioManager.toggleBGM();
                        target.classList.toggle('text-red-400', isBgmMuted);
                        target.classList.toggle('bg-white/10', isBgmMuted); 
                        break;
                    case 'toggle-sfx': 
                        const isSfxMuted = audioManager.toggleSFX();
                        const sfxIcon = target.querySelector('i');
                        if (sfxIcon) {
                            sfxIcon.setAttribute('data-lucide', isSfxMuted ? 'volume-x' : 'volume-2');
                            lucide.createIcons();
                            target.classList.toggle('text-red-400', isSfxMuted);
                            target.classList.toggle('bg-white/10', isSfxMuted);
                        }
                        break;
                    case 'sim-send': if (simCommentInput && simCommentInput.value.trim()) { handleComment({ comment: simCommentInput.value.trim(), uniqueId: 'simulator_user_id', nickname: 'Pemain Simulasi', profilePictureUrl: 'https://placehold.co/40x40/0284C7/FFFFFF?text=S' }); simCommentInput.value = ''; } break;
                    case 'sim-like': handleLike({ uniqueId: 'sim_liker_' + Math.floor(Math.random()*5), nickname: 'Liker ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/EC4899/FFFFFF?text=L', likeCount: Math.floor(Math.random() * 20) + 5 }); break;
                    case 'sim-gift': handleGift({ uniqueId: 'sim_gifter_' + Math.floor(Math.random()*5), nickname: 'Sultan ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/A855F7/FFFFFF?text=G', diamondCount: Math.floor(Math.random() * 50) + 1, giftName: 'Mawar' }); break;
                    case 'update-levels': fetchAndUpdateLevels(); break;
                    case 'import-csv': if (csvFileInput) csvFileInput.click(); break;
                    case 'toggle-settings': settingsPanel.classList.toggle('hidden'); settingsChevron.classList.toggle('rotate-180'); break;
                    case 'save-gh-config': saveGitHubConfig(); createToast('<div class="flex-grow"><p class="font-bold text-white">Sistem</p><p class="text-sm text-blue-100">Konfigurasi tersimpan!</p></div>', 'system'); break;
                    case 'reset-leaderboard': showConfirm('Reset Papan Peringkat?', () => { resetLeaderboard(); }, 'Reset Skor?'); break;
                    case 'reset-top-likers': showConfirm('Reset Top Likers?', () => { resetTopLikers(); }); break;
                    case 'reset-top-gifters': showConfirm('Reset Top Gifters?', () => { resetTopGifters(); }); break;
                    case 'export-leaderboard': exportLeaderboard(); break;
                    case 'import-leaderboard-trigger': 
                        const fileInput = document.getElementById('import-leaderboard-input');
                        if (fileInput) fileInput.click(); 
                        break;
                }
            });
            if (simCommentInput) simCommentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.querySelector('[data-action="sim-send"]').click(); } });
            if (csvFileInput) csvFileInput.addEventListener('change', handleCSVUpload);
            const importInput = document.getElementById('import-leaderboard-input');
            if (importInput) importInput.addEventListener('change', handleLeaderboardImport);
            
            if (stageSelect) stageSelect.addEventListener('change', () => { populateLevelSelect(); if (levelSelect.value) { gameState.currentLevelIndex = parseInt(levelSelect.value, 10); } updateHomeUI(); }); 
            if (levelSelect) levelSelect.addEventListener('change', (e) => { gameState.currentLevelIndex = parseInt(e.target.value, 10); updateHomeUI(); });
            if (confirmYes) { confirmYes.addEventListener('click', () => { if (onConfirmCallback) { onConfirmCallback(); } onConfirmCallback = null; confirmModal.classList.add('hidden'); }); }
            if (confirmNo) { confirmNo.addEventListener('click', () => { onConfirmCallback = null; confirmModal.classList.add('hidden'); }); }
        }
        
        // ... (Export/Import leaderboard logic remains same) ...

        function exportLeaderboard() {
            if (!gameState.leaderboard || Object.keys(gameState.leaderboard).length === 0) return;
            const blob = new Blob([JSON.stringify(gameState.leaderboard, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${currentMode}_leaderboard.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function handleLeaderboardImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    showConfirm(`Timpa leaderboard ${currentMode.toUpperCase()} dengan data baru?`, () => { gameState.leaderboard = importedData; saveLeaderboard(); }, 'Import Data?');
                } catch (err) {}
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // ... (Connection methods: connectToServer, tryIndoFinityConnection, tryTikTokConnectionAttempt, setupServerListeners, handleDisconnect remains same) ...
        
        function connectToServer(isManualReconnect = false) {
            if (!isAuthenticated) return; 
            const type = connectionTypeSelect.value;
            let uniqueId = connectionUniqueId.value.trim();
            const host = getDynamicIP();
            if (type === 'tiktok-connector' && !uniqueId) { serverStatus.textContent = 'Username TikTok kosong!'; serverStatus.classList.add('text-red-600'); return; }
            if (isReconnecting && !isManualReconnect) return;
            isReconnecting = true; 
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); currentConnection = null; }
            connectButton.disabled = true; disconnectButton.classList.add('hidden'); startGameButton.disabled = true;
            serverStatus.classList.remove('text-red-600', 'text-green-600');
            
            if (type === 'tiktok-connector') {
                serverStatus.textContent = `Menghubungkan ke @${uniqueId}...`;
                currentServerIndex = 0; 
                tryTikTokConnectionAttempt(currentServerIndex, uniqueId);
            } else if (type === 'indofinity-ws') {
                currentConnection = new IndoFinityWSConnection(uniqueId || host); 
                serverStatus.textContent = `Menghubungkan WS...`;
                tryIndoFinityConnection(currentConnection, uniqueId);
            } else if (type === 'indofinity-socketio') {
                currentConnection = new IndoFinityIOConnection(uniqueId || host); 
                serverStatus.textContent = `Menghubungkan IO...`;
                tryIndoFinityConnection(currentConnection, uniqueId);
            }
        }

        function tryIndoFinityConnection(connectionInstance, uniqueId) {
            connectionInstance.connect(uniqueId, {}).then(() => {
                isReconnecting = false; 
                serverStatus.textContent = `Terhubung!`; serverStatus.classList.add('text-green-600');
                startGameButton.disabled = false;
                connectButton.classList.add('hidden'); disconnectButton.classList.remove('hidden');
                if (disconnectNotification) disconnectNotification.classList.add('hidden');
                setupServerListeners(connectionInstance);
            }).catch(err => { 
                isReconnecting = false; serverStatus.textContent = `Koneksi Gagal.`; serverStatus.classList.add('text-red-600');
                connectButton.disabled = false; startGameButton.disabled = true;
                if(gameState.isGameActive) { disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.remove('hidden'); }
                currentConnection = null;
            });
        }
        
        function tryTikTokConnectionAttempt(index, uniqueId) {
            currentServerIndex = index;
            if (index >= TIKTOK_SERVERS.length) {
                const errorMsg = 'Gagal terhubung ke semua server TikTok.';
                serverStatus.textContent = errorMsg; serverStatus.classList.add('text-red-600');
                connectButton.disabled = false; startGameButton.disabled = false;
                if(disconnectReason) disconnectReason.textContent = errorMsg;
                if(gameState.isGameActive) { disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.remove('hidden'); }
                isReconnecting = false; return;
            }
            serverStatus.textContent = `Mencoba Server ${index + 1}/${TIKTOK_SERVERS.length}...`;
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); }
            currentConnection = new TikTokIOConnection(TIKTOK_SERVERS[index]);
            currentConnection.connect(uniqueId, { enableExtendedGiftInfo: true }).then(() => {
                isReconnecting = false; 
                serverStatus.textContent = `Terhubung ke @${uniqueId}`; serverStatus.classList.add('text-green-600');
                startGameButton.disabled = false;
                connectButton.classList.add('hidden'); disconnectButton.classList.remove('hidden');
                saveLastUsername(uniqueId);
                if (disconnectNotification) disconnectNotification.classList.add('hidden');
                setupServerListeners(currentConnection);
            }).catch(err => { tryTikTokConnectionAttempt(index + 1, uniqueId); });
        }
        
        function setupServerListeners(connection) {
            connection.on('chat', handleComment); 
            connection.on('like', handleLike); 
            connection.on('gift', handleGift);
            connection.on('disconnect', () => handleDisconnect('Koneksi terputus.')); 
            connection.on('streamEnd', () => handleDisconnect('LIVE berakhir.'));
            connection.on('tiktokDisconnected', (e) => handleDisconnect(`Server terputus: ${e}`));
        }

        function handleDisconnect(reason) {
            if (isReconnecting) return;
            isReconnecting = true; 
            if (currentConnectionType !== 'tiktok-connector') {
                 serverStatus.textContent = `Terputus: ${reason}`; serverStatus.classList.add('text-red-600');
                 connectButton.disabled = false; startGameButton.disabled = false; disconnectButton.classList.add('hidden');
                 if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); currentConnection = null; }
                 if (!gameState.isGameActive) updateHomeUI();
                 else if (disconnectNotification) { disconnectReason.textContent = reason; disconnectNotification.classList.remove('hidden'); }
                 isReconnecting = false; return;
            }
            if (!gameState.isGameActive) {
                serverStatus.textContent = reason; serverStatus.classList.add('text-red-600');
                connectButton.disabled = false; startGameButton.disabled = false;
                if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); currentConnection = null; }
                updateHomeUI(); isReconnecting = false; return;
            }
            disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.add('hidden'); 
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); }
            currentServerIndex = (currentServerIndex + 1) % TIKTOK_SERVERS.length;
            setTimeout(() => { if (!lastConnectedUsername) { goToHome(); isReconnecting = false; return; } tryTikTokConnectionAttempt(currentServerIndex, lastConnectedUsername); }, 2000);
        }

        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem(GH_CONFIG_KEY);
            if (savedConfig) { try { const parsed = JSON.parse(savedConfig); githubConfig = { ...githubConfig, ...parsed }; } catch (e) { } }
            if (ghUsernameInput) ghUsernameInput.value = githubConfig.OWNER; if (ghRepoInput) ghRepoInput.value = githubConfig.REPO; 
            // Dont overwrite PATH from saved config blindly, it is controlled by game mode now mostly
        }
        function saveGitHubConfig() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; 
            // We dont save path from input if empty, using mode default
            localStorage.setItem(GH_CONFIG_KEY, JSON.stringify(githubConfig));
        }
        function loadLastUsername() { lastConnectedUsername = localStorage.getItem(LAST_USERNAME_KEY); if (lastConnectedUsername && connectionUniqueId) { connectionUniqueId.value = lastConnectedUsername; } }
        function saveLastUsername(username) { lastConnectedUsername = username; localStorage.setItem(LAST_USERNAME_KEY, username); }

        // CSV PARSERS
        function handleCSVUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            levelUpdateStatus.textContent = "Membaca CSV...";
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parser = GAME_MODES[currentMode].parser;
                    const parsedLevels = parser(e.target.result);
                    if (parsedLevels && parsedLevels.length > 0) {
                        levelData = parsedLevels;
                        levelData.forEach((lvl, idx) => { lvl.level = idx + 1; lvl.stage = Math.floor(idx / 10) + 1; });
                        // Key includes mode to avoid collision
                        localStorage.setItem(CUSTOM_LEVEL_DATA_KEY + '_' + currentMode, JSON.stringify(levelData)); resetGameProgress(); 
                        levelUpdateStatus.textContent = `Sukses! ${parsedLevels.length} level.`;
                    } else { throw new Error("Data tidak valid."); }
                } catch (error) { levelUpdateStatus.textContent = `Gagal: ${error.message}`; }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function parseNormalCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== ''); const levels = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(','); if (cols.length < 10) continue; 
                const rawWords = cols.slice(0, 10).map(w => w.trim()).filter(w => w !== ''); if (rawWords.length === 0) continue;
                const words = []; const bonusWords = new Array(rawWords.length).fill(false);
                rawWords.forEach((rawWord, index) => {
                    if (rawWord.toUpperCase() === 'BACA CLUE') return; 
                    if (rawWord.includes('[*]')) { words.push(rawWord.replace(/\[\*\]/g, '').trim()); bonusWords[words.length - 1] = true; } else { words.push(rawWord); }
                });
                if (words.length === 0) continue;
                let clues = new Array(words.length).fill('');
                for (let j = 1; j < words.length; j++) {
                    const clueColIndex = 11 + j; 
                    if (cols[clueColIndex]) { let clue = cols[clueColIndex].trim(); if (clue && !clue.match(/\.(jpg|jpeg|png|gif)$/i)) clues[j] = clue; }
                }
                let difficulty = 'Medium'; for (let k = cols.length - 1; k >= 0; k--) { if (cols[k] && cols[k].trim() !== '') { difficulty = cols[k].trim(); break; } }
                levels.push({ difficulty, words, clues, openSlots: [0, words.length > 1 ? words.length - 1 : 0], bonusWords: bonusWords.slice(0, words.length) });
            }
            return levels;
        }

        function parseSambungCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== ''); 
            const levels = [];
            // Assuming header: SOAL,IMG BG SOAL,CLUE
            for (let i = 1; i < lines.length; i++) {
                // Handle commas inside quotes? Simple split for now as requested format seems simple
                // If SOAL contains commas, this simple split might break, but standard logic implies simple CSV
                const cols = lines[i].split(','); 
                if (cols.length < 1) continue;

                const sentence = cols[0].trim().toUpperCase();
                if (!sentence) continue;

                // Split sentence into words for the game logic
                const words = sentence.split(/\s+/).filter(w => w.length > 0);
                
                // Sambung Kata logic: Open nothing initially? Or just first word? 
                // Let's make it fully hidden or reveal first word to start context.
                // Standard: Reveal nothing or hint. Let's reveal nothing for challenge, or index 0.
                
                // Create dummy clues and bonus (no specific bonus logic in CSV provided)
                const bonusWords = new Array(words.length).fill(false);
                const clues = new Array(words.length).fill('');
                
                levels.push({
                    difficulty: 'Normal',
                    words: words,
                    clues: clues,
                    openSlots: [0], // Kata pertama terbuka
                    bonusWords: bonusWords
                });
            }
            return levels;
        }

        // ... (populateStageSelect, populateLevelSelect, updateHomeUI remains same) ...

        function populateStageSelect() {
            if (!stageSelect || !levelData || levelData.length === 0) return;
            const maxStage = levelData[levelData.length - 1].stage || 1;
            stageSelect.innerHTML = '';
            for (let i = 1; i <= maxStage; i++) {
                const option = document.createElement('option'); option.value = i;
                option.textContent = `Stage ${i} (Level ${(i - 1) * 10 + 1}-${Math.min(i * 10, levelData.length)})`;
                stageSelect.appendChild(option);
            }
            stageSelect.value = levelData[gameState.currentLevelIndex]?.stage || 1; stageSelect.disabled = false;
        }

        function populateLevelSelect() {
            if (!levelSelect) return;
            levelSelect.innerHTML = '';
            if (!levelData || levelData.length === 0) { levelSelect.innerHTML = '<option value="0">Kosong</option>'; levelSelect.disabled = true; stageSelect.disabled = true; return; }
            const selectedStage = parseInt(stageSelect.value, 10) || 1;
            const filteredLevels = levelData.map((lvl, idx) => ({...lvl, originalIndex: idx})).filter(lvl => lvl.stage === selectedStage);
            filteredLevels.forEach((level) => {
                const option = document.createElement('option'); option.value = level.originalIndex; 
                option.textContent = `Level ${level.level} (${level.words.length} Kata)`;
                levelSelect.appendChild(option);
            });
            levelSelect.disabled = false;
            levelSelect.value = filteredLevels.some(lvl => lvl.originalIndex === gameState.currentLevelIndex) ? gameState.currentLevelIndex : filteredLevels[0]?.originalIndex || 0;
        }

        function updateHomeUI() {
            if (!isAuthenticated || !startGameButton || !gameStatus) return;
            if (!levelData || levelData.length === 0) { 
                startGameButton.textContent = 'Data Soal Kosong'; startGameButton.disabled = true; return; 
            }
            if (levelSelect && levelSelect.options.length > 0 && levelSelect.options[0].value === '0') { 
                populateStageSelect(); populateLevelSelect(); 
                if (levelSelect.value) { gameState.currentLevelIndex = parseInt(levelSelect.value, 10); }
            }
            if (gameState.currentLevelIndex >= levelData.length || gameState.currentLevelIndex < 0) gameState.currentLevelIndex = 0;
            let currentLevel = levelData[gameState.currentLevelIndex];
            if (!currentLevel) { gameState.currentLevelIndex = 0; currentLevel = levelData[0]; }
            const isSimMode = currentConnection == null;
            if (gameState.isGameActive && gameState.revealedWords.some(w => w !== null)) {
                startGameButton.textContent = `LANJUT LEVEL ${currentLevel.level}`; gameStatus.textContent = `Main: S${currentLevel.stage} - L${currentLevel.level}`;
                if(endSessionButton) endSessionButton.classList.remove('hidden');
            } else {
                if (stageSelect && currentLevel.stage && parseInt(stageSelect.value) !== currentLevel.stage) { stageSelect.value = currentLevel.stage; populateLevelSelect(); }
                if (levelSelect && parseInt(levelSelect.value) !== gameState.currentLevelIndex) levelSelect.value = gameState.currentLevelIndex;
                startGameButton.textContent = isSimMode ? 'MULAI (MODE SIMULASI)' : 'MULAI GAME!'; 
                gameStatus.textContent = `Mulai: S${currentLevel.stage} - L${currentLevel.level}`;
                if(endSessionButton) endSessionButton.classList.add('hidden');
            }
            if (isReconnecting) { startGameButton.disabled = true; startGameButton.textContent = 'Menghubungkan...'; startGameButton.classList.add('opacity-75', 'cursor-not-allowed');
            } else { startGameButton.disabled = false; startGameButton.classList.remove('opacity-75', 'cursor-not-allowed'); }
        }

        // ... (Game Logic: startOrContinueGame, loadLevel, updateNextSlotToGuess, loadNextLevel, goToHome) ...

        function startOrContinueGame() {
            if (!isAuthenticated || isProcessingWin) return;
            let shouldReset = false;
            if (levelSelect && !levelSelect.disabled) {
                const selectedLevelIndex = parseInt(levelSelect.value, 10);
                if (selectedLevelIndex !== gameState.currentLevelIndex || !gameState.isGameActive) { gameState.currentLevelIndex = selectedLevelIndex; shouldReset = true; }
            }
            gameState.isGameActive = true; isProcessingWin = false;
            loadLevel(gameState.currentLevelIndex, shouldReset);
        }

        function loadLevel(levelIndex, forceReset = false) {
            if (levelIndex >= levelData.length) levelIndex = 0;
            gameState.currentLevelIndex = levelIndex; const level = levelData[levelIndex];
            
            if (nextLevelCountdownInterval) clearInterval(nextLevelCountdownInterval);

            if (forceReset || gameState.revealedWords.length !== level.words.length || !gameState.isGameActive) {
                stopWordTimer(); 
                if (leaderboardScrollInterval) clearInterval(leaderboardScrollInterval);
                gameState.isRoundClosing = false;
                gameState.roundWinners = [];
                gameState.levelScores = {}; 
                gameState.isLevelComplete = false; isProcessingWin = false; gameState.currentHints = []; gameState.wordTimerRemaining = WORD_TIMER_DURATION; gameState.isAcceptingGuesses = false; 
                gameState.revealedWords = new Array(level.words.length).fill(null);
                
                // Open predefined slots
                (level.openSlots || []).forEach(index => { 
                    if (index < level.words.length) gameState.revealedWords[index] = { word: level.words[index], solver: { nickname: 'SISTEM', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } }; 
                });
                
                // For Sambung Kata, if no slots open, maybe open the first one to give context?
                // Standard sentence builder usually gives first word. 
                if (currentMode === 'sambung' && gameState.revealedWords.every(w => w === null)) {
                     gameState.revealedWords[0] = { word: level.words[0], solver: { nickname: 'CLUE', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=C' } }; 
                }

                gameState.nextSlotToGuess = gameState.revealedWords.findIndex(word => word === null);
                
                readyOverlay.classList.remove('hidden');
                let count = 3;
                countdownNumberEl.textContent = count;
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownNumberEl.textContent = count;
                        audioManager.play('pop'); 
                    } else {
                        clearInterval(countdownInterval); readyOverlay.classList.add('hidden');
                        audioManager.play('pop'); 
                        if (gameState.isGameActive) { gameState.isAcceptingGuesses = true; updateNextSlotToGuess(); }
                    }
                }, 1000);
            } else if (gameState.nextSlotToGuess === -1 && !gameState.isLevelComplete) { gameState.isLevelComplete = true; showWinModal(); }
            if (simContainer) simContainer.classList.toggle('hidden', currentConnection != null);
            if (winModal && !gameState.isLevelComplete) winModal.classList.add('hidden');
            showPage('game'); 
            renderGameUI(); 
            // Auto scroll logic (mostly for Berkait)
            setTimeout(() => {
                const container = document.getElementById('word-list-container');
                const activeIndex = gameState.nextSlotToGuess !== -1 ? gameState.nextSlotToGuess : 0;
                const el = document.getElementById(`slot-${activeIndex}`);
                if (container && el && currentMode === 'berkait') { // Only auto scroll vertical lists
                    const containerHeight = container.clientHeight; const elTop = el.offsetTop; const elHeight = el.clientHeight;
                    let targetScrollTop = elTop - (containerHeight / 2) + (elHeight / 2);
                    if (activeIndex > 0) { targetScrollTop = targetScrollTop - (containerHeight * 0.15); }
                    container.scrollTo({ top: targetScrollTop, behavior: 'smooth' });
                }
            }, 150); 
            saveState();
        }
        
        function updateNextSlotToGuess() {
            if (isProcessingWin || (gameState.isLevelComplete && winModal && !winModal.classList.contains('hidden'))) return;
            const nextIndex = gameState.revealedWords.findIndex(word => word === null); gameState.nextSlotToGuess = nextIndex;
            if (nextIndex === -1 && gameState.isGameActive && !gameState.isLevelComplete) {
                stopWordTimer(); 
                gameState.isLevelComplete = true; isProcessingWin = true; gameState.isAcceptingGuesses = false; 
                setTimeout(() => {
                    if (!gameState.isGameActive) return; 
                    stickerOverlay.classList.remove('hidden'); stickerContent.classList.add('sticker-animate');
                    audioManager.play('win'); 
                    audioManager.play('mantap'); 
                    setTimeout(() => {
                        stickerOverlay.classList.add('hidden'); stickerContent.classList.remove('sticker-animate'); showWinModal(); isProcessingWin = false; 
                    }, 3000);
                }, 2000);
            } else if (nextIndex !== -1) { startWordTimer(); }
        }
        function loadNextLevel() { gameState.revealedWords = []; isProcessingWin = false; loadLevel(gameState.currentLevelIndex + 1); }
        function goToHome() { 
            stopWordTimer(); 
            showPage('home'); updateHomeUI(); 
        }

        // ... (handleLike, handleGift, renderTopLikers, renderTopGifters, autoScroll logic) ...

        function handleLike(data) {
            if (data.msgId) { if (processedPacketIds.has(data.msgId)) return; processedPacketIds.add(data.msgId); }
            if (!gameState.isGameActive) return;
            const { uniqueId, nickname, profilePictureUrl, likeCount } = data;
            if (!gameState.topLikers[uniqueId]) gameState.topLikers[uniqueId] = { totalLikes: 0, nickname, profilePictureUrl };
            gameState.topLikers[uniqueId].totalLikes += likeCount; gameState.topLikers[uniqueId].nickname = nickname; gameState.topLikers[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopLikers(); renderTopLikers();
        }

        function handleGift(data) {
            const packetId = data.msgId || data.id || `synth_${data.uniqueId}_${data.giftName}_${data.repeatCount}_${Date.now()}`;
            if (packetId) { if (processedPacketIds.has(packetId)) return; processedPacketIds.add(packetId); }
            if (!gameState.isGameActive) return;
            
            const giftKey = `${data.uniqueId}_${data.giftName || 'Unknown'}`;
            const repeatCount = parseInt(data.repeatCount || data.repeat_count || 1);
            const diamondsPerItem = parseInt(data.diamondCount || (data.extendedGiftInfo ? data.extendedGiftInfo.diamond_count : 0) || 1);
            let effectiveCountToAdd = 0;
            const now = Date.now();
            const lastTime = giftTimeTracker.get(giftKey) || 0;

            if (streakTracker.has(giftKey)) {
                const lastCount = streakTracker.get(giftKey);
                if (repeatCount > lastCount) { effectiveCountToAdd = repeatCount - lastCount; streakTracker.set(giftKey, repeatCount); giftTimeTracker.set(giftKey, now); } 
                else if (repeatCount < lastCount) { effectiveCountToAdd = repeatCount; streakTracker.set(giftKey, repeatCount); giftTimeTracker.set(giftKey, now); } 
                else { if (now - lastTime < 5000) return; effectiveCountToAdd = repeatCount; streakTracker.set(giftKey, repeatCount); giftTimeTracker.set(giftKey, now); }
            } else { effectiveCountToAdd = repeatCount; streakTracker.set(giftKey, repeatCount); giftTimeTracker.set(giftKey, now); }

            if (effectiveCountToAdd <= 0) return;
            const effectiveCoins = effectiveCountToAdd * diamondsPerItem;
            
            audioManager.play('gift');

            const giftName = data.giftName || 'Hadiah'; const { uniqueId, nickname, profilePictureUrl } = data;
             if (!gameState.topGifters[uniqueId]) gameState.topGifters[uniqueId] = { totalDiamonds: 0, nickname, profilePictureUrl };
            gameState.topGifters[uniqueId].totalDiamonds += effectiveCoins; gameState.topGifters[uniqueId].nickname = nickname; gameState.topGifters[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopGifters(); renderTopGifters();
            if (!gameState.leaderboard[uniqueId]) { gameState.leaderboard[uniqueId] = { score: 0, coins: 0, nickname: nickname, profilePic: profilePictureUrl }; }
            gameState.leaderboard[uniqueId].coins = (gameState.leaderboard[uniqueId].coins || 0) + effectiveCoins;
            gameState.leaderboard[uniqueId].nickname = nickname; gameState.leaderboard[uniqueId].profilePic = profilePictureUrl; saveLeaderboard(); 
            giftQueue.push({ nickname, profilePictureUrl, giftName, uniqueId, amount: effectiveCoins });
            processGiftQueue();
            
            if (gameState.isGameActive && !gameState.isLevelComplete && gameState.nextSlotToGuess !== -1) {
                const correctWord = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
                const lettersToFind = correctWord.slice(1).split(''); 
                let unrevealedLetters = lettersToFind.filter(l => !gameState.currentHints.includes(l));
                const lettersToRevealCount = Math.min(effectiveCoins, unrevealedLetters.length, 10); 
                if (lettersToRevealCount > 0) {
                    const newHintsAdded = [];
                    for (let i = 0; i < lettersToRevealCount; i++) {
                        unrevealedLetters = lettersToFind.filter(l => !gameState.currentHints.includes(l));
                        if (unrevealedLetters.length === 0) break;
                        const randomIndex = Math.floor(Math.random() * unrevealedLetters.length);
                        const newHintLetter = unrevealedLetters[randomIndex];
                        gameState.currentHints.push(newHintLetter); newHintsAdded.push(newHintLetter);
                    }
                    saveState(); renderSingleSlot(gameState.nextSlotToGuess, null);
                    const hintListStr = newHintsAdded.join(', ');
                    createToast(`<img src="${profilePictureUrl||'https://placehold.co/40x40/A855F7/FFFFFF?text=G'}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm" onerror="this.src='https://placehold.co/40x40/A855F7/FFFFFF?text=G'"><div class="flex-grow overflow-hidden"><p class="font-bold text-white truncate text-shadow-sm">${(nickname||'Sultan').replace(/</g,"&lt;")}</p><p class="text-sm text-purple-100 font-medium">Kirim ${effectiveCoins} <img src="${ROSE_URL}" class="w-3.5 h-3.5 inline mb-0.5">! Buka: <span class="font-bold text-yellow-300">${hintListStr}</span></p></div>`, 'system');
                }
            }
            
            if (gameState.isLevelComplete && winModal && !winModal.classList.contains('hidden') && gameState.nextLevelTimerRemaining > 0) {
                const secondsToSkip = effectiveCoins * 5; 
                gameState.nextLevelTimerRemaining -= secondsToSkip;
                if (gameState.nextLevelTimerRemaining < 0) gameState.nextLevelTimerRemaining = 0;
                updateNextLevelUI(); 
                createToast(`<div class="flex-grow"><p class="font-bold text-white">SPEED UP! ðŸš€</p><p class="text-sm text-yellow-100">Waktu dipotong ${secondsToSkip} detik!</p></div>`, 'system');
                if (gameState.nextLevelTimerRemaining <= 0) {
                    if (nextLevelCountdownInterval) clearInterval(nextLevelCountdownInterval);
                    loadNextLevel();
                }
            }
        }

        // ... (updateNextLevelUI, startNextLevelCountdown, processGiftQueue, renderTopLikers, renderTopGifters, createRankItemHorizontalHTML, startAutoScroll) ...

        function updateNextLevelUI() {
            const progressBar = document.getElementById('next-level-progress-bar');
            const progressText = document.getElementById('next-level-text');
            const statusText = document.getElementById('timer-status-text');
            if (progressText) progressText.textContent = `${gameState.nextLevelTimerRemaining} Detik`;
            if (statusText) {
                if (gameState.nextLevelTimerRemaining < 5) statusText.innerHTML = `<span class="text-red-500 animate-pulse">Memulai...</span>`;
                else statusText.innerHTML = `<img src="${ROSE_URL}" class="w-3.5 h-3.5 inline mr-1"> = Percepat! ðŸš€`;
            }
            if (progressBar) {
                const percent = ((NEXT_LEVEL_DELAY_SECONDS - gameState.nextLevelTimerRemaining) / NEXT_LEVEL_DELAY_SECONDS) * 100;
                progressBar.style.width = `${percent}%`;
            }
        }
        function startNextLevelCountdown() {
            if (nextLevelCountdownInterval) clearInterval(nextLevelCountdownInterval);
            if (gameState.currentLevelIndex >= levelData.length - 1) return;
            gameState.nextLevelTimerRemaining = NEXT_LEVEL_DELAY_SECONDS;
            updateNextLevelUI();
            nextLevelCountdownInterval = setInterval(() => {
                gameState.nextLevelTimerRemaining--;
                updateNextLevelUI();
                if (gameState.nextLevelTimerRemaining <= 0) {
                    clearInterval(nextLevelCountdownInterval);
                    loadNextLevel();
                }
            }, 1000);
        }
        function processGiftQueue() {
            if (isGiftOverlayShowing || giftQueue.length === 0) return;
            isGiftOverlayShowing = true; const giftData = giftQueue.shift();
            giftUserPic.src = giftData.profilePictureUrl; giftUserName.textContent = giftData.nickname; giftNameEl.textContent = giftData.giftName; 
            giftOverlay.classList.remove('hidden'); giftCard.classList.remove('gift-out'); giftCard.classList.add('gift-in');
            setTimeout(() => { 
                giftCard.classList.remove('gift-in'); giftCard.classList.add('gift-out'); 
                setTimeout(() => { giftOverlay.classList.add('hidden'); isGiftOverlayShowing = false; processGiftQueue(); }, 500); 
            }, 3000); 
        }
        function renderTopLikers() {
            if (!topLikersList) return;
            const sorted = Object.values(gameState.topLikers).sort((a, b) => b.totalLikes - a.totalLikes).slice(0, 10);
            if (sorted.length === 0) { topLikersList.innerHTML = '<p class="text-white/50 text-[10px] italic">Belum ada like...</p>'; if (likerScrollInterval) clearInterval(likerScrollInterval); likerScrollInterval = null; return; }
            let html = sorted.map((liker, i) => createRankItemHorizontalHTML(liker, i, 'like')).join(''); html += html; 
            topLikersList.innerHTML = html; lucide.createIcons();
            likerScrollInterval = startAutoScroll('top-likers-list', likerScrollInterval);
        }
        function renderTopGifters() {
            if (!topGiftersList) return;
            const sorted = Object.values(gameState.topGifters).sort((a, b) => b.totalDiamonds - a.totalDiamonds).slice(0, 10);
            if (sorted.length === 0) { topGiftersList.innerHTML = '<p class="text-white/50 text-[10px] italic">Belum ada gift...</p>'; if (gifterScrollInterval) clearInterval(gifterScrollInterval); gifterScrollInterval = null; return; }
            let html = sorted.map((gifter, i) => createRankItemHorizontalHTML(gifter, i, 'gift')).join(''); html += html; 
            topGiftersList.innerHTML = html; lucide.createIcons();
            gifterScrollInterval = startAutoScroll('top-gifters-list', gifterScrollInterval);
        }
         function createRankItemHorizontalHTML(user, index, type) {
             const isTop = index === 0; const value = type === 'like' ? user.totalLikes.toLocaleString() : user.totalDiamonds.toLocaleString();
             const colorClass = type === 'like' ? 'pink' : 'indigo'; const crownColor = type === 'like' ? 'text-yellow-400' : 'text-indigo-300';
             return `<div class="flex items-center gap-1.5 bg-white/10 px-2 py-0.5 rounded-full border border-white/10 shrink-0">${isTop ? `<span class="${crownColor} text-sm">ðŸ‘‘</span>` : `<span class="text-[10px] font-bold text-${colorClass}-300">#${index+1}</span>`}<img src="${user.profilePictureUrl}" class="w-5 h-5 rounded-full border border-white/30" onerror="this.src='https://placehold.co/40x40/FFFFFF/000000?text=?'"><span class="text-white text-[11px] font-medium truncate max-w-[80px]">${user.nickname.replace(/</g,"&lt;")}</span><span class="text-${colorClass}-200 text-[10px] font-bold flex items-center gap-0.5">(${value})</span></div>`;
        }
        function startAutoScroll(elementId, intervalVar) {
            if (intervalVar) clearInterval(intervalVar);
            const el = document.getElementById(elementId); if (!el) return null;
            let pos = 0; const speed = 0.5;
            return setInterval(() => {
                if (!el.parentElement) return;
                const contentWidth = el.scrollWidth; const viewportWidth = el.parentElement.clientWidth; const singleCopyWidth = contentWidth / 2;
                if (singleCopyWidth > viewportWidth) { pos += speed; if (pos >= singleCopyWidth) { pos = 0; } el.style.transform = `translateX(${-pos}px)`; } else { pos = 0; el.style.transform = `translateX(0px)`; }
            }, 30);
        }
        
        // ... (handleComment, processChatQueue, updateConnectionHealthUI, processSingleComment) ...

        function handleComment(msg) {
            if (chatQueue.length < MAX_QUEUE_SIZE) { chatQueue.push(msg); } 
            else {
                const currentAnswer = levelData[gameState.currentLevelIndex]?.words[gameState.nextSlotToGuess];
                if (currentAnswer && msg.comment.trim().toUpperCase().replace(/\s+/g, '') === currentAnswer) { chatQueue.push(msg); }
            }
            const dot = document.getElementById('ping-dot');
            if (dot) { dot.classList.add('bg-green-400'); setTimeout(() => dot.classList.remove('bg-green-400'), 100); }
        }

        function processChatQueue() {
            if (chatQueue.length === 0 || !gameState.isGameActive) return;
            const batch = chatQueue.splice(0, CHAT_PROCESS_RATE);
            batch.forEach(msg => { processSingleComment(msg); });
        }
        
        function updateConnectionHealthUI() {
            const dot = document.getElementById('ping-dot'); const queueText = document.getElementById('queue-count');
            if (!dot || !queueText) return;
            queueText.textContent = chatQueue.length > 99 ? '99+' : chatQueue.length;
            if (currentConnection) {
                if (chatQueue.length > 100) dot.className = "w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse";
                else dot.className = "w-2.5 h-2.5 rounded-full bg-green-500";
            } else dot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
        }

        function processSingleComment(msg) {
            if (msg.msgId) { if (processedPacketIds.has(msg.msgId)) return; processedPacketIds.add(msg.msgId); }
            const comment = msg.comment.trim().toUpperCase().replace(/\s+/g, '');
            const isHost = (currentConnection && msg.uniqueId && currentConnection.uniqueId && msg.uniqueId.toLowerCase() === currentConnection.uniqueId.toLowerCase()) || (msg.uniqueId === 'simulator_user_id');
            
            if (comment === '!RESET' && isHost) { loadLevel(gameState.currentLevelIndex, true); return; }
            if (comment === '!MYRANK') {
                const uid = msg.uniqueId; const user = gameState.leaderboard[uid];
                if (!user) { if(Math.random() > 0.7) return; createToast(`<div class="flex items-center gap-3"><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white border border-white/30"><i data-lucide="user-x" class="w-5 h-5"></i></div><div class="flex-grow"><p class="font-bold text-white text-sm">Belum Ada Rank</p><p class="text-xs text-blue-100">Ayo main biar masuk leaderboard!</p></div></div>`, 'system'); lucide.createIcons(); return; }
                 const sortedPlayers = Object.entries(gameState.leaderboard).sort(([, a], [, b]) => b.score - a.score);
                const rankIndex = sortedPlayers.findIndex(([id]) => id === uid); const rank = rankIndex + 1; const isTop3 = rank <= 3;
                createToast(`<div class="flex items-center gap-3 w-full"><div class="relative flex-shrink-0"><img src="${user.profilePic || 'https://placehold.co/40x40/94A3B8/FFFFFF?text=?'}" class="w-12 h-12 rounded-full border-2 ${isTop3 ? 'border-yellow-300' : 'border-white'} shadow-md object-cover"><div class="absolute -bottom-1 -right-1 ${isTop3 ? 'bg-yellow-500' : 'bg-slate-700'} text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm">#${rank}</div></div><div class="flex-grow min-w-0 overflow-hidden"><p class="font-bold text-white text-sm truncate">${user.nickname.replace(/</g,"&lt;")}</p><div class="flex items-center gap-2 text-xs text-blue-50 mt-0.5"><span class="bg-black/20 px-1.5 py-0.5 rounded font-mono font-bold">${user.score} PTS</span>${user.coins > 0 ? `<span class="flex items-center gap-0.5 text-yellow-300 font-bold"> ${user.coins}</span>` : ''}</div></div>${isTop3 ? '<i data-lucide="crown" class="w-5 h-5 text-yellow-300 animate-bounce-slow flex-shrink-0"></i>' : ''}</div>`,'system');
                lucide.createIcons(); return;
            }
            
            if (!gameState.isAcceptingGuesses || gameState.isLevelComplete || gameState.nextSlotToGuess === -1) { if (!gameState.isRoundClosing) { if (comment !== '!HINT' || !gameState.isGameActive) return; } }
            if (comment === '!SKIP' && isHost) {
                stopWordTimer(); const idx = gameState.nextSlotToGuess; gameState.revealedWords[idx] = { word: levelData[gameState.currentLevelIndex].words[idx], solver: { nickname: 'Host Skip', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } };
                createToast(`<div class="flex-grow"><p class="font-bold text-white">Host</p><p class="text-sm text-blue-100">Skip kata!</p></div>`, 'system');
                updateNextSlotToGuess(); saveState(); renderSingleSlot(idx, gameState.revealedWords[idx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null); return;
            }

            const correct = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
            if (comment === correct) {
                if (!gameState.isRoundClosing) startClosingRound(msg, correct);
                else { const alreadyWon = gameState.roundWinners.some(w => w.uniqueId === msg.uniqueId); if (!alreadyWon) addAdditionalWinner(msg); }
            } else { 
                if (!gameState.isRoundClosing && !gameState.revealedWords.filter(d=>d).map(d=>d.word).includes(comment)) {
                    const threshold = chatQueue.length > 50 ? 0 : 10;
                    if (chatQueue.length <= threshold) showIncorrectToast(msg);
                }
            }
        }
        
        // ... (startClosingRound, addAdditionalWinner, finalizeRound, renderGameUI, renderSingleSlot, showWinModal, renderRankings, createListItem, showCorrectToast, showIncorrectToast, createToast, addScore, stopWordTimer, startWordTimer, handleAutoSkip) ...

        function startClosingRound(msg, correctWord) {
            gameState.isRoundClosing = true; gameState.roundWinners = []; stopWordTimer();
            audioManager.play('correct');

            const isBonus = levelData[gameState.currentLevelIndex].bonusWords[gameState.nextSlotToGuess];
            const points = isBonus ? 20 : 10;
            gameState.roundWinners.push({ uniqueId: msg.uniqueId, nickname: msg.nickname || 'Anonim', profilePic: msg.profilePictureUrl, points: points });

            if (msg.uniqueId) addScore(msg.uniqueId, msg.nickname || 'Anonim', msg.profilePictureUrl || '', points);
            showCorrectToast(msg, points, isBonus);

            const slotEl = document.getElementById(`slot-${gameState.nextSlotToGuess}`);
            if (slotEl) {
                // Update based on layout mode
                const box = slotEl.querySelector('.slot-active-box') || slotEl; // Fallback for simple layouts
                if (box) {
                    box.classList.add('bg-green-100', 'border-green-400'); box.classList.remove('bg-amber-100', 'border-amber-300');
                    const textEl = box.querySelector('span.font-bold');
                    if(textEl) textEl.innerHTML = `<span class="text-green-700">${correctWord}</span> <span class="text-xs ml-2 text-green-600 animate-pulse">(GAS)</span>`;
                }
            }
            setTimeout(() => { finalizeRound(); }, WIN_WINDOW_DURATION);
        }

        function addAdditionalWinner(msg) {
            const isBonus = levelData[gameState.currentLevelIndex].bonusWords[gameState.nextSlotToGuess];
            const points = isBonus ? 10 : 5; 
            gameState.roundWinners.push({ uniqueId: msg.uniqueId, nickname: msg.nickname, profilePic: msg.profilePictureUrl, points: points });
            addScore(msg.uniqueId, msg.nickname || 'Anonim', msg.profilePictureUrl || '', points);
            audioManager.play('pop');
            
            createToast(`<div class="flex items-center gap-2"><div class="bg-green-500 text-white rounded-full p-1"><i data-lucide="check" class="w-4 h-4"></i></div><div class="flex-grow"><p class="font-bold text-white text-sm">${msg.nickname}</p><p class="text-xs text-yellow-100 font-bold">BENAR JUGA! +${points} POIN</p></div></div>`, 'correct'); 
            lucide.createIcons();
        }

        function finalizeRound() {
            if (!gameState.isGameActive) return;
            const correctWord = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
            const firstWinner = gameState.roundWinners[0];
            const totalWinners = gameState.roundWinners.length;
            gameState.revealedWords[gameState.nextSlotToGuess] = { word: correctWord, solver: { nickname: firstWinner.nickname, profilePic: firstWinner.profilePic }, totalWinners: totalWinners };
            if (totalWinners > 1) { createToast(`<div class="text-center w-full"><p class="font-bold text-white text-sm">ðŸ”¥ ${totalWinners} ORANG MENANG! ðŸ”¥</p><p class="text-xs text-blue-100">Juara 1 dapet full, sisanya poin gercep!</p></div>`, 'system'); }
            gameState.isRoundClosing = false; gameState.currentHints = []; 
            const solvedIdx = gameState.nextSlotToGuess; updateNextSlotToGuess(); saveState();
            renderSingleSlot(solvedIdx, gameState.revealedWords[solvedIdx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
        }

        function renderGameUI() {
            const level = levelData[gameState.currentLevelIndex];
            if (levelTitle) levelTitle.textContent = `Level ${level.level}`; if (stageInfo) stageInfo.textContent = `Stage ${level.stage}`;
            
            // Adjust Container Class based on Mode
            if (currentMode === 'sambung') {
                wordListContainer.classList.add('mode-sambung');
            } else {
                wordListContainer.classList.remove('mode-sambung');
            }

            if (wordListContainer) { 
                wordListContainer.innerHTML = ''; 
                level.words.forEach((w, i) => renderSingleSlot(i, gameState.revealedWords[i], true)); 
            }
            renderTopLikers(); renderTopGifters(); lucide.createIcons();
        }
        
        function renderSingleSlot(i, data, init = false) {
            const level = levelData[gameState.currentLevelIndex];
            let el = document.getElementById(`slot-${i}`);
            if (!el && init) { el = document.createElement('div'); el.id = `slot-${i}`; wordListContainer.appendChild(el); }
            if (!el) return;
            
            // Layout Adjustments based on Mode
            el.className = currentMode === 'sambung' ? "word-item transition-all duration-300" : "flex items-center gap-2 opacity-90 pop-in w-full mb-2";

            if (data) {
                // REVEALED
                if (currentMode === 'sambung') {
                    // Sambung Kata: Rapi & Sejajar (Updated Border)
                    el.className = "word-item pop-in";
                    el.innerHTML = `
                        <div class="sambung-box bg-white border-2 border-slate-300 shadow-sm hover:scale-105">
                            <span class="font-bold text-slate-800 text-lg leading-none mb-0.5">${data.word}</span>
                            <div class="bg-slate-100 px-2 py-0.5 rounded-full max-w-[60px]">
                                <span class="text-[9px] text-slate-500 font-bold truncate block">${data.solver.nickname.replace(/</g,"&lt;")}</span>
                            </div>
                        </div>`;
                } else {
                    // Kata Berkait: Full detail row
                    el.className = "flex items-center gap-2 opacity-90 pop-in w-full mb-2"; 
                    el.innerHTML = `<span class="flex-shrink-0 flex items-center justify-center w-9 h-9 rounded-full bg-white text-slate-800 font-bold text-base shadow-md">${i+1}</span>
                        <div class="flex-grow bg-white p-2.5 rounded-xl word-slot-shadow border border-slate-100 ${level.bonusWords[i]?'ring-2 ring-yellow-400':''}">
                            <div class="flex justify-between items-center flex-wrap gap-1"><span class="font-bold text-lg text-slate-800">${data.word}</span>
                                <div class="flex items-center gap-1.5 bg-slate-50 px-1.5 py-0.5 rounded-full"><span class="text-xs font-medium text-slate-600 truncate max-w-[100px] text-right">${data.solver.nickname.replace(/</g,"&lt;")}</span><img src="${data.solver.profilePic||'https://placehold.co/40x40/4ADE80/14532D?text=:)'}" class="w-5 h-5 rounded-full border border-slate-200" onerror="this.src='https://placehold.co/40x40/4ADE80/14532D?text=:)'"></div></div></div>`;
                }
            } else if (i === gameState.nextSlotToGuess) {
                // ACTIVE GUESS
                const clue = (level.difficulty||'').toLowerCase()==='sulit'?'':(level.clues[i]||'Tebak!');
                const word = level.words[i];
                
                // Build Hint Text
                let hintText = '';
                if (currentMode === 'sambung') {
                    // Compact hint for sentence flow
                    for (let j = 0; j < word.length; j++) {
                        const char = word[j];
                         if (gameState.currentHints.includes(char) || j < 2) hintText += `<span class="text-amber-800">${char}</span>`;
                         else hintText += `<span class="opacity-30">_</span>`;
                    }
                    el.className = "word-item pop-in scale-105 z-10";
                    el.innerHTML = `
                         <div class="sambung-box bg-amber-100 border-2 border-amber-400 shadow-md animate-pulse">
                            <span class="font-bold text-amber-900 text-lg tracking-widest leading-none">${hintText}</span>
                            <span class="text-[8px] text-amber-700 font-extrabold uppercase mt-1 tracking-wide">GILIRANMU</span>
                         </div>
                    `;
                } else {
                    // Detailed row for Berkait
                    hintText = `<span class="mr-1">${word[0]}</span>`; 
                    for (let j = 1; j < word.length; j++) {
                        const char = word[j];
                        if (gameState.currentHints.includes(char)) hintText += `<span class="mr-1 text-amber-800">${char}</span>`;
                        else hintText += `<span class="mr-1 opacity-50">_</span>`;
                    }
                    el.className = "flex items-center gap-3 pop-in scale-105 transition-transform w-full mb-2";
                    el.innerHTML = `<span class="flex-shrink-0 flex items-center justify-center w-12 h-12 rounded-full font-bold text-xl slot-active shadow-lg border-2 border-amber-300">${i+1}</span>
                        <div class="flex-grow flex items-center justify-between p-4 rounded-xl word-slot-shadow slot-active-box border-2 border-amber-300 relative ${level.bonusWords[i]?'bonus-slot':''}">
                            ${level.bonusWords[i]?'<i data-lucide="star" class="w-6 h-6 text-yellow-600 fill-yellow-400 animate-spin absolute top-0 right-0 -mt-2 -mr-2"></i>':''}
                            <span class="font-bold text-2xl text-amber-900 tracking-widest drop-shadow-sm flex items-center">${hintText}</span>
                            ${clue?`<span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-sm">${clue}</span>`:''}</div>`;
                }
                
                if (!init && currentMode === 'berkait') {
                    setTimeout(() => {
                        const container = document.getElementById('word-list-container');
                        if (container && el) {
                            const containerHeight = container.clientHeight; const elTop = el.offsetTop; const elHeight = el.clientHeight;
                            let targetScrollTop = elTop - (containerHeight / 2) + (elHeight / 2);
                            if (i > 0) { targetScrollTop = targetScrollTop - (containerHeight * 0.15); }
                            container.scrollTo({ top: targetScrollTop, behavior: 'smooth' });
                        }
                    }, 300);
                }
            } else {
                // LOCKED
                if (currentMode === 'sambung') {
                    el.className = "word-item opacity-60";
                    // Samakan border-2 agar tinggi konsisten
                    el.innerHTML = `
                         <div class="sambung-box bg-slate-200/80 border-2 border-slate-300/50">
                            <span class="text-slate-400 font-bold text-xl">?</span>
                         </div>
                    `;
                } else {
                    el.className = "flex items-center gap-3 opacity-75 w-full mb-2";
                    el.innerHTML = `<span class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg slot-locked">${i+1}</span><div class="flex-grow p-3 rounded-xl word-slot-shadow slot-locked-box border border-slate-400/30"><span class="font-semibold text-lg text-slate-600">Terkunci</span></div>`;
                }
            }
            if (init) lucide.createIcons(); 
            if (!data && !init) lucide.createIcons(); 
        }

        function showWinModal() { 
            if(winModal) { 
                winModal.classList.remove('hidden'); 
                
                const isLastLevel = gameState.currentLevelIndex >= levelData.length - 1;
                
                if (isLastLevel) {
                    nextLevelPrompt.classList.add('hidden');
                    allCompletePrompt.classList.remove('hidden');
                    if (nextLevelCountdownInterval) clearInterval(nextLevelCountdownInterval);
                } else {
                    nextLevelPrompt.classList.remove('hidden');
                    allCompletePrompt.classList.add('hidden');
                    startNextLevelCountdown();
                }

                const titleEl = document.getElementById('win-modal-title'); const subtitleEl = document.getElementById('win-modal-subtitle'); const wrapperEl = document.getElementById('leaderboard-wrapper'); const scrollArea = document.getElementById('modal-scroll-area');
                titleEl.textContent = "JUARA LEVEL INI"; subtitleEl.textContent = "Skor tertinggi di level ini saja";
                renderRankings(gameState.levelScores); 
                if (scrollArea) scrollArea.scrollTop = 0;
                if (autoScrollIntervalId) clearInterval(autoScrollIntervalId);
                setTimeout(() => {
                     if (scrollArea && !winModal.classList.contains('hidden')) {
                        const maxScroll = scrollArea.scrollHeight - scrollArea.clientHeight;
                        if (maxScroll > 0) {
                            let currentScroll = 0; const step = maxScroll / 400; 
                            autoScrollIntervalId = setInterval(() => { currentScroll += step; scrollArea.scrollTop = currentScroll; if (currentScroll >= maxScroll) clearInterval(autoScrollIntervalId); }, 20);
                        }
                     }
                }, 1500);
                setTimeout(() => {
                    wrapperEl.classList.add('opacity-0'); titleEl.classList.add('opacity-0'); subtitleEl.classList.add('opacity-0');
                    setTimeout(() => {
                        if (autoScrollIntervalId) clearInterval(autoScrollIntervalId);
                        
                        if (isLastLevel) {
                            titleEl.textContent = "ðŸ† LEADERBOARD FINAL ðŸ†"; 
                            subtitleEl.textContent = "Rekap Skor Akhir Permainan";
                        } else {
                            titleEl.textContent = "TOP GLOBAL"; 
                            subtitleEl.textContent = "Total akumulasi poin semua level";
                        }
                        
                        renderRankings(gameState.leaderboard, true); 
                        if (scrollArea) scrollArea.scrollTop = 0;
                        wrapperEl.classList.remove('opacity-0'); titleEl.classList.remove('opacity-0'); subtitleEl.classList.remove('opacity-0');
                    }, 500);
                }, LEVEL_LB_DURATION);
            } 
        }
        
        function renderRankings(dataObj, showCoins = false) {
            if (leaderboardScrollInterval) { clearInterval(leaderboardScrollInterval); leaderboardScrollInterval = null; }
            const container = document.getElementById('leaderboard-container'); if (!container) return;
            const sorted = Object.values(dataObj || {}).sort((a,b)=>b.score-a.score).slice(0, 50);
            if (sorted.length === 0) { container.innerHTML = '<div class="flex flex-col items-center justify-center py-10 opacity-50"><i data-lucide="users" class="w-12 h-12 mb-2 text-slate-300"></i><p class="text-sm text-slate-400 font-medium">Belum ada skor tercatat</p></div>'; lucide.createIcons(); return; }
            let html = '<div class="space-y-2.5 pb-2">';
            html += sorted.map((p, i) => createListItem(p, i + 1, showCoins)).join(''); html += '</div>';
            container.innerHTML = html; lucide.createIcons();
        }

        function createListItem(player, rank, showCoins = false) {
            let bgClass = "bg-white border-slate-100 hover:border-blue-200"; let rankBadge = `<div class="flex-shrink-0 w-6 text-center font-bold text-slate-400 text-xs font-mono">#${rank}</div>`; let crownIcon = ""; let glowEffect = ""; let avatarSize = "w-9 h-9";
            if (rank === 1) { bgClass = "bg-gradient-to-r from-yellow-50 to-white border-yellow-300 ring-1 ring-yellow-200/50"; rankBadge = `<div class="flex-shrink-0 w-7 h-7 flex items-center justify-center bg-gradient-to-br from-yellow-300 to-yellow-500 text-white text-xs font-bold rounded-full shadow-md border border-white">1</div>`; crownIcon = `<div class="absolute -top-2 -left-2 transform -rotate-12 z-20 drop-shadow-sm"><i data-lucide="crown" class="w-6 h-6 text-yellow-500 fill-yellow-400"></i></div>`; glowEffect = "shadow-[0_4px_12px_-2px_rgba(250,204,21,0.3)] z-10 scale-[1.02]"; avatarSize = "w-11 h-11 ring-2 ring-yellow-300"; } 
            else if (rank === 2) { bgClass = "bg-gradient-to-r from-slate-50 to-white border-slate-300"; rankBadge = `<div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gradient-to-br from-slate-300 to-slate-400 text-white text-xs font-bold rounded-full shadow-sm border border-white">2</div>`; avatarSize = "w-10 h-10 ring-2 ring-slate-200"; } 
            else if (rank === 3) { bgClass = "bg-gradient-to-r from-orange-50 to-white border-orange-300"; rankBadge = `<div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gradient-to-br from-orange-300 to-orange-400 text-white text-xs font-bold rounded-full shadow-sm border border-white">3</div>`; avatarSize = "w-10 h-10 ring-2 ring-orange-200"; }
            return `<div class="relative flex items-center gap-3 p-2.5 rounded-xl border ${bgClass} ${glowEffect} shadow-sm transition-all duration-300 hover:shadow-md hover:translate-x-1">${crownIcon}${rankBadge}<div class="relative flex-shrink-0"><img src="${player.profilePic}" class="${avatarSize} rounded-full border-2 border-white shadow-sm object-cover bg-slate-100" onerror="this.src='https://placehold.co/40x40/94A3B8/FFFFFF?text=?'">${rank === 1 ? '<div class="absolute -bottom-1 -right-1 bg-yellow-400 border-2 border-white p-0.5 rounded-full"><i data-lucide="star" class="w-2 h-2 text-yellow-900 fill-current"></i></div>' : ''}</div><div class="flex-grow min-w-0 flex flex-col justify-center"><p class="font-bold text-slate-800 text-sm truncate leading-tight mb-0.5">${player.nickname.replace(/</g,"&lt;")}</p>${showCoins && player.coins > 0 ? `<div class="flex items-center gap-1 text-[10px] text-yellow-600 font-bold bg-yellow-50 w-fit px-1.5 py-0.5 rounded-full border border-yellow-100"><img src="${ROSE_URL}" class="w-3 h-3"> ${player.coins}</div>` : `<div class="text-[10px] text-slate-400 font-medium truncate">Pemain</div>`}</div><div class="text-right flex-shrink-0 pl-2"><span class="font-bangers text-xl ${rank <= 3 ? 'text-blue-700 scale-110' : 'text-blue-600'} block leading-none tracking-wide">${player.score}</span><span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider opacity-80">PTS</span></div></div>`;
        }

        function showCorrectToast(msg, pts, bonus) {
            const html = `<img src="${msg.profilePictureUrl||'https://placehold.co/40x40/4ADE80/14532D?text=:)'}" class="w-12 h-12 rounded-full border-2 border-white flex-shrink-0 shadow-sm" onerror="this.src='https://placehold.co/40x40/4ADE80/14532D?text=:)'"><div class="flex-grow overflow-hidden pr-2"><p class="font-bold text-white truncate text-shadow-sm text-lg">${(msg.nickname||'Anonim').replace(/</g,"&lt;")}</p><p class="text-sm text-green-100 font-medium">${correctPhrases[Math.floor(Math.random()*correctPhrases.length)]}</p></div><div class="flex-shrink-0 font-bangers px-3 py-1 rounded-full text-xl rotate-6 shadow-md ${bonus?'bg-gradient-to-r from-yellow-300 to-amber-500 text-amber-900 animate-pulse scale-110 border-2 border-white':'bg-yellow-400 text-yellow-900'}">${bonus?'BONUS! ':''}+${pts}</div>`;
            createToast(html, 'correct');
        }

        function showIncorrectToast(msg) {
            if (toastContainer.querySelector('.toast-incorrect')) return;
            if (simCommentInput && (currentConnection == null)) { simCommentInput.classList.add('shake'); simCommentInput.addEventListener('animationend', () => simCommentInput.classList.remove('shake'), { once: true }); }
            
            audioManager.play('wrong');

            const phrase = msg.customError || incorrectPhrases[Math.floor(Math.random()*incorrectPhrases.length)];
            const html = `
                <img src="${msg.profilePictureUrl||'https://placehold.co/40x40/EF4444/7F1D1D?text=X'}" class="w-6 h-6 rounded-full border border-white flex-shrink-0 shadow-sm" onerror="this.src='https://placehold.co/40x40/EF4444/7F1D1D?text=X'">
                <div class="flex-grow overflow-hidden leading-tight">
                    <p class="font-bold text-white text-xs truncate text-shadow-sm">${(msg.nickname||'Anonim').replace(/</g,"&lt;")}</p>
                    <p class="text-[10px] text-red-100 font-medium truncate">${phrase}</p>
                </div>
            `;
            createToast(html, 'incorrect');
        }

        function createToast(html, type) {
            if (!toastContainer) return;
            const MAX_TOASTS = 3;
            while (toastContainer.children.length >= MAX_TOASTS) { toastContainer.removeChild(toastContainer.firstChild); }
            const t = document.createElement('div');
            if (type === 'incorrect') { t.className = `toast flex items-center gap-2 w-full py-1.5 px-2.5 rounded-lg shadow-md backdrop-blur-sm border border-white/10 bg-red-600/80 toast-incorrect`; } 
            else if (type === 'system') { t.className = `toast flex items-center gap-3 w-full p-3 rounded-xl shadow-lg backdrop-blur-md border border-white/10 bg-blue-500/90`; } 
            else { t.className = `toast flex items-center gap-3 w-full p-3 rounded-xl shadow-lg backdrop-blur-md border border-white/10 bg-green-500/90`; }
            t.innerHTML = html; toastContainer.appendChild(t);
            const duration = type === 'incorrect' ? 1500 : 3000;
            setTimeout(() => { if (t.parentNode) { t.classList.add('toast-out'); t.addEventListener('animationend', () => t.remove(), { once: true }); } }, duration);
        }
        
        function addScore(uid, nick, pic, pts) {
            if (!gameState.leaderboard[uid]) { gameState.leaderboard[uid] = { score: 0, coins: 0, nickname: nick, profilePic: pic }; }
            gameState.leaderboard[uid].score += pts; gameState.leaderboard[uid].nickname = nick; gameState.leaderboard[uid].profilePic = pic; saveLeaderboard();
            if (!gameState.levelScores[uid]) { gameState.levelScores[uid] = { score: 0, nickname: nick, profilePic: pic }; }
            gameState.levelScores[uid].score += pts; gameState.levelScores[uid].nickname = nick; gameState.levelScores[uid].profilePic = pic;
        }

        function stopWordTimer() {
            if (gameState.wordTimerInterval) { clearInterval(gameState.wordTimerInterval); gameState.wordTimerInterval = null; }
            const timerContainer = document.getElementById('word-timer-container'); if (timerContainer) timerContainer.style.display = 'none';
        }

        function startWordTimer() {
            stopWordTimer(); gameState.wordTimerRemaining = WORD_TIMER_DURATION;
            const timerContainer = document.getElementById('word-timer-container'); const timerDisplay = document.getElementById('word-timer-display');
            if (!timerContainer || !timerDisplay) return;
            timerContainer.style.display = 'block'; lucide.createIcons(); 
            const updateDisplay = () => {
                const minutes = Math.floor(gameState.wordTimerRemaining / 60); const seconds = gameState.wordTimerRemaining % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timerContainer.classList.toggle('text-red-400', gameState.wordTimerRemaining <= 10); 
                timerContainer.classList.toggle('animate-pulse', gameState.wordTimerRemaining <= 10); 
                timerContainer.classList.toggle('text-white', gameState.wordTimerRemaining > 10);
            };
            updateDisplay(); 
            gameState.wordTimerInterval = setInterval(() => {
                gameState.wordTimerRemaining--; updateDisplay();
                if (gameState.wordTimerRemaining <= 10 && gameState.wordTimerRemaining > 0) {
                    audioManager.play('tick');
                }
                if (gameState.wordTimerRemaining <= 0) { stopWordTimer(); handleAutoSkip(); }
            }, 1000);
        }

        function handleAutoSkip() {
            if (!gameState.isGameActive || gameState.nextSlotToGuess === -1 || gameState.isLevelComplete) return;
            const idx = gameState.nextSlotToGuess; const correctWord = levelData[gameState.currentLevelIndex].words[idx];
            gameState.revealedWords[idx] = { word: correctWord, solver: { nickname: 'WAKTU HABIS', profilePic: 'https://placehold.co/40x40/EF4444/FFFFFF?text=X' } };
            audioManager.play('wrong');
            createToast(`<i data-lucide="clock-off" class="w-10 h-10 text-red-300 flex-shrink-0"></i><div class="flex-grow overflow-hidden"><p class="font-bold text-white truncate text-shadow-sm">Waktu Habis!</p><p class="text-sm text-red-100 font-medium">Jawabannya: ${correctWord}</p></div>`, 'incorrect');
            lucide.createIcons();
            gameState.currentHints = []; const solvedIdx = gameState.nextSlotToGuess; updateNextSlotToGuess(); saveState();
            renderSingleSlot(solvedIdx, gameState.revealedWords[solvedIdx]); if (gameState.nextSlotToGuess !== -1) { renderSingleSlot(gameState.nextSlotToGuess, null); }
        }

        async function fetchAndUpdateLevels() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; 
            githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; 
            // Ensure path is consistent with mode, but respect override if manually typed? 
            // Logic: if user typed something custom, use it. But switching modes overwrites the input placeholder/value usually. 
            // Here we prioritize the Mode Config over text input for the folder path to ensure safety, unless explicitly testing.
            // Let's rely on MODE CONFIG
            githubConfig.PATH = GAME_MODES[currentMode].folder;
            
            levelUpdateStatus.textContent = `Menghubungi GitHub (${githubConfig.PATH})...`; 
            levelUpdateStatus.className = "text-center text-sm text-slate-600 h-auto min-h-[1.25rem]";
            
            try {
                const res = await fetch(`https://api.github.com/repos/${githubConfig.OWNER}/${githubConfig.REPO}/contents/${githubConfig.PATH}`);
                if (!res.ok) throw new Error(`Gagal akses GitHub: ${res.status}`);
                
                const files = (await res.json())
                    .filter(f => f.name.toLowerCase().endsWith('.csv') && f.type === 'file')
                    .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
                
                if (files.length === 0) throw new Error("Tidak ada file CSV.");
                
                levelUpdateStatus.textContent = `Mengunduh ${files.length} CSV...`;
                const data = await Promise.all(files.map(f => fetch(f.download_url).then(r => r.ok ? r.text() : Promise.reject(f.name))));
                
                let allLevels = []; 
                const parser = GAME_MODES[currentMode].parser;
                data.forEach(txt => allLevels = allLevels.concat(parser(txt)));
                
                if (allLevels.length === 0) throw new Error("Data kosong.");
                
                allLevels.forEach((l,i) => { l.level = i+1; l.stage = Math.floor(i/10)+1; });
                levelData = allLevels; 
                localStorage.setItem(CUSTOM_LEVEL_DATA_KEY + '_' + currentMode, JSON.stringify(levelData));
                
                levelUpdateStatus.textContent = `Sukses! ${levelData.length} level.`; 
                levelUpdateStatus.className = "text-center text-sm text-green-600 h-auto min-h-[1.25rem]"; 
                resetGameProgress();
            } catch (e) { 
                levelUpdateStatus.textContent = `Gagal: ${e.message||e}`; 
                levelUpdateStatus.className = "text-center text-sm text-red-600 h-auto min-h-[1.25rem]"; 
            }
        }

        function resetGameProgress() { 
            // We use different storage keys for progress if needed, but for now sharing leaderboards is fine.
            // Level progress is ephemeral or tied to STORAGE_KEY.
            // Resetting `revealedWords` etc in `gameState` is done here.
            localStorage.removeItem(STORAGE_KEY); 
            const lb = gameState.leaderboard||{}, tl = gameState.topLikers||{}, tg = gameState.topGifters||{}; 
            gameState = { 
                currentLevelIndex: 0, 
                isGameActive: false, 
                isLevelComplete: false, 
                revealedWords: [], 
                nextSlotToGuess: -1, 
                leaderboard: lb, 
                levelScores: {}, 
                topLikers: tl, 
                topGifters: tg, 
                currentHints: [], 
                wordTimerInterval: null, 
                wordTimerRemaining: WORD_TIMER_DURATION 
            }; 
            loadLeaderboard(); loadTopLikers(); loadTopGifters(); updateHomeUI(); 
        }

        // UPDATED: Now uses dynamic key based on currentMode
        function loadLeaderboard() { 
            try { 
                gameState.leaderboard = JSON.parse(localStorage.getItem(getLeaderboardKey())) || {}; 
                for (const uid in gameState.leaderboard) { 
                    if (gameState.leaderboard[uid].coins === undefined) gameState.leaderboard[uid].coins = 0; 
                } 
            } catch { gameState.leaderboard = {}; } 
        }
        function saveLeaderboard() { localStorage.setItem(getLeaderboardKey(), JSON.stringify(gameState.leaderboard)); }
        function resetLeaderboard() { 
            gameState.leaderboard = {}; 
            localStorage.removeItem(getLeaderboardKey()); 
            if(winModal && !winModal.classList.contains('hidden')) { renderRankings(gameState.leaderboard, true); } 
        }

        function loadTopLikers() { try { gameState.topLikers = JSON.parse(localStorage.getItem(getTopLikersKey())) || {}; } catch { gameState.topLikers = {}; } }
        function saveTopLikers() { localStorage.setItem(getTopLikersKey(), JSON.stringify(gameState.topLikers)); }
        function resetTopLikers() { gameState.topLikers = {}; localStorage.removeItem(getTopLikersKey()); renderTopLikers(); }

        function loadTopGifters() { try { gameState.topGifters = JSON.parse(localStorage.getItem(getTopGiftersKey())) || {}; } catch { gameState.topGifters = {}; } }
        function saveTopGifters() { localStorage.setItem(getTopGiftersKey(), JSON.stringify(gameState.topGifters)); }
        function resetTopGifters() { gameState.topGifters = {}; localStorage.removeItem(getTopGiftersKey()); renderTopGifters(); }

        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); }
        function loadState() { 
            try { 
                gameState = JSON.parse(localStorage.getItem(STORAGE_KEY)) || gameState; 
                // Ensure default structure
                if(!gameState.levelScores) gameState.levelScores = {}; 
                loadLeaderboard(); loadTopLikers(); loadTopGifters(); 
                
                // Try to load cached level data for current default mode
                const cachedLevels = localStorage.getItem(CUSTOM_LEVEL_DATA_KEY + '_' + currentMode);
                if (cachedLevels) {
                    levelData = JSON.parse(cachedLevels);
                }
            } catch { resetGameProgress(); } 
        }

        function startInfoTicker() {
            const container = document.getElementById('info-ticker-container');
            const icon = document.getElementById('info-ticker-icon');
            const text = document.getElementById('info-ticker-text');
            if(!container || !icon || !text) return;

            const messages = [
                { html: `1 <img src="${ROSE_URL}" class="w-4 h-4 inline rounded-sm mx-1"> = Buka 1 Huruf!`, icon: "gift", colorClass: "text-yellow-300 fill-yellow-300" },
                { text: "Tercepat: 10 Poin | Susulan: 5 Poin", icon: "star", colorClass: "text-green-300 fill-green-300" },
                { text: "Urutan Jawab = Waktu Server (Anti-Lag)", icon: "server", colorClass: "text-blue-300 fill-blue-300" },
                { text: "Ketik !myrank Cek Ranking", icon: "trophy", colorClass: "text-white fill-none" }
            ];
            let index = 0;
            setInterval(() => {
                container.classList.add('opacity-0');
                setTimeout(() => {
                    index = (index + 1) % messages.length;
                    const msg = messages[index];
                    if (msg.html) text.innerHTML = msg.html; else text.textContent = msg.text;
                    icon.setAttribute('data-lucide', msg.icon);
                    icon.className = `w-4 h-4 ${msg.colorClass}`;
                    lucide.createIcons();
                    container.classList.remove('opacity-0');
                }, 500);
            }, 4000); 
        }

        function showConfirm(message, callback, title = 'Anda Yakin?') {
            if (!confirmModal) return;
            audioManager.play('pop');
            confirmTitle.textContent = title; confirmMessage.textContent = message; onConfirmCallback = callback; 
            confirmModal.classList.remove('hidden'); lucide.createIcons(); 
        }

        init();
    </script>
</body>
</html>