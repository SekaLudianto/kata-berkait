<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kata Berkait LIVE - Host</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Bangers', 'cursive'],
                        body: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.1)',
                        glassBorder: 'rgba(255, 255, 255, 0.2)',
                        neonBlue: '#4F46E5',
                        neonPink: '#EC4899',
                        neonAmber: '#F59E0B',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        glow: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.6 },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    
    <!-- 4. Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- 5. Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&family=Bangers&display=swap" rel="stylesheet">

    <!-- 6. Custom Styles -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden; /* Mencegah scroll body utama */
        }

        /* Background Mesh Gradient Animasi */
        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
        }

        .bg-mesh::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.15) 0%, transparent 50%),
                        radial-gradient(circle, rgba(236, 72, 153, 0.15) 100%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(99, 102, 241, 0.5);
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .glass-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Scrollbar Halus */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Game Elements */
        .slot-base {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slot-locked {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.3);
        }

        .slot-active-container {
            transform: scale(1.02);
            z-index: 10;
        }

        .slot-active {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border: 2px solid #F59E0B;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2), inset 0 0 10px rgba(245, 158, 11, 0.1);
            animation: pulse-border 2s infinite;
        }
        
        .slot-solved {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        @keyframes pulse-border {
            0% { border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { border-color: rgba(245, 158, 11, 1); box-shadow: 0 0 20px 0 rgba(245, 158, 11, 0.4); }
            100% { border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* Animasi Text */
        .font-bangers {
            font-family: 'Bangers', cursive;
            letter-spacing: 2px;
        }
        .text-glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Ticker Masking */
        .ticker-mask {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        
        /* Vertical List Masking - Modified to keep top visible */
        .mask-image-vertical {
            mask-image: linear-gradient(to bottom, black 0%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 0%, black 85%, transparent 100%);
        }

        /* Pop In Animation */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Cursor Blink */
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Toast Animation */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Sticker */
        .sticker-text {
            -webkit-text-stroke: 2px black;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }

        /* --- TAUNT BUBBLE ANIMATION --- */
        @keyframes taunt-float {
            0% { transform: translate(-50%, 20px) scale(0.8); opacity: 0; }
            10% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            80% { transform: translate(-50%, -80px) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(0.9); opacity: 0; }
        }
        .taunt-bubble {
            position: absolute;
            animation: taunt-float 4s ease-out forwards;
            pointer-events: none;
            z-index: 25; /* Above game board, below modals */
            max-width: 300px; /* Lebar max bubble agar teks tidak memanjang */
        }
    </style>
</head>

<body class="antialiased min-h-screen text-slate-200 selection:bg-indigo-500 selection:text-white">

    <!-- Background Animasi -->
    <div class="bg-mesh"></div>

    <!-- ============================================= -->
    <!--     LAYAR LOGIN                               -->
    <!-- ============================================= -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-6 overflow-y-auto">
        <main class="w-full max-w-md glass-panel rounded-3xl p-8 sm:p-10 shadow-2xl relative overflow-hidden transform transition-all duration-500 hover:scale-[1.01]">
            <!-- Decorative Blob -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500/20 rounded-full blur-2xl animate-blob"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl animate-blob animation-delay-2000"></div>

            <header class="text-center mb-8 relative z-10">
                <div class="inline-block p-3 rounded-full bg-indigo-500/20 mb-4 border border-indigo-500/30">
                    <i data-lucide="gamepad-2" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <h1 class="text-5xl text-white mb-2 font-display tracking-widest text-glow">HOST ACCESS</h1>
                <p class="text-slate-400 font-medium tracking-wide">Kata Berkait LIVE</p>
            </header>

            <form id="login-form" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider ml-1">Username</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="w-5 h-5 text-slate-500 group-focus-within:text-indigo-400 transition-colors"></i>
                        </div>
                        <input type="text" id="login-username" placeholder="Masukkan username" class="w-full glass-input rounded-xl py-3.5 pl-10 pr-4 font-medium placeholder-slate-600 focus:ring-0" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider ml-1">Password</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="w-5 h-5 text-slate-500 group-focus-within:text-indigo-400 transition-colors"></i>
                        </div>
                        <input type="password" id="login-password" placeholder="Masukkan password" class="w-full glass-input rounded-xl py-3.5 pl-10 pr-4 font-medium placeholder-slate-600 focus:ring-0" required>
                    </div>
                </div>
                
                <p id="login-error" class="text-center text-red-400 text-sm font-medium min-h-[1.25rem]"></p>

                <button type="submit" data-action="perform-login" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/30 transform transition-all active:scale-95 flex items-center justify-center gap-2 group">
                    <span>MASUK SEBAGAI HOST</span>
                    <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </form>
        </main>
    </div>

    <!-- ============================================= -->
    <!--     LAYAR HOME (SETTING)                      -->
    <!-- ============================================= -->
    <div id="home-screen" class="fixed inset-0 z-40 flex items-center justify-center p-4 overflow-y-auto hidden">
        <main class="w-full max-w-lg glass-panel rounded-3xl p-6 sm:p-8 shadow-2xl relative border-t border-white/10">
            <header class="flex items-center justify-between mb-6 border-b border-white/5 pb-4">
                <div>
                    <h1 class="text-3xl text-white font-display tracking-wide">DASHBOARD HOST</h1>
                    <p class="text-slate-400 text-sm">Pengaturan Game & Koneksi</p>
                </div>
                <button data-action="logout" class="p-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors" title="Keluar">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </header>

            <!-- Koneksi Server -->
            <section class="mb-6 bg-black/20 rounded-2xl p-4 border border-white/5">
                <h2 class="text-sm font-bold text-indigo-300 mb-3 flex items-center gap-2 uppercase tracking-wider">
                    <i data-lucide="radio" class="w-4 h-4"></i> Koneksi Server
                </h2>
                
                <div class="space-y-3">
                    <div>
                        <select id="connection-type" class="w-full glass-input rounded-xl px-4 py-2.5 text-sm appearance-none cursor-pointer">
                            <option value="tiktok-connector" class="bg-slate-800 text-white">TikTok Live Connector (Remote)</option>
                            <option value="indofinity-ws" class="bg-slate-800 text-white">IndoFinity WebSocket (Lokal)</option>
                            <option value="indofinity-socketio" class="bg-slate-800 text-white">IndoFinity Socket.IO (Lokal)</option>
                        </select>
                    </div>
                    
                    <div id="unique-id-container" class="relative">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-slate-500">@</span>
                        </div>
                        <input type="text" id="connection-unique-id" placeholder="Username TikTok" class="w-full glass-input rounded-xl py-2.5 pl-8 pr-4 text-sm font-medium">
                    </div>

                    <div class="flex items-center gap-3 pt-2">
                        <button data-action="connect-server" id="connect-button" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex justify-center items-center gap-2">
                            <i data-lucide="wifi" class="w-4 h-4"></i> Hubungkan
                        </button>
                        <button data-action="disconnect-server" id="disconnect-button" class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 font-bold py-2.5 rounded-xl transition-all hidden flex justify-center items-center gap-2">
                            <i data-lucide="wifi-off" class="w-4 h-4"></i> Putuskan
                        </button>
                    </div>
                    <div id="server-status" class="text-xs text-center font-medium text-slate-500">Belum terhubung.</div>
                </div>
            </section>

            <!-- Game Control -->
            <section class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Stage</label>
                        <select id="stage-select" class="w-full glass-input rounded-xl px-3 py-2 text-sm disabled:opacity-50">
                            <option value="1">Stage 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Level</label>
                        <select id="level-select" class="w-full glass-input rounded-xl px-3 py-2 text-sm disabled:opacity-50">
                            <option value="0">Memuat...</option>
                        </select>
                    </div>
                </div>

                <button data-action="start-game" id="start-game-button" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-6 h-6 fill-current"></i> MULAI GAME
                </button>
                
                <button data-action="end-session" id="end-session-button" class="w-full bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 font-bold py-2.5 rounded-xl text-sm transition-all hidden">
                    Ganti Level / Akhiri Sesi
                </button>
                
                <p id="game-status" class="text-center text-xs text-slate-500 h-4"></p>
            </section>

            <!-- Settings Expander -->
            <section class="mt-6 pt-4 border-t border-white/5">
                <button data-action="toggle-settings" class="flex items-center justify-between w-full text-left text-sm font-semibold text-slate-400 hover:text-white transition-colors group">
                    <span class="flex items-center gap-2"><i data-lucide="settings-2" class="w-4 h-4 group-hover:rotate-45 transition-transform"></i> Pengaturan Lanjutan</span>
                    <i data-lucide="chevron-down" id="settings-chevron" class="w-4 h-4 transition-transform"></i>
                </button>
                
                <div id="settings-panel" class="hidden mt-4 space-y-4 bg-black/20 rounded-xl p-4">
                    <!-- Config GitHub Hidden -->
                    <div class="hidden grid grid-cols-2 gap-2">
                         <input type="text" id="gh-username" class="glass-input p-2 text-xs rounded">
                         <input type="text" id="gh-repo" class="glass-input p-2 text-xs rounded">
                         <input type="text" id="gh-path" class="glass-input p-2 text-xs rounded">
                         <button data-action="save-gh-config" class="bg-slate-700 text-white text-xs rounded p-2">Simpan</button>
                    </div>

                    <div class="flex gap-2">
                        <button data-action="update-levels" class="flex-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-600/30 text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-1">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Update Soal
                        </button>
                        <button data-action="import-csv" class="flex-1 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 border border-purple-600/30 text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-1">
                            <i data-lucide="file-up" class="w-3 h-3"></i> Upload CSV
                        </button>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    </div>
                    
                    <button data-action="reset-leaderboard" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-2">
                        <i data-lucide="trash" class="w-3 h-3"></i> Reset Semua Data
                    </button>
                    <div class="flex gap-2">
                        <button data-action="reset-top-likers" class="flex-1 bg-pink-500/10 text-pink-400 border border-pink-500/20 text-[10px] font-bold py-1.5 rounded-lg">Reset Likes</button>
                        <button data-action="reset-top-gifters" class="flex-1 bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 text-[10px] font-bold py-1.5 rounded-lg">Reset Gifts</button>
                    </div>

                    <div id="level-update-status" class="text-center text-[10px] text-slate-500"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- ============================================= -->
    <!--     LAYAR GAME (PUZZLE)                       -->
    <!-- ============================================= -->
    <div id="puzzle-screen" class="flex flex-col h-screen overflow-hidden hidden relative">
        
        <!-- Header Minimalis -->
        <header class="w-full max-w-2xl mx-auto px-4 py-3 flex justify-between items-center relative z-20 bg-gradient-to-b from-slate-900/80 to-transparent backdrop-blur-sm">
            <button data-action="go-home" class="p-2.5 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 transition-all active:scale-95 group">
                <i data-lucide="layout-grid" class="w-5 h-5 text-slate-300 group-hover:text-white"></i>
            </button>

            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2">
                    <span id="stage-info" class="text-[10px] uppercase font-bold tracking-wider bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded border border-indigo-500/20">Stage 1</span>
                    <h1 id="level-title" class="text-lg font-bold text-white tracking-wide">Level 1</h1>
                </div>
                <!-- Timer -->
                <div id="word-timer-container" class="flex items-center gap-1.5 text-amber-400 font-mono text-sm font-bold bg-amber-500/10 px-2 py-0.5 rounded-full mt-1 border border-amber-500/10" style="display: none;">
                    <i data-lucide="timer" class="w-3.5 h-3.5"></i>
                    <span id="word-timer-display">3:00</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button data-action="skip-level" class="p-2.5 rounded-full bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 transition-all active:scale-95" title="Skip">
                    <i data-lucide="skip-forward" class="w-5 h-5 fill-current"></i>
                </button>
                <button data-action="reset-game" class="p-2.5 rounded-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 transition-all active:scale-95" title="Reset">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
            </div>
            
            <button id="header-reconnect-btn" data-action="manual-reconnect" class="absolute bottom-[-40px] left-1/2 -translate-x-1/2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg animate-bounce hidden z-50">
                <i data-lucide="wifi-off" class="w-3 h-3"></i> Reconnect
            </button>
        </header>

        <!-- Notifikasi Disconnect -->
        <div id="disconnect-notification" class="absolute top-20 left-4 right-4 z-40 hidden">
            <div class="max-w-md mx-auto bg-red-500/90 backdrop-blur-md text-white p-4 rounded-xl shadow-2xl border border-red-400 flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full animate-pulse"><i data-lucide="wifi-off" class="w-5 h-5"></i></div>
                    <div>
                        <h3 class="font-bold text-sm">Koneksi Terputus</h3>
                        <p id="disconnect-reason" class="text-xs opacity-90">Mencoba menghubungkan ulang...</p>
                    </div>
                </div>
                <button data-action="manual-reconnect" class="bg-white text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-50 transition-colors">Coba Lagi</button>
            </div>
        </div>

        <!-- Simulation Bar -->
        <div id="simulation-mode-container" class="absolute bottom-4 left-4 right-4 z-40 hidden">
            <div class="max-w-md mx-auto glass-panel p-2 rounded-xl flex items-center gap-2">
                <input type="text" id="sim-comment" placeholder="Ketik jawaban..." class="flex-grow glass-input px-3 py-2 text-sm rounded-lg">
                <button data-action="sim-like" class="p-2 bg-pink-500/20 text-pink-400 rounded-lg"><i data-lucide="heart" class="w-4 h-4 fill-current"></i></button>
                <button data-action="sim-gift" class="p-2 bg-purple-500/20 text-purple-400 rounded-lg"><i data-lucide="gift" class="w-4 h-4 fill-current"></i></button>
                <button data-action="sim-send" class="p-2 bg-blue-500/20 text-blue-400 rounded-lg"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- AREA GAMEPLAY -->
        <main class="flex-1 w-full max-w-2xl mx-auto px-4 pb-0 overflow-hidden flex flex-col items-center relative">
            
            <!-- Ticker Stats (Lebih Compact) -->
            <div id="stats-ticker-container" class="w-full max-w-md mt-2 mb-4 space-y-2 relative z-10">
                <!-- Likes -->
                <div class="flex items-center bg-black/30 rounded-lg overflow-hidden border border-white/5 h-8">
                    <div class="bg-pink-600/20 px-2 h-full flex items-center gap-1 border-r border-white/5">
                        <i data-lucide="heart" class="w-3.5 h-3.5 text-pink-500 fill-pink-500"></i>
                        <span class="text-[10px] font-bold text-pink-200">LIKES</span>
                    </div>
                    <div id="top-likers-viewport" class="flex-grow overflow-hidden relative h-full ticker-mask">
                        <div id="top-likers-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-4">
                            <span class="text-white/30 text-[10px] italic">Menunggu likes...</span>
                        </div>
                    </div>
                </div>
                <!-- Gifts -->
                <div class="flex items-center bg-black/30 rounded-lg overflow-hidden border border-white/5 h-8">
                    <div class="bg-indigo-600/20 px-2 h-full flex items-center gap-1 border-r border-white/5">
                        <i data-lucide="gift" class="w-3.5 h-3.5 text-indigo-400 fill-indigo-400"></i>
                        <span class="text-[10px] font-bold text-indigo-200">GIFTS</span>
                    </div>
                    <div id="top-gifters-viewport" class="flex-grow overflow-hidden relative h-full ticker-mask">
                         <div id="top-gifters-list" class="flex items-center gap-4 absolute left-0 top-0 h-full whitespace-nowrap pl-4">
                             <span class="text-white/30 text-[10px] italic">Menunggu gifts...</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- List Kata -->
            <div id="word-list-container" class="w-full max-w-md flex-1 overflow-y-auto pr-1 pb-20 custom-scrollbar space-y-3 mask-image-vertical">
                <!-- Slot kata dirender di sini via JS -->
            </div>
        </main>
    </div>
    
    <!-- ============================================= -->
    <!--     MODAL MENANG                              -->
    <!-- ============================================= -->
    <div id="win-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="w-full max-w-md glass-panel bg-slate-900/90 rounded-3xl p-8 text-center shadow-2xl border border-yellow-500/20 pop-in">
            <div class="relative inline-block mb-4">
                <div class="absolute inset-0 bg-yellow-500 blur-xl opacity-20 rounded-full animate-pulse"></div>
                <i data-lucide="trophy" class="w-16 h-16 text-yellow-400 relative z-10 fill-yellow-400/20"></i>
            </div>
            <h2 class="text-4xl text-white mb-2 font-display tracking-wider text-glow">LEVEL CLEAR!</h2>
            <p class="text-slate-400 text-sm mb-6">Kerja bagus, Tim!</p>
            
            <div class="bg-black/30 rounded-xl p-4 border border-white/5 mb-6">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center justify-center gap-2">
                    <i data-lucide="crown" class="w-3 h-3 text-yellow-500"></i> MVP Leaderboard
                </h3>
                
                <!-- CONTAINER LEADERBOARD BARU -->
                <div id="leaderboard-container" class="relative h-64 w-full">
                    <!-- Isinya akan di-generate oleh JS -->
                </div>
            </div>

            <div id="next-level-prompt">
                <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-lg p-3 inline-block">
                     <p class="text-indigo-200 text-sm font-medium">
                        Ketik <span class="bg-indigo-500 text-white px-1.5 py-0.5 rounded text-xs font-bold mx-1">!next</span> untuk lanjut
                    </p>
                </div>
            </div>
            
            <div id="all-complete-prompt" class="hidden">
                <p class="text-emerald-400 font-bold text-lg mb-4">âœ¨ Semua Level Selesai! âœ¨</p>
                <button data-action="go-home" class="w-full py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-bold transition-all">
                    Menu Utama
                </button>
            </div>
        </div>
    </div>

    <!-- OVERLAYS (Sticker, Ready, Gift, Toast, Confirm) -->
    
    <!-- Sticker Overlay (ANJAY GG) -->
    <div id="sticker-overlay" class="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none hidden">
        <div id="sticker-content" class="font-display text-8xl sm:text-9xl text-transparent bg-clip-text bg-gradient-to-br from-yellow-300 to-orange-500 sticker-text rotate-[-12deg] drop-shadow-2xl scale-0 transition-transform duration-300">
            ANJAY GG!
        </div>
    </div>
    
    <!-- Ready Countdown -->
    <div id="ready-overlay" class="fixed inset-0 z-[70] flex flex-col items-center justify-center bg-black/60 backdrop-blur-md hidden">
        <div class="font-display text-5xl text-white drop-shadow-lg mb-6 animate-bounce">SIAP-SIAP!</div>
        <div id="countdown-number" class="font-display text-9xl text-yellow-400 drop-shadow-[0_0_30px_rgba(250,204,21,0.6)]">3</div>
    </div>

    <!-- Gift Overlay -->
    <div id="gift-overlay" class="fixed top-24 left-1/2 -translate-x-1/2 z-[80] pointer-events-none hidden">
        <div id="gift-card" class="glass-panel p-4 rounded-2xl shadow-2xl border border-purple-500/50 flex flex-col items-center text-center min-w-[260px] transform transition-all duration-500">
            <div class="relative mb-3">
                <div class="absolute -inset-2 bg-purple-500 rounded-full blur-md opacity-50 animate-pulse"></div>
                <img id="gift-user-pic" src="" class="relative w-16 h-16 rounded-full border-2 border-white object-cover">
                <div class="absolute -bottom-1 -right-1 bg-yellow-400 text-black text-[10px] font-bold px-1.5 rounded-full border border-white">SULTAN</div>
            </div>
            <h3 id="gift-user-name" class="font-bold text-lg text-white mb-0.5 leading-tight">User Name</h3>
            <p class="text-purple-300 text-xs font-medium mb-3">Mengirim <span id="gift-name" class="text-white font-bold">Hadiah</span></p>
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-1.5 rounded-full font-display text-xl tracking-wide shadow-lg animate-bounce">
                TERIMA KASIH!
            </div>
            <p class="text-slate-400 text-[10px] mt-2">Follow <span id="gift-user-follow" class="text-purple-400 font-bold">@username</span></p>
        </div>
    </div>

    <!-- Toasts Container -->
    <div id="toast-container" class="fixed top-24 left-4 z-50 flex flex-col gap-2 w-72 pointer-events-none"></div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="w-full max-w-sm glass-panel bg-slate-900 rounded-2xl p-6 text-center shadow-2xl border border-white/10 pop-in">
            <div class="w-12 h-12 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h2 id="confirm-title" class="text-lg font-bold text-white mb-2">Konfirmasi</h2>
            <p id="confirm-message" class="text-slate-400 text-sm mb-6">Yakin ingin melanjutkan?</p>
            <div class="flex gap-3">
                <button id="confirm-no" class="flex-1 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-slate-300 font-medium transition-colors">Batal</button>
                <button id="confirm-yes" class="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg shadow-red-600/20 transition-colors">Ya, Lanjut</button>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!--     SCRIPT (LOGIKA PERMAINAN UTUH)            -->
    <!-- ============================================= -->
    <script>
        // --- KREDENSIAL HOST ---
        const HOST_USERNAME = "Arsenic";
        const HOST_PASSWORD = "Darman26";
        const AUTH_KEY = 'kata-rantai-host-auth-v1';
        const HOST_USERNAME_KEY = 'kata-rantai-host-user-v1';
        // -----------------------

        const GH_CONFIG_KEY = 'kata-rantai-gh-config-v1';
        const LAST_USERNAME_KEY = 'kata-rantai-last-username-v1'; 
        const LEADERBOARD_KEY = 'kata-rantai-leaderboard-v1'; 
        const TOP_LIKERS_KEY = 'kata-rantai-top-likers-v1'; 
        const TOP_GIFTERS_KEY = 'kata-rantai-top-gifters-v1';
        const CUSTOM_LEVEL_DATA_KEY = 'kata-rantai-custom-levels-v1';
        const STORAGE_KEY = 'kata-rantai-save-v1';

        const TIKTOK_SERVERS = ["https://ini-live.up.railway.app", "https://buat-lev.up.railway.app"];
        const INDOFINITY_WS_PORT = 62024;
        const INDOFINITY_SOCKETIO_PORT = 62025;

        let currentServerIndex = 0;
        let githubConfig = { OWNER: 'SekaLudianto', REPO: 'kata-berkait', PATH: 'csv', BRANCH: 'main' };

        function getDynamicIP(port) {
            let host = 'localhost';
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                host = window.location.hostname;
                console.log(`Menggunakan IP dinamis: ${host}`);
            } else {
                console.log(`Menggunakan localhost.`);
            }
            return host;
        }

        class ConnectionHandler {
            constructor() { this.eventListeners = {}; this.uniqueId = null; this.options = null; }
            on(eventName, eventHandler) { this.eventListeners[eventName] = eventHandler; }
            emit(eventName, data) { if (this.eventListeners[eventName]) { this.eventListeners[eventName](data); } }
            removeAllCustomListeners() { this.eventListeners = {}; }
        }

        class IndoFinityWSConnection extends ConnectionHandler {
            constructor(host) { super(); this.ws = null; this.serverUrl = `ws://${host}:${INDOFINITY_WS_PORT}`; }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId; 
                return new Promise((resolve, reject) => {
                    this.ws = new WebSocket(this.serverUrl);
                    this.ws.onopen = () => { console.info('Terhubung ke IndoFinity WebSocket'); resolve(); };
                    this.ws.onmessage = (message) => { try { const data = JSON.parse(message.data); this.handleIndoFinityMessage(data); } catch (error) { this.emit('tiktokDisconnected', 'Error parsing data'); } };
                    this.ws.onclose = () => { this.emit('disconnect'); };
                    this.ws.onerror = (err) => { reject('WebSocket Error'); };
                    setTimeout(() => { reject('Connection Timeout'); }, 15000);
                });
            }
            handleIndoFinityMessage(data) {
                const event = data.event; const eventData = data.data;
                switch (event) {
                    case 'chat': this.emit('chat', { comment: eventData.comment || '', uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname || 'Pengguna IndoFinity', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/0052D4/FFFFFF?text=I' }); break;
                    case 'like': this.emit('like', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname || 'Pengguna IndoFinity', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/0052D4/FFFFFF?text=I', likeCount: eventData.count || 1 }); break;
                    case 'sociabuzz': case 'saweria': case 'trakteer': case 'tako': case 'bagibagi': case 'sibagi':
                        this.emit('gift', { uniqueId: eventData.uniqueId || 'indofinity_sultan', nickname: eventData.nickname || eventData.sender || 'Sultan Donasi', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/A855F7/FFFFFF?text=G', diamondCount: eventData.amount || 1, giftName: eventData.message || eventData.eventName || event, giftId: Date.now() + '_' + Math.random() }); break;
                }
            }
            disconnect() { if (this.ws) { this.ws.close(); } }
        }

        class IndoFinityIOConnection extends ConnectionHandler {
            constructor(host) { super(); this.socket = null; this.serverUrl = `http://${host}:${INDOFINITY_SOCKETIO_PORT}`; }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId; 
                return new Promise((resolve, reject) => {
                    this.socket = io(this.serverUrl, { transports: ['websocket', 'polling'] });
                    this.socket.on('connect', () => { resolve(); });
                    this.socket.on('message', (data) => { this.handleIndoFinityMessage(data); });
                    this.socket.on('disconnect', () => { this.emit('disconnect'); });
                    this.socket.on('connect_error', (err) => { reject('Socket.IO Connection Error'); });
                    setTimeout(() => { reject('Connection Timeout'); }, 15000);
                });
            }
            handleIndoFinityMessage(data) {
                const event = data.event; const eventData = data.data;
                switch (event) {
                    case 'chat': this.emit('chat', { comment: eventData.comment || '', uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname || 'Pengguna IndoFinity', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/0052D4/FFFFFF?text=I' }); break;
                    case 'like': this.emit('like', { uniqueId: eventData.uniqueId || 'indofinity_user', nickname: eventData.nickname || 'Pengguna IndoFinity', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/0052D4/FFFFFF?text=I', likeCount: eventData.count || 1 }); break;
                    case 'sociabuzz': case 'saweria': case 'trakteer': case 'tako': case 'bagibagi': case 'sibagi':
                        this.emit('gift', { uniqueId: eventData.uniqueId || 'indofinity_sultan', nickname: eventData.nickname || eventData.sender || 'Sultan Donasi', profilePictureUrl: eventData.profilePictureUrl || 'https://placehold.co/40x40/A855F7/FFFFFF?text=G', diamondCount: eventData.amount || 1, giftName: eventData.message || eventData.eventName || event, giftId: Date.now() + '_' + Math.random() }); break;
                }
            }
            disconnect() { if (this.socket) { this.socket.disconnect(); } }
        }

        class TikTokIOConnection extends ConnectionHandler {
            constructor(backendUrl) {
                super();
                this.socket = io(backendUrl);
                this.socket.on('connect', () => { console.info("Socket connected!"); if (this.uniqueId) this.setUniqueId(); });
                this.socket.on('disconnect', () => { console.warn("Socket disconnected!"); this.uniqueId = null; this.emit('disconnect'); });
                this.socket.on('streamEnd', () => { console.warn("LIVE has ended!"); this.uniqueId = null; this.emit('streamEnd'); });
                this.socket.on('tiktokDisconnected', (errMsg) => { console.warn(errMsg); if (errMsg && errMsg.includes('LIVE has ended')) this.uniqueId = null; this.emit('tiktokDisconnected', errMsg); });
            }
            connect(uniqueId, options) {
                this.uniqueId = uniqueId.replace(/^@/, ''); this.options = options || {}; this.removeAllCustomListeners();
                this.setUniqueId();
                return new Promise((resolve, reject) => { 
                    this.socket.once('tiktokConnected', resolve); 
                    this.socket.once('tiktokDisconnected', reject); 
                    setTimeout(() => { reject('Connection Timeout'); }, 15000); 
                });
            }
            setUniqueId() { this.socket.emit('setUniqueId', this.uniqueId, this.options); }
            on(eventName, eventHandler) {
                super.on(eventName, eventHandler);
                if (eventName === 'chat') this.socket.on('chat', eventHandler);
                else if (eventName === 'like') this.socket.on('like', eventHandler); 
                else if (eventName === 'gift') this.socket.on('gift', eventHandler);
            }
            removeAllCustomListeners() { super.removeAllCustomListeners(); this.socket.off('chat'); this.socket.off('like'); this.socket.off('gift'); }
            disconnect() { if (this.socket) { this.socket.disconnect(); } }
        }

        let levelData = []; 
        const correctPhrases = ["Wih, Jagoan!", "Jenius!", "Mantap Betul!", "Gokil!", "Anjay GG!", "Luar Biasa!", "Kerja Bagus!", "Hebat!", "Cakep kek pantun!"];
        const incorrectPhrases = ["Typo ya?", "Coba Lagi!", "Betul tapi boong!", "Zonk!", "Waduh!", "Dikit Lagi!", "Hampir...!", "Bukan itu!", "Salah Woy!"];
        const WORD_TIMER_DURATION = 180; 
        
        let gameState = { currentLevelIndex: 0, isGameActive: false, isLevelComplete: false, isAcceptingGuesses: false, revealedWords: [], nextSlotToGuess: -1, leaderboard: {}, topLikers: {}, topGifters: {}, currentHints: [], wordTimerInterval: null, wordTimerRemaining: WORD_TIMER_DURATION }; 
        let isProcessingWin = false; let isReconnecting = false; let currentConnection = null; let lastProcessedGiftId = null; let lastConnectedUsername = null; let likerScrollInterval = null; let gifterScrollInterval = null;
        let isAuthenticated = localStorage.getItem(AUTH_KEY) === 'true'; let currentConnectionType = 'tiktok-connector';
        let leaderboardScrollId = null; // Variable global untuk kontrol scroll leaderboard

        // === VARIABEL BARU UNTUK TAUNT BUBBLES ===
        const tauntPhrases = [
            "Dingin banget di pucuk! ðŸ¥¶",
            "Ayo dong kejar poinku! ðŸ˜œ",
            "Segitu doang kemampuan klen?",
            "Gas terus! ðŸ”¥",
            "Mana nih saingannya? ðŸ‘€",
            "Poin gue nambah terus nih!",
            "Jangan kasih kendor! ðŸ’ª",
            "Coba lebih cepat lagi!",
            "King masih memimpin nih! ðŸ‘‘",
            "Belum ada lawan nih! ðŸ˜Ž",
            "Hahaha, lambat banget! ðŸ¤£"
        ];
        // Ganti interval dengan timeout agar bisa random waktu
        let tauntTimeout = null;
        // ===========================================

        const connectionTypeSelect = document.getElementById('connection-type');
        const connectionUniqueId = document.getElementById('connection-unique-id');
        const uniqueIdContainer = document.getElementById('unique-id-container');
        const serverStatus = document.getElementById('server-status');
        const disconnectButton = document.getElementById('disconnect-button');
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const homeScreen = document.getElementById('home-screen');
        const puzzleScreen = document.getElementById('puzzle-screen');
        const startGameButton = document.getElementById('start-game-button');
        const endSessionButton = document.getElementById('end-session-button'); 
        const gameStatus = document.getElementById('game-status');
        const connectButton = document.getElementById('connect-button');
        const simContainer = document.getElementById('simulation-mode-container');
        const simCommentInput = document.getElementById('sim-comment');
        const levelUpdateStatus = document.getElementById('level-update-status');
        const levelTitle = document.getElementById('level-title');
        const stageInfo = document.getElementById('stage-info'); 
        const wordListContainer = document.getElementById('word-list-container');
        const winModal = document.getElementById('win-modal');
        const nextLevelPrompt = document.getElementById('next-level-prompt');
        const allCompletePrompt = document.getElementById('all-complete-prompt');
        const toastContainer = document.getElementById('toast-container');
        const disconnectNotification = document.getElementById('disconnect-notification');
        const disconnectReason = document.getElementById('disconnect-reason');
        const csvFileInput = document.getElementById('csv-file-input');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsChevron = document.getElementById('settings-chevron');
        const ghUsernameInput = document.getElementById('gh-username');
        const ghRepoInput = document.getElementById('gh-repo');
        const ghPathInput = document.getElementById('gh-path');
        const stageSelect = document.getElementById('stage-select'); 
        const levelSelect = document.getElementById('level-select');
        const headerReconnectBtn = document.getElementById('header-reconnect-btn');
        const topLikersList = document.getElementById('top-likers-list'); 
        const topGiftersList = document.getElementById('top-gifters-list');
        const stickerOverlay = document.getElementById('sticker-overlay');
        const stickerContent = document.getElementById('sticker-content');
        const readyOverlay = document.getElementById('ready-overlay');
        const countdownNumberEl = document.getElementById('countdown-number');
        const giftOverlay = document.getElementById('gift-overlay');
        const giftCard = document.getElementById('gift-card');
        const giftUserPic = document.getElementById('gift-user-pic');
        const giftUserName = document.getElementById('gift-user-name');
        const giftNameEl = document.getElementById('gift-name');
        const giftUserFollow = document.getElementById('gift-user-follow');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        let onConfirmCallback = null; 
        let giftQueue = []; let isGiftOverlayShowing = false;

        function init() {
            setupGlobalListeners(); loadGitHubConfig(); loadLastUsername(); 
            const savedHostUsername = localStorage.getItem(HOST_USERNAME_KEY);
            if (isAuthenticated && loginUsernameInput && savedHostUsername) { loginUsernameInput.value = savedHostUsername; }
            const savedCustomData = localStorage.getItem(CUSTOM_LEVEL_DATA_KEY);
            if (savedCustomData) { try { levelData = JSON.parse(savedCustomData); } catch (e) { fetchAndUpdateLevels(); } } else { fetchAndUpdateLevels(); }
            loadState(); 
            if (isAuthenticated) { showPage('home'); setupConnectionUI(currentConnectionType); updateHomeUI(); } 
            else { showPage('login'); if (loginUsernameInput && !savedHostUsername) { setTimeout(() => loginUsernameInput.focus(), 100); } }
            lucide.createIcons();
            likerScrollInterval = startAutoScroll('top-likers-list', likerScrollInterval);
            gifterScrollInterval = startAutoScroll('top-gifters-list', gifterScrollInterval);
        }

        function showPage(pageName) {
            loginScreen.classList.toggle('hidden', pageName !== 'login');
            homeScreen.classList.toggle('hidden', pageName !== 'home');
            puzzleScreen.classList.toggle('hidden', pageName !== 'game');
            lucide.createIcons(); 
        }

        // ... (Fungsi login & setup listener sama seperti sebelumnya) ...
        function handleLogin(e) {
            e.preventDefault(); 
            const username = loginUsernameInput.value.trim(); const password = loginPasswordInput.value;
            if (username.toUpperCase() === HOST_USERNAME.toUpperCase() && password === HOST_PASSWORD) {
                isAuthenticated = true; localStorage.setItem(AUTH_KEY, 'true'); localStorage.setItem(HOST_USERNAME_KEY, username); 
                loginError.textContent = ''; showPage('home'); updateHomeUI();
                showToast('System', 'Login Berhasil!', 'correct');
            } else {
                loginError.textContent = 'Username atau Password salah.';
                setTimeout(() => loginError.textContent = '', 2000);
            }
        }
        
        function handleLogout() {
             showConfirm('Anda yakin ingin keluar?', () => {
                isAuthenticated = false; localStorage.removeItem(AUTH_KEY); currentConnection = null; showPage('login');
            }, 'Konfirmasi Keluar');
        }

        function setupConnectionUI(type) {
            currentConnectionType = type;
            const isTikTok = type === 'tiktok-connector'; const isIndoFinity = type.startsWith('indofinity');
            if (isTikTok) { connectionUniqueId.placeholder = 'Username TikTok'; connectionUniqueId.value = lastConnectedUsername || ''; } 
            else if (isIndoFinity) { const host = getDynamicIP(INDOFINITY_SOCKETIO_PORT); connectionUniqueId.placeholder = `Host/IP (Auto: ${host})`; connectionUniqueId.value = host; }
        }

        function setupGlobalListeners() {
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (connectionTypeSelect) connectionTypeSelect.addEventListener('change', (e) => {
                setupConnectionUI(e.target.value); serverStatus.textContent = 'Belum terhubung.'; serverStatus.className = 'text-xs text-center font-medium text-slate-500';
                disconnectButton.classList.add('hidden'); connectButton.classList.remove('hidden');
                if (currentConnection) { currentConnection.disconnect(); currentConnection = null; }
            });

            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]'); if (!target) return;
                const { action } = target.dataset;
                switch (action) {
                    case 'logout': handleLogout(); break; 
                    case 'connect-server': connectToServer(); break;
                    case 'disconnect-server': if (currentConnection) { currentConnection.disconnect(); currentConnection = null; serverStatus.textContent = 'Koneksi diputus.'; serverStatus.className = 'text-xs text-center font-medium text-red-400'; disconnectButton.classList.add('hidden'); connectButton.classList.remove('hidden'); simContainer.classList.remove('hidden'); } break;
                    case 'start-game': startOrContinueGame(); break;
                    case 'end-session': showConfirm('Akhiri sesi saat ini?', () => { gameState.isGameActive = false; saveState(); updateHomeUI(); }); break;
                    case 'go-home': goToHome(); break;
                    case 'reset-game': showConfirm('Reset progres level ini?', () => { loadLevel(gameState.currentLevelIndex, true); }); break;
                    case 'skip-level': showConfirm('Lewati level ini?', () => { loadNextLevel(); }); break;
                    case 'manual-reconnect': if (currentConnection) { currentConnection.disconnect(); currentConnection = null; } connectToServer(true); break;
                    case 'sim-send': if (simCommentInput && simCommentInput.value.trim()) { handleComment({ comment: simCommentInput.value.trim(), uniqueId: 'simulator_user_id', nickname: 'Pemain Simulasi', profilePictureUrl: 'https://placehold.co/40x40/0284C7/FFFFFF?text=S' }); simCommentInput.value = ''; } break;
                    case 'sim-like': handleLike({ uniqueId: 'sim_liker_' + Math.floor(Math.random()*5), nickname: 'Liker ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/EC4899/FFFFFF?text=L', likeCount: Math.floor(Math.random() * 20) + 5 }); break;
                    case 'sim-gift': handleGift({ uniqueId: 'sim_gifter_' + Math.floor(Math.random()*5), nickname: 'Sultan ' + Math.floor(Math.random()*5), profilePictureUrl: 'https://placehold.co/40x40/A855F7/FFFFFF?text=G', diamondCount: Math.floor(Math.random() * 50) + 1, giftName: 'Mawar' }); break;
                    case 'update-levels': fetchAndUpdateLevels(); break;
                    case 'import-csv': if (csvFileInput) csvFileInput.click(); break;
                    case 'toggle-settings': settingsPanel.classList.toggle('hidden'); settingsChevron.classList.toggle('rotate-180'); break;
                    case 'save-gh-config': saveGitHubConfig(); showToast('System', 'Konfigurasi tersimpan!', 'correct'); break;
                    case 'reset-leaderboard': showConfirm('Reset Papan Peringkat?', () => { resetLeaderboard(); showToast('System', 'Leaderboard Direset!', 'correct'); }); break;
                    case 'reset-top-likers': showConfirm('Reset Top Likers?', () => { resetTopLikers(); showToast('System', 'Top Likers Direset!', 'correct'); }); break;
                    case 'reset-top-gifters': showConfirm('Reset Top Gifters?', () => { resetTopGifters(); showToast('System', 'Top Gifters Direset!', 'correct'); }); break;
                }
            });
            if (simCommentInput) simCommentInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.querySelector('[data-action="sim-send"]').click(); } });
            if (csvFileInput) csvFileInput.addEventListener('change', handleCSVUpload);
            if (stageSelect) stageSelect.addEventListener('change', () => { populateLevelSelect(); if (levelSelect.value) { gameState.currentLevelIndex = parseInt(levelSelect.value, 10); } updateHomeUI(); }); 
            if (levelSelect) levelSelect.addEventListener('change', (e) => { gameState.currentLevelIndex = parseInt(e.target.value, 10); updateHomeUI(); });
            if (confirmYes) { confirmYes.addEventListener('click', () => { if (onConfirmCallback) { onConfirmCallback(); } onConfirmCallback = null; confirmModal.classList.add('hidden'); }); }
            if (confirmNo) { confirmNo.addEventListener('click', () => { onConfirmCallback = null; confirmModal.classList.add('hidden'); }); }
        }

        // ... (Fungsi koneksi tetap sama) ...
        function connectToServer(isManualReconnect = false) {
            if (!isAuthenticated) return; 
            const type = connectionTypeSelect.value; let uniqueId = connectionUniqueId.value.trim(); const host = getDynamicIP();
            if (type === 'tiktok-connector' && !uniqueId) { serverStatus.textContent = 'Username kosong!'; serverStatus.className = 'text-xs text-center font-bold text-red-400'; return; }
            if (isReconnecting && !isManualReconnect) return;
            isReconnecting = true; 
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); currentConnection = null; }
            
            connectButton.disabled = true; disconnectButton.classList.add('hidden'); startGameButton.disabled = true; serverStatus.className = 'text-xs text-center font-medium text-slate-400';
            
            if (type === 'tiktok-connector') { serverStatus.textContent = `Connecting to @${uniqueId}...`; currentServerIndex = 0; tryTikTokConnectionAttempt(currentServerIndex, uniqueId); } 
            else if (type === 'indofinity-ws') { currentConnection = new IndoFinityWSConnection(uniqueId || host); serverStatus.textContent = `Connecting WS...`; tryIndoFinityConnection(currentConnection, uniqueId); } 
            else if (type === 'indofinity-socketio') { currentConnection = new IndoFinityIOConnection(uniqueId || host); serverStatus.textContent = `Connecting IO...`; tryIndoFinityConnection(currentConnection, uniqueId); }
        }

        function tryIndoFinityConnection(connectionInstance, uniqueId) {
            connectionInstance.connect(uniqueId, {}).then(() => {
                isReconnecting = false; serverStatus.textContent = `Terhubung (Lokal)`; serverStatus.className = 'text-xs text-center font-bold text-emerald-400';
                startGameButton.disabled = false; connectButton.classList.add('hidden'); disconnectButton.classList.remove('hidden');
                if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); 
                if (simContainer) simContainer.classList.add('hidden'); 
                setupServerListeners(connectionInstance);
            }).catch(err => { isReconnecting = false; serverStatus.textContent = `Gagal Koneksi.`; serverStatus.className = 'text-xs text-center font-bold text-red-400'; connectButton.disabled = false; startGameButton.disabled = true; disconnectButton.classList.add('hidden'); if(gameState.isGameActive) { disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.remove('hidden'); } currentConnection = null; });
        }
        
        function tryTikTokConnectionAttempt(index, uniqueId) {
            currentServerIndex = index;
            if (index >= TIKTOK_SERVERS.length) {
                const errorMsg = 'Semua server gagal.'; serverStatus.textContent = errorMsg; serverStatus.className = 'text-xs text-center font-bold text-red-400';
                connectButton.disabled = false; startGameButton.disabled = false; if(disconnectReason) disconnectReason.textContent = errorMsg; if(gameState.isGameActive) { disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.remove('hidden'); } isReconnecting = false; return;
            }
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); }
            currentConnection = new TikTokIOConnection(TIKTOK_SERVERS[index]);
            currentConnection.connect(uniqueId, {}).then(() => {
                isReconnecting = false; serverStatus.textContent = `Terhubung: @${uniqueId}`; serverStatus.className = 'text-xs text-center font-bold text-emerald-400';
                startGameButton.disabled = false; connectButton.classList.add('hidden'); disconnectButton.classList.remove('hidden'); saveLastUsername(uniqueId);
                if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); 
                if (simContainer) simContainer.classList.add('hidden'); 
                setupServerListeners(currentConnection);
            }).catch(err => { tryTikTokConnectionAttempt(index + 1, uniqueId); });
        }
        
        function setupServerListeners(connection) {
            connection.on('chat', handleComment); connection.on('like', handleLike); connection.on('gift', handleGift);
            connection.on('disconnect', () => handleDisconnect('Koneksi terputus.')); connection.on('streamEnd', () => handleDisconnect('LIVE berakhir.')); connection.on('tiktokDisconnected', (e) => handleDisconnect(`Server terputus: ${e}`));
        }

        function handleDisconnect(reason) {
            if (isReconnecting) return; isReconnecting = true; 
            if (currentConnectionType !== 'tiktok-connector') {
                 serverStatus.textContent = `Terputus: ${reason}`; serverStatus.className = 'text-xs text-center font-bold text-red-400';
                 connectButton.disabled = false; startGameButton.disabled = false; disconnectButton.classList.add('hidden');
                 if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection = null; }
                 if (!gameState.isGameActive) updateHomeUI(); else if (disconnectNotification) { disconnectReason.textContent = reason; disconnectNotification.classList.remove('hidden'); } isReconnecting = false; 
                 if (simContainer) simContainer.classList.remove('hidden');
                 return;
            }
            if (!gameState.isGameActive) {
                serverStatus.textContent = reason; serverStatus.className = 'text-xs text-center font-bold text-red-400';
                connectButton.disabled = false; startGameButton.disabled = false; if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); currentConnection = null; } updateHomeUI(); isReconnecting = false; 
                if (simContainer) simContainer.classList.remove('hidden');
                return;
            }
            if(disconnectReason) disconnectReason.textContent = "Reconnecting..."; disconnectNotification.classList.remove('hidden'); headerReconnectBtn.classList.add('hidden'); 
            if (currentConnection) { currentConnection.removeAllCustomListeners(); currentConnection.disconnect(); }
            currentServerIndex = (currentServerIndex + 1) % TIKTOK_SERVERS.length;
            setTimeout(() => { if (!lastConnectedUsername) { goToHome(); isReconnecting = false; return; } tryTikTokConnectionAttempt(currentServerIndex, lastConnectedUsername); }, 2000);
        }

        // ... (Fungsi config GitHub & CSV sama) ...
        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem(GH_CONFIG_KEY); if (savedConfig) { try { const parsed = JSON.parse(savedConfig); githubConfig = { ...githubConfig, ...parsed }; } catch (e) {} }
            if (ghUsernameInput) ghUsernameInput.value = githubConfig.OWNER; if (ghRepoInput) ghRepoInput.value = githubConfig.REPO; if (ghPathInput) ghPathInput.value = githubConfig.PATH;
        }
        function saveGitHubConfig() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; githubConfig.PATH = ghPathInput.value.trim();
            localStorage.setItem(GH_CONFIG_KEY, JSON.stringify(githubConfig));
        }
        function loadLastUsername() { lastConnectedUsername = localStorage.getItem(LAST_USERNAME_KEY); if (lastConnectedUsername && connectionUniqueId) { connectionUniqueId.value = lastConnectedUsername; } }
        function saveLastUsername(username) { lastConnectedUsername = username; localStorage.setItem(LAST_USERNAME_KEY, username); }

        function handleCSVUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            levelUpdateStatus.textContent = "Membaca..."; 
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsedLevels = parseCSV(e.target.result);
                    if (parsedLevels && parsedLevels.length > 0) {
                        levelData = parsedLevels; levelData.forEach((lvl, idx) => { lvl.level = idx + 1; lvl.stage = Math.floor(idx / 10) + 1; });
                        localStorage.setItem(CUSTOM_LEVEL_DATA_KEY, JSON.stringify(levelData)); resetGameProgress(); 
                        levelUpdateStatus.textContent = `OK: ${parsedLevels.length} level.`; levelUpdateStatus.classList.add('text-emerald-400');
                    } else { throw new Error("Data invalid."); }
                } catch (error) { levelUpdateStatus.textContent = `Gagal.`; }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function showConfirm(message, callback, title = 'Konfirmasi') {
            if (!confirmModal) return; confirmTitle.textContent = title; confirmMessage.textContent = message; onConfirmCallback = callback; confirmModal.classList.remove('hidden'); 
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== ''); const levels = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(','); if (cols.length < 10) continue; 
                const rawWords = cols.slice(0, 10).map(w => w.trim()).filter(w => w !== ''); if (rawWords.length === 0) continue;
                const words = []; const bonusWords = new Array(rawWords.length).fill(false);
                rawWords.forEach((rawWord, index) => { if (rawWord.toUpperCase() === 'BACA CLUE') return; if (rawWord.includes('[*]')) { words.push(rawWord.replace(/\[\*\]/g, '').trim()); bonusWords[words.length - 1] = true; } else { words.push(rawWord); } });
                if (words.length === 0) continue;
                let clues = new Array(words.length).fill(''); for (let j = 1; j < words.length; j++) { const clueColIndex = 11 + j; if (cols[clueColIndex]) { let clue = cols[clueColIndex].trim(); if (clue && !clue.match(/\.(jpg|jpeg|png|gif)$/i)) clues[j] = clue; } }
                let difficulty = 'Medium'; for (let k = cols.length - 1; k >= 0; k--) { if (cols[k] && cols[k].trim() !== '') { difficulty = cols[k].trim(); break; } }
                levels.push({ difficulty, words, clues, openSlots: [0, words.length > 1 ? words.length - 1 : 0], bonusWords: bonusWords.slice(0, words.length) });
            }
            return levels;
        }

        // ... (Fungsi populate UI & update home sama) ...
        function populateStageSelect() {
            if (!stageSelect || !levelData || levelData.length === 0) return;
            const maxStage = levelData[levelData.length - 1].stage || 1; stageSelect.innerHTML = '';
            for (let i = 1; i <= maxStage; i++) { const option = document.createElement('option'); option.value = i; option.textContent = `Stage ${i}`; stageSelect.appendChild(option); }
            stageSelect.value = levelData[gameState.currentLevelIndex]?.stage || 1; stageSelect.disabled = false;
        }

        function populateLevelSelect() {
            if (!levelSelect) return; levelSelect.innerHTML = '';
            if (!levelData || levelData.length === 0) { levelSelect.innerHTML = '<option value="0">Kosong</option>'; levelSelect.disabled = true; stageSelect.disabled = true; return; }
            const selectedStage = parseInt(stageSelect.value, 10) || 1;
            const filteredLevels = levelData.map((lvl, idx) => ({...lvl, originalIndex: idx})).filter(lvl => lvl.stage === selectedStage);
            filteredLevels.forEach((level) => { const option = document.createElement('option'); option.value = level.originalIndex; option.textContent = `Lv ${level.level} (${level.words.length} Kata)`; levelSelect.appendChild(option); });
            levelSelect.disabled = false; levelSelect.value = filteredLevels.some(lvl => lvl.originalIndex === gameState.currentLevelIndex) ? gameState.currentLevelIndex : filteredLevels[0]?.originalIndex || 0;
        }

        function updateHomeUI() {
            if (!isAuthenticated) return; 
            if (!levelData || levelData.length === 0) { startGameButton.textContent = 'DATA SOAL KOSONG'; startGameButton.disabled = true; gameStatus.textContent = 'Silakan import CSV atau Update.'; return; }
            if (levelSelect && levelSelect.options.length > 0 && levelSelect.options[0].value === '0') { populateStageSelect(); populateLevelSelect(); if (levelSelect.value) { gameState.currentLevelIndex = parseInt(levelSelect.value, 10); } }
            if (gameState.currentLevelIndex >= levelData.length || gameState.currentLevelIndex < 0) gameState.currentLevelIndex = 0;
            let currentLevel = levelData[gameState.currentLevelIndex];
            if (!currentLevel) { gameState.currentLevelIndex = 0; currentLevel = levelData[0]; }
            if (gameState.isGameActive && gameState.revealedWords.some(w => w !== null)) {
                startGameButton.innerHTML = `<i data-lucide="play-circle" class="w-6 h-6"></i> LANJUT S${currentLevel.stage}-L${currentLevel.level}`; gameStatus.textContent = `Sedang bermain...`;
                if(stageSelect) stageSelect.disabled = true; if(levelSelect) levelSelect.disabled = true; if(endSessionButton) endSessionButton.classList.remove('hidden');
            } else {
                if (stageSelect && currentLevel.stage && parseInt(stageSelect.value) !== currentLevel.stage) { stageSelect.value = currentLevel.stage; populateLevelSelect(); }
                if (levelSelect && parseInt(levelSelect.value) !== gameState.currentLevelIndex) levelSelect.value = gameState.currentLevelIndex;
                
                if (currentConnection) {
                    startGameButton.innerHTML = `<i data-lucide="play" class="w-6 h-6"></i> MULAI GAME`; 
                    gameStatus.textContent = `Siap main di S${currentLevel.stage}-L${currentLevel.level}`;
                } else {
                    startGameButton.innerHTML = `<i data-lucide="test-tube-2" class="w-6 h-6"></i> MULAI (MODE TES)`;
                    gameStatus.textContent = `Mode Offline / Simulasi`;
                }

                if(stageSelect) stageSelect.disabled = false; if(levelSelect) levelSelect.disabled = false; if(endSessionButton) endSessionButton.classList.add('hidden');
            }
            startGameButton.disabled = isReconnecting;
            lucide.createIcons();
        }

        function startOrContinueGame() {
            if (!isAuthenticated) return; if (isProcessingWin) return; 
            if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); 
            let shouldReset = false;
            if (levelSelect && !levelSelect.disabled) { const selectedLevelIndex = parseInt(levelSelect.value, 10); if (selectedLevelIndex !== gameState.currentLevelIndex || !gameState.isGameActive) { gameState.currentLevelIndex = selectedLevelIndex; shouldReset = true; } }
            gameState.isGameActive = true; isProcessingWin = false; loadLevel(gameState.currentLevelIndex, shouldReset);
        }

        function loadLevel(levelIndex, forceReset = false) {
            if (levelIndex >= levelData.length) levelIndex = 0;
            gameState.currentLevelIndex = levelIndex; const level = levelData[levelIndex];
            
            // Matikan scroll leaderboard jika ada
            if (leaderboardScrollId) { cancelAnimationFrame(leaderboardScrollId); leaderboardScrollId = null; }

            if (forceReset || gameState.revealedWords.length !== level.words.length || !gameState.isGameActive) {
                stopWordTimer(); gameState.isLevelComplete = false; isProcessingWin = false; lastProcessedGiftId = null; gameState.currentHints = []; gameState.wordTimerRemaining = WORD_TIMER_DURATION; gameState.isAcceptingGuesses = false; 
                gameState.revealedWords = new Array(level.words.length).fill(null);
                (level.openSlots || [0]).forEach(index => { if (index < level.words.length) gameState.revealedWords[index] = { word: level.words[index], solver: { nickname: 'SISTEM', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } }; });
                gameState.nextSlotToGuess = gameState.revealedWords.findIndex(word => word === null);
                
                readyOverlay.classList.remove('hidden'); let count = 3; countdownNumberEl.textContent = count;
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) { countdownNumberEl.textContent = count; } else {
                        clearInterval(countdownInterval); readyOverlay.classList.add('hidden');
                        if (gameState.isGameActive) { 
                            gameState.isAcceptingGuesses = true; 
                            updateNextSlotToGuess(); 
                            startTauntLoop(); // MULAI TAUNT BUBBLES
                        }
                    }
                }, 1000);
            } else if (gameState.nextSlotToGuess === -1 && !gameState.isLevelComplete) { gameState.isLevelComplete = true; showWinModal(); }
            
            if (simContainer) {
                if (currentConnection) simContainer.classList.add('hidden');
                else simContainer.classList.remove('hidden');
            }

            if (winModal && !gameState.isLevelComplete) winModal.classList.add('hidden');
            showPage('game'); renderGameUI(); saveState();
        }
        
        function updateNextSlotToGuess() {
            if (isProcessingWin || (gameState.isLevelComplete && winModal && !winModal.classList.contains('hidden'))) return;
            const nextIndex = gameState.revealedWords.findIndex(word => word === null); gameState.nextSlotToGuess = nextIndex;
            if (nextIndex === -1 && gameState.isGameActive && !gameState.isLevelComplete) {
                stopWordTimer(); gameState.isLevelComplete = true; isProcessingWin = true; gameState.isAcceptingGuesses = false; 
                setTimeout(() => { if (!gameState.isGameActive) return; stickerOverlay.classList.remove('hidden'); stickerContent.classList.remove('scale-0'); setTimeout(() => { stickerOverlay.classList.add('hidden'); stickerContent.classList.add('scale-0'); showWinModal(); isProcessingWin = false; }, 3000); }, 2000);
            } else if (nextIndex !== -1) { startWordTimer(); }
        }
        function loadNextLevel() { gameState.revealedWords = []; isProcessingWin = false; loadLevel(gameState.currentLevelIndex + 1); }
        function goToHome() { 
            stopWordTimer(); 
            stopTauntLoop(); // STOP TAUNT
            if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden'); showPage('home'); updateHomeUI(); 
        }

        // ... (Functions handleLike, handleGift, dll tetap sama) ...
        function handleLike(data) {
            if (!gameState.isGameActive) return; const { uniqueId, nickname, profilePictureUrl, likeCount } = data;
            if (!gameState.topLikers[uniqueId]) gameState.topLikers[uniqueId] = { totalLikes: 0, nickname, profilePictureUrl };
            gameState.topLikers[uniqueId].totalLikes += likeCount; gameState.topLikers[uniqueId].nickname = nickname; gameState.topLikers[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopLikers(); renderTopLikers();
        }

        function handleGift(data) {
            if (!gameState.isGameActive) return;
            const currentGiftId = data.giftId || data.msg_id || data.id; if (currentGiftId && currentGiftId === lastProcessedGiftId) return; if (currentGiftId) lastProcessedGiftId = currentGiftId;
            const diamonds = data.diamondCount || (data.extendedGiftInfo ? data.extendedGiftInfo.diamond_count : 0) || 1; const giftName = data.giftName || 'Hadiah'; const { uniqueId, nickname, profilePictureUrl } = data;
            if (!gameState.topGifters[uniqueId]) gameState.topGifters[uniqueId] = { totalDiamonds: 0, nickname, profilePictureUrl };
            gameState.topGifters[uniqueId].totalDiamonds += diamonds; gameState.topGifters[uniqueId].nickname = nickname; gameState.topGifters[uniqueId].profilePictureUrl = profilePictureUrl;
            saveTopGifters(); renderTopGifters();
            if (!gameState.leaderboard[uniqueId]) gameState.leaderboard[uniqueId] = { score: 0, coins: 0, nickname: nickname, profilePic: profilePictureUrl };
            gameState.leaderboard[uniqueId].coins = (gameState.leaderboard[uniqueId].coins || 0) + diamonds; gameState.leaderboard[uniqueId].nickname = nickname; gameState.leaderboard[uniqueId].profilePic = profilePictureUrl; saveLeaderboard(); 
            showToast('Gift Received', `+${diamonds} Coin: ${nickname}`, 'correct', profilePictureUrl);
            giftQueue.push({ nickname, profilePictureUrl, giftName, uniqueId }); processGiftQueue();
        }

        function processGiftQueue() {
            if (isGiftOverlayShowing || giftQueue.length === 0) return; isGiftOverlayShowing = true; const giftData = giftQueue.shift();
            giftUserPic.src = giftData.profilePictureUrl; giftUserName.textContent = giftData.nickname; giftNameEl.textContent = giftData.giftName; giftUserFollow.textContent = `@${giftData.uniqueId}`;
            giftOverlay.classList.remove('hidden'); giftCard.classList.remove('scale-50', 'opacity-0');
            setTimeout(() => { confetti({ particleCount: 150, spread: 100, origin: { y: 0.3 }, colors: ['#A855F7', '#EC4899', '#FBBF24'] }); }, 500);
            setTimeout(() => { giftCard.classList.add('scale-50', 'opacity-0'); setTimeout(() => { giftOverlay.classList.add('hidden'); giftCard.classList.remove('scale-50', 'opacity-0'); isGiftOverlayShowing = false; processGiftQueue(); }, 500); }, 4000); 
        }

        function renderTopLikers() {
            if (!topLikersList) return; const sorted = Object.values(gameState.topLikers).sort((a, b) => b.totalLikes - a.totalLikes).slice(0, 10);
            if (sorted.length === 0) { topLikersList.innerHTML = '<span class="text-white/30 text-[10px] italic">Menunggu likes...</span>'; if (likerScrollInterval) clearInterval(likerScrollInterval); likerScrollInterval = null; return; }
            let html = sorted.map((liker, i) => createRankItem(liker, i, 'like')).join(''); html += html; topLikersList.innerHTML = html; 
            likerScrollInterval = startAutoScroll('top-likers-list', likerScrollInterval);
        }
        function renderTopGifters() {
            if (!topGiftersList) return; const sorted = Object.values(gameState.topGifters).sort((a, b) => b.totalDiamonds - a.totalDiamonds).slice(0, 10);
            if (sorted.length === 0) { topGiftersList.innerHTML = '<span class="text-white/30 text-[10px] italic">Menunggu gifts...</span>'; if (gifterScrollInterval) clearInterval(gifterScrollInterval); gifterScrollInterval = null; return; }
            let html = sorted.map((gifter, i) => createRankItem(gifter, i, 'gift')).join(''); html += html; topGiftersList.innerHTML = html;
            gifterScrollInterval = startAutoScroll('top-gifters-list', gifterScrollInterval);
        }
         function createRankItem(user, index, type) {
             const val = type === 'like' ? user.totalLikes : user.totalDiamonds;
             return `<div class="flex items-center gap-1.5 bg-white/5 px-2 py-0.5 rounded-full border border-white/5 shrink-0">
                <span class="text-[10px] font-bold ${index===0?'text-yellow-400':'text-slate-400'}">#${index+1}</span>
                <img src="${user.profilePictureUrl}" class="w-4 h-4 rounded-full" onerror="this.src='https://placehold.co/40x40/FFFFFF/000000?text=?'">
                <span class="text-[10px] truncate max-w-[60px]">${user.nickname}</span>
                <span class="text-[10px] font-bold text-white/70">(${val})</span>
            </div>`;
        }

        function startAutoScroll(elementId, intervalVar) {
            if (intervalVar) clearInterval(intervalVar);
            const el = document.getElementById(elementId); if (!el) return null;
            let pos = 0; const speed = 0.5;
            return setInterval(() => { if (!el.parentElement) return;
                const contentWidth = el.scrollWidth; const viewportWidth = el.parentElement.clientWidth; const singleCopyWidth = contentWidth / 2;
                if (singleCopyWidth > viewportWidth) { pos += speed; if (pos >= singleCopyWidth) { pos = 0; } el.style.transform = `translateX(${-pos}px)`; } 
                else { pos = 0; el.style.transform = `translateX(0px)`; }
            }, 30);
        }
        
        function handleComment(msg) {
            if (disconnectNotification) disconnectNotification.classList.add('hidden'); if (headerReconnectBtn) headerReconnectBtn.classList.add('hidden');
            
            // 1. Normalisasi Komentar User: Huruf Besar & Hapus Semua Spasi
            const comment = msg.comment.trim().toUpperCase().replace(/\s+/g, '');
            
            const isHost = (currentConnection && msg.uniqueId && currentConnection.uniqueId && msg.uniqueId.toLowerCase() === currentConnection.uniqueId.toLowerCase()) || (msg.uniqueId === 'simulator_user_id');
            if (!gameState.isGameActive) return;
            if (gameState.isLevelComplete && comment === '!NEXT') { loadNextLevel(); return; }
            if (comment === '!RESET' && isHost) { loadLevel(gameState.currentLevelIndex, true); return; }
            if (!gameState.isAcceptingGuesses || gameState.isLevelComplete || gameState.nextSlotToGuess === -1) { if (comment !== '!HINT' || !gameState.isGameActive) return; }

            // Ambil kata kunci jawaban yang benar saat ini
            const targetWordRaw = levelData[gameState.currentLevelIndex].words[gameState.nextSlotToGuess];
            
            // 2. Normalisasi Jawaban Benar: Huruf Besar & Hapus Semua Spasi (Agar 'Air Minum' == 'AIRMINUM')
            const targetWord = targetWordRaw.toUpperCase().replace(/\s+/g, '');

            if (comment === '!HINT') {
                const uid = msg.uniqueId; const user = gameState.leaderboard[uid];
                if (!user || (user.coins || 0) < 1) { showToast(msg.nickname, 'Koin kurang!', 'error', msg.profilePictureUrl); return; }
                if (gameState.nextSlotToGuess === -1 || gameState.isLevelComplete) return;
                
                // Gunakan targetWord yang sudah dinormalisasi (UPPERCASE) untuk logika Hint
                const lettersToFind = targetWord.slice(1).split(''); 
                let newHintLetter = null;
                
                for (const letter of lettersToFind) { if (!gameState.currentHints.includes(letter)) { newHintLetter = letter; break; } }
                if (newHintLetter) {
                    user.coins -= 1; gameState.currentHints.push(newHintLetter); saveLeaderboard(); 
                    showToast(msg.nickname, `Buka huruf '${newHintLetter}' (-1 Koin)`, 'hint', msg.profilePictureUrl);
                    renderSingleSlot(gameState.nextSlotToGuess, null);
                } else { showToast(msg.nickname, 'Hint habis!', 'error', msg.profilePictureUrl); }
                return; 
            }

            if (comment === '!SKIP' && isHost) {
                stopWordTimer(); const idx = gameState.nextSlotToGuess; 
                gameState.revealedWords[idx] = { word: targetWordRaw, solver: { nickname: 'HOST SKIP', profilePic: 'https://placehold.co/40x40/94A3B8/FFFFFF?text=S' } };
                showToast('Host', 'Skip Kata!', 'system');
                updateNextSlotToGuess(); saveState(); renderSingleSlot(idx, gameState.revealedWords[idx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
                return;
            }
            
            // 3. Bandingkan Komentar Normalisasi vs Jawaban Normalisasi
            if (comment === targetWord) {
                stopWordTimer(); const isBonus = levelData[gameState.currentLevelIndex].bonusWords[gameState.nextSlotToGuess];
                const points = isBonus ? 20 : 10; 
                showToast(msg.nickname, `BENAR! +${points} Poin`, 'correct', msg.profilePictureUrl);
                if (msg.uniqueId) addScore(msg.uniqueId, msg.nickname || 'Anonim', msg.profilePictureUrl || '', points);
                
                // Simpan targetWordRaw (format asli dari CSV) agar tampilan tetap rapi
                gameState.revealedWords[gameState.nextSlotToGuess] = { word: targetWordRaw, solver: { nickname: msg.nickname || msg.uniqueId, profilePic: msg.profilePictureUrl } };
                
                gameState.currentHints = []; const solvedIdx = gameState.nextSlotToGuess; updateNextSlotToGuess(); saveState();
                renderSingleSlot(solvedIdx, gameState.revealedWords[solvedIdx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
            } else {
                // Cek apakah kata sudah pernah ditebak sebelumnya (untuk menghindari spam toast 'Salah')
                // Normalisasi juga list kata yang sudah terbuka untuk pengecekan
                const revealedNormalized = gameState.revealedWords
                    .filter(d => d)
                    .map(d => d.word.toUpperCase().replace(/\s+/g, ''));

                if (!revealedNormalized.includes(comment)) {
                    showToast(msg.nickname, incorrectPhrases[Math.floor(Math.random()*incorrectPhrases.length)], 'incorrect', msg.profilePictureUrl);
                }
            }
        }

        function renderGameUI() {
            const level = levelData[gameState.currentLevelIndex];
            if (levelTitle) levelTitle.textContent = `Level ${level.level}`; if (stageInfo) stageInfo.textContent = `Stage ${level.stage}`;
            if (wordListContainer) { wordListContainer.innerHTML = ''; level.words.forEach((w, i) => renderSingleSlot(i, gameState.revealedWords[i], true)); }
            renderTopLikers(); renderTopGifters(); lucide.createIcons();
        }
        
        // ... (Render single slot, showWinModal, renderLeaderboard, showToast, dll tetap sama) ...
        function renderSingleSlot(i, data, init = false) {
            const level = levelData[gameState.currentLevelIndex];
            let el = document.getElementById(`slot-${i}`);
            if (!el && init) { el = document.createElement('div'); el.id = `slot-${i}`; wordListContainer.appendChild(el); }
            if (!el) return;
            
            if (data) {
                el.className = "slot-base slot-solved glass-panel p-2.5 rounded-xl flex items-center gap-3 opacity-90 pop-in mb-2"; 
                el.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 font-bold flex items-center justify-center border border-emerald-500/30">${i+1}</div>
                    <div class="flex-grow min-w-0">
                        <div class="font-bold text-lg text-white leading-tight">${data.word}</div>
                        <div class="flex items-center gap-1.5 mt-0.5">
                            <img src="${data.solver.profilePic||'https://placehold.co/40x40/4ADE80/14532D?text=:)'}" class="w-3.5 h-3.5 rounded-full border border-white/20">
                            <span class="text-[10px] text-emerald-300 font-medium truncate">${data.solver.nickname}</span>
                        </div>
                    </div>
                    <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-500"></i>`;
            } else if (i === gameState.nextSlotToGuess) {
                const clue = (level.difficulty||'').toLowerCase()==='sulit'?'':(level.clues[i]||'Tebak!');
                
                // Pastikan word yang diambil untuk display HINT juga uppercase agar cocok dengan huruf hint
                const wordRaw = level.words[i];
                const wordUpper = wordRaw.toUpperCase().replace(/\s+/g, ''); // Ambil versi bersih untuk logika hint
                
                let hintText = wordUpper[0]; 
                if (gameState.currentHints.length > 0) { hintText += [...gameState.currentHints].sort().join(''); }
                
                el.className = "slot-base slot-active-container my-4";
                el.innerHTML = `
                    <div class="glass-panel slot-active bg-gradient-to-r from-amber-500/10 to-orange-500/10 p-4 rounded-2xl relative overflow-hidden">
                        ${level.bonusWords[i] ? '<div class="absolute -top-1 -right-1"><i data-lucide="star" class="w-6 h-6 text-yellow-400 fill-yellow-400 animate-spin-slow"></i></div>' : ''}
                        <div class="flex justify-between items-center mb-1">
                            <span class="bg-amber-500 text-black text-xs font-bold px-2 py-0.5 rounded-md">#${i+1}</span>
                            ${clue ? `<span class="text-[10px] font-bold text-amber-300 uppercase tracking-wider bg-amber-500/10 px-2 py-0.5 rounded border border-amber-500/20">${clue}</span>` : ''}
                        </div>
                        <div class="font-mono text-3xl font-bold text-white tracking-[0.2em] text-center drop-shadow-md">
                            ${hintText}<span class="text-amber-500 blinking-cursor">_</span>
                        </div>
                    </div>`;
                if (init) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
            } else {
                el.className = "slot-base slot-locked p-3 rounded-xl flex items-center gap-3 mb-2";
                el.innerHTML = `
                    <div class="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-slate-500 text-sm font-medium">${i+1}</div>
                    <div class="h-2 w-24 bg-white/5 rounded-full"></div>
                    <div class="h-2 w-12 bg-white/5 rounded-full ml-auto"></div>
                `;
            }
            if (init || !data) lucide.createIcons();
            if (!data && !init) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }

        function showWinModal() { 
            stopTauntLoop(); // STOP TAUNT SAAT MENANG
            if(winModal) { renderLeaderboard(); winModal.classList.remove('hidden'); nextLevelPrompt.classList.toggle('hidden', gameState.currentLevelIndex >= levelData.length - 1); allCompletePrompt.classList.toggle('hidden', gameState.currentLevelIndex < levelData.length - 1); } 
        }
        
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            if (!container) return;

            // Hentikan scroll lama jika ada
            if (leaderboardScrollId) {
                cancelAnimationFrame(leaderboardScrollId);
                leaderboardScrollId = null;
            }

            // FILTER MODIFIED: Hanya ambil user dengan score > 0
            const sorted = Object.values(gameState.leaderboard)
                .filter(p => p.score > 0) // Filter: Gift giver tanpa score tidak dihitung
                .sort((a,b)=>b.score-a.score)
                .slice(0,10);

            // Reset Konten & Style Container
            container.innerHTML = '';
            container.className = "relative h-64 overflow-hidden rounded-xl bg-black/20 border border-white/5 mask-image-vertical"; 

            if (sorted.length === 0) {
                container.innerHTML = '<div class="flex h-full items-center justify-center text-slate-500 text-xs italic">Belum ada skor masuk.</div>';
                return;
            }

            // Wrapper untuk list item agar bisa discroll
            const track = document.createElement('div');
            track.id = 'leaderboard-track';
            track.className = 'absolute top-0 left-0 w-full p-3 space-y-2';
            
            // Helper untuk membuat HTML item ranking
            const createItem = (p, i) => {
                let rankClass = "bg-white/5 border-white/10 text-slate-300";
                let rankIcon = `<span class="font-mono font-bold text-sm w-5 text-center text-slate-500">#${i+1}</span>`;
                let scale = "";

                if (i === 0) {
                    rankClass = "bg-gradient-to-r from-yellow-500/20 to-amber-500/10 border-yellow-500/30 shadow-[0_0_15px_rgba(234,179,8,0.1)]";
                    rankIcon = `<i data-lucide="crown" class="w-5 h-5 text-yellow-400 fill-yellow-400/20"></i>`;
                    scale = "scale-[1.02]";
                } else if (i === 1) {
                    rankClass = "bg-slate-400/10 border-slate-400/20";
                    rankIcon = `<i data-lucide="medal" class="w-5 h-5 text-slate-300"></i>`;
                } else if (i === 2) {
                    rankClass = "bg-orange-700/10 border-orange-700/20";
                    rankIcon = `<i data-lucide="medal" class="w-5 h-5 text-orange-400"></i>`;
                }

                return `
                    <div class="flex items-center gap-3 p-2.5 rounded-xl border ${rankClass} ${scale} backdrop-blur-sm transition-transform">
                        <div class="flex-shrink-0 flex items-center justify-center">
                            ${rankIcon}
                        </div>
                        <div class="relative">
                            <img src="${p.profilePic}" class="w-8 h-8 rounded-full border border-white/10 object-cover" onerror="this.src='https://placehold.co/40x40/334155/FFFFFF?text=?'">
                            ${i===0 ? '<div class="absolute -top-1 -right-1 bg-yellow-500 w-2.5 h-2.5 rounded-full border border-black animate-ping"></div>' : ''}
                        </div>
                        <div class="flex-grow min-w-0 flex flex-col justify-center">
                            <span class="text-xs font-bold text-white truncate leading-tight">${p.nickname}</span>
                            <span class="text-[10px] text-slate-400 leading-tight">Score: <span class="text-white font-mono">${p.score}</span></span>
                        </div>
                        ${p.coins > 0 ? `
                        <div class="flex flex-col items-end shrink-0">
                            <div class="flex items-center gap-1 bg-yellow-500/10 px-1.5 py-0.5 rounded border border-yellow-500/20">
                                <i data-lucide="coins" class="w-3 h-3 text-yellow-400"></i>
                                <span class="text-[10px] font-bold text-yellow-200">${p.coins}</span>
                            </div>
                        </div>` : ''}
                    </div>
                `;
            };

            // Masukkan item ke track
            track.innerHTML = sorted.map((p, i) => createItem(p, i)).join('');
            container.appendChild(track);
            lucide.createIcons();

            // Logika Auto-Scroll Halus
            setTimeout(() => {
                const contentHeight = track.scrollHeight;
                const viewportHeight = container.clientHeight;

                // Hanya scroll jika konten lebih panjang dari container
                if (contentHeight > viewportHeight) {
                    const clone = track.cloneNode(true);
                    clone.style.top = `${contentHeight}px`; 
                    
                    container.innerHTML = '';
                    const wrapper = document.createElement('div');
                    wrapper.className = 'absolute top-0 w-full';
                    wrapper.appendChild(track);
                    wrapper.appendChild(clone);
                    container.appendChild(wrapper);
                    
                    let scrollTop = 0;
                    let isPaused = true;
                    
                    setTimeout(() => { isPaused = false; }, 2000);

                    const scrollSpeed = 0.5;

                    const animate = () => {
                        if (!document.getElementById('leaderboard-container')) {
                            leaderboardScrollId = null;
                            return;
                        }
                        
                        if (!isPaused) {
                            scrollTop += scrollSpeed;
                            if (scrollTop >= contentHeight) {
                                scrollTop = 0;
                            }
                            wrapper.style.transform = `translateY(-${scrollTop}px)`;
                        }
                        leaderboardScrollId = requestAnimationFrame(animate);
                    };
                    
                    leaderboardScrollId = requestAnimationFrame(animate);
                }
            }, 100);
        }

        function showToast(title, msg, type, img) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const t = document.createElement('div');
            let colors = type === 'correct' ? 'border-emerald-500/50 bg-slate-900/90' : type === 'incorrect' ? 'border-red-500/50 bg-slate-900/90' : type === 'hint' ? 'border-amber-500/50 bg-slate-900/90' : 'border-blue-500/50 bg-slate-900/90';
            // Perbaiki logika warna teks agar pesan sistem juga terlihat jelas
            let textColor = type === 'correct' ? 'text-emerald-400' : type === 'incorrect' ? 'text-red-400' : type === 'hint' ? 'text-amber-400' : 'text-blue-400';
            
            t.className = `toast-enter flex items-center gap-3 p-3 rounded-xl border ${colors} backdrop-blur-md shadow-lg mb-2 transition-all duration-300`;
            t.innerHTML = `
                <img src="${img || 'https://placehold.co/40x40/334155/FFFFFF?text=?'}" class="w-8 h-8 rounded-full border border-white/20">
                <div class="min-w-0">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${title}</p>
                    <p class="text-xs font-bold ${textColor}">${msg}</p>
                </div>
            `;
            
            // Masukkan pesan baru di paling atas
            container.prepend(t);

            // LOGIKA BATAS 2 BARIS:
            // Jika lebih dari 2, hapus yang paling bawah (terlama) segera
            while (container.children.length > 2) {
                container.removeChild(container.lastElementChild);
            }

            // Auto remove pesan ini setelah 3 detik (jika belum terhapus oleh limit)
            setTimeout(() => { 
                if (t.parentNode) {
                    t.style.opacity = '0'; 
                    t.style.transform = 'translateX(20px)'; 
                    setTimeout(() => { if (t.parentNode) t.remove(); }, 300); 
                }
            }, 3000);
        }

        function addScore(uid, nick, pic, pts) {
            if (!gameState.leaderboard[uid]) gameState.leaderboard[uid] = { score: 0, coins: 0, nickname: nick, profilePic: pic };
            gameState.leaderboard[uid].score += pts; gameState.leaderboard[uid].nickname = nick; gameState.leaderboard[uid].profilePic = pic; saveLeaderboard();
        }

        function stopWordTimer() { if (gameState.wordTimerInterval) { clearInterval(gameState.wordTimerInterval); gameState.wordTimerInterval = null; } document.getElementById('word-timer-container').style.display = 'none'; }
        function startWordTimer() {
            stopWordTimer(); gameState.wordTimerRemaining = WORD_TIMER_DURATION;
            const timerContainer = document.getElementById('word-timer-container'); const timerDisplay = document.getElementById('word-timer-display');
            timerContainer.style.display = 'flex';
            const updateDisplay = () => {
                const minutes = Math.floor(gameState.wordTimerRemaining / 60); const seconds = gameState.wordTimerRemaining % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timerContainer.className = `flex items-center gap-1.5 font-mono text-sm font-bold px-2 py-0.5 rounded-full mt-1 border transition-colors ${gameState.wordTimerRemaining <= 10 ? 'bg-red-500/20 text-red-400 border-red-500/30 animate-pulse' : 'bg-amber-500/10 text-amber-400 border-amber-500/10'}`;
            };
            updateDisplay();
            gameState.wordTimerInterval = setInterval(() => { gameState.wordTimerRemaining--; updateDisplay(); if (gameState.wordTimerRemaining <= 0) { stopWordTimer(); handleAutoSkip(); } }, 1000);
        }

        function handleAutoSkip() {
            if (!gameState.isGameActive || gameState.nextSlotToGuess === -1 || gameState.isLevelComplete) return;
            const idx = gameState.nextSlotToGuess; const correctWord = levelData[gameState.currentLevelIndex].words[idx];
            gameState.revealedWords[idx] = { word: correctWord, solver: { nickname: 'WAKTU HABIS', profilePic: 'https://placehold.co/40x40/EF4444/FFFFFF?text=X' } };
            showToast('System', `Waktu Habis: ${correctWord}`, 'incorrect');
            gameState.currentHints = []; const solvedIdx = gameState.nextSlotToGuess; updateNextSlotToGuess(); saveState(); renderSingleSlot(solvedIdx, gameState.revealedWords[solvedIdx]); if (gameState.nextSlotToGuess !== -1) renderSingleSlot(gameState.nextSlotToGuess, null);
        }

        async function fetchAndUpdateLevels() {
            githubConfig.OWNER = ghUsernameInput.value.trim() || githubConfig.OWNER; githubConfig.REPO = ghRepoInput.value.trim() || githubConfig.REPO; githubConfig.PATH = ghPathInput.value.trim();
            levelUpdateStatus.textContent = `Menghubungkan GitHub...`; 
            try {
                const res = await fetch(`https://api.github.com/repos/${githubConfig.OWNER}/${githubConfig.REPO}/contents/${githubConfig.PATH}`); if (!res.ok) throw new Error(`Gagal akses: ${res.status}`);
                const files = (await res.json()).filter(f => f.name.toLowerCase().endsWith('.csv') && f.type === 'file').sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
                if (files.length === 0) throw new Error("Tidak ada CSV.");
                levelUpdateStatus.textContent = `Unduh ${files.length} file...`;
                const data = await Promise.all(files.map(f => fetch(f.download_url).then(r => r.ok ? r.text() : Promise.reject(f.name))));
                let allLevels = []; data.forEach(txt => allLevels = allLevels.concat(parseCSV(txt)));
                if (allLevels.length === 0) throw new Error("Data kosong.");
                allLevels.forEach((l,i) => { l.level = i+1; l.stage = Math.floor(i/10)+1; });
                levelData = allLevels; localStorage.setItem(CUSTOM_LEVEL_DATA_KEY, JSON.stringify(levelData)); levelUpdateStatus.textContent = `Sukses (${levelData.length} Level).`; levelUpdateStatus.classList.add('text-emerald-400'); resetGameProgress();
            } catch (e) { levelUpdateStatus.textContent = `Error: ${e.message||e}`; levelUpdateStatus.classList.add('text-red-400'); }
        }

        function resetGameProgress() { localStorage.removeItem(STORAGE_KEY); const lb = gameState.leaderboard||{}, tl = gameState.topLikers||{}, tg = gameState.topGifters||{}; gameState = { currentLevelIndex: 0, isGameActive: false, isLevelComplete: false, revealedWords: [], nextSlotToGuess: -1, leaderboard: lb, topLikers: tl, topGifters: tg, currentHints: [], wordTimerInterval: null, wordTimerRemaining: WORD_TIMER_DURATION }; loadLeaderboard(); loadTopLikers(); loadTopGifters(); updateHomeUI(); }
        function loadLeaderboard() { try { gameState.leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {}; for (const uid in gameState.leaderboard) { if (gameState.leaderboard[uid].coins === undefined) gameState.leaderboard[uid].coins = 0; } } catch { gameState.leaderboard = {}; } }
        function saveLeaderboard() { localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(gameState.leaderboard)); }
        function resetLeaderboard() { gameState.leaderboard = {}; localStorage.removeItem(LEADERBOARD_KEY); renderLeaderboard(); }
        function loadTopLikers() { try { gameState.topLikers = JSON.parse(localStorage.getItem(TOP_LIKERS_KEY)) || {}; } catch { gameState.topLikers = {}; } }
        function saveTopLikers() { localStorage.setItem(TOP_LIKERS_KEY, JSON.stringify(gameState.topLikers)); }
        function resetTopLikers() { gameState.topLikers = {}; localStorage.removeItem(TOP_LIKERS_KEY); renderTopLikers(); }
        function loadTopGifters() { try { gameState.topGifters = JSON.parse(localStorage.getItem(TOP_GIFTERS_KEY)) || {}; } catch { gameState.topGifters = {}; } }
        function saveTopGifters() { localStorage.setItem(TOP_GIFTERS_KEY, JSON.stringify(gameState.topGifters)); }
        function resetTopGifters() { gameState.topGifters = {}; localStorage.removeItem(TOP_GIFTERS_KEY); renderTopGifters(); }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); }
        function loadState() { try { gameState = JSON.parse(localStorage.getItem(STORAGE_KEY)) || gameState; loadLeaderboard(); loadTopLikers(); loadTopGifters(); } catch { resetGameProgress(); } }

        // === FUNGSI TAUNT BUBBLES BARU ===
        function startTauntLoop() {
            stopTauntLoop();
            scheduleNextTaunt();
        }

        function stopTauntLoop() {
            if (tauntTimeout) clearTimeout(tauntTimeout);
            tauntTimeout = null;
            // Hapus semua bubble yg tersisa
            document.querySelectorAll('.taunt-bubble').forEach(el => el.remove());
        }

        function scheduleNextTaunt() {
            // Random interval antara 15 sampai 25 detik (Jauh lebih jarang)
            const nextDelay = Math.floor(Math.random() * 10000) + 15000; 
            
            tauntTimeout = setTimeout(() => {
                spawnTaunt();
                // Jadwalkan taunt berikutnya hanya jika game masih aktif
                if (gameState.isGameActive && !gameState.isLevelComplete) {
                    scheduleNextTaunt();
                }
            }, nextDelay);
        }

        function spawnTaunt() {
            if (!gameState.isGameActive || gameState.isLevelComplete) return;

            const sorted = Object.values(gameState.leaderboard)
                .filter(p => p.score > 0)
                .sort((a,b) => b.score - a.score);
            
            // Butuh minimal 1 player dengan skor > 0
            if (sorted.length === 0) return;
            
            const leader = sorted[0];
            const phrase = tauntPhrases[Math.floor(Math.random() * tauntPhrases.length)];
            
            const el = document.createElement('div');
            
            // Style bubble chat: Glassmorphism Gelap & Ekor Chat
            el.className = 'taunt-bubble flex items-start gap-3 bg-slate-900/80 backdrop-blur-md text-white px-4 py-3 rounded-2xl rounded-tl-none shadow-2xl border border-white/10';
            
            // LOGIKA POSISI BARU: Menghindari Tengah Layar
            // Pilih sisi Kiri (5-20%) atau Kanan (60-80%)
            const isLeft = Math.random() > 0.5;
            const leftPos = isLeft 
                ? Math.floor(Math.random() * 15) + 5   // 5% - 20%
                : Math.floor(Math.random() * 20) + 60; // 60% - 80%

            // Random posisi vertikal (20% - 60%) agar tidak terlalu atas/bawah
            const topPos = Math.floor(Math.random() * 40) + 20; 

            el.style.left = `${leftPos}%`;
            el.style.top = `${topPos}%`;

            el.innerHTML = `
                <img src="${leader.profilePic}" class="w-10 h-10 rounded-full border-2 border-yellow-400 object-cover bg-slate-800" onerror="this.src='https://placehold.co/40x40/FBBF24/FFFFFF?text=1'">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-yellow-400 uppercase tracking-wider mb-0.5">ðŸ‘‘ RANK #1 â€¢ ${leader.nickname}</span>
                    <span class="text-sm font-medium leading-tight text-slate-200">"${phrase}"</span>
                </div>
            `;

            document.body.appendChild(el);
            
            // Hapus element setelah animasi selesai (4 detik sesuai CSS)
            setTimeout(() => { if(el && el.parentNode) el.remove(); }, 4000);
        }
        // ===================================

        init();
    </script>
</body>
</html>